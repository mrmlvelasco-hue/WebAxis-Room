<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>

<body class="p-0 m-0 bg-white" style="font-family: 'Inter', sans-serif; color: #1e293b;">

  <div class="px-3 py-2 bg-light border-bottom d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <span class="badge bg-primary-subtle text-primary border border-primary-subtle me-2 px-2 py-1">
        <i class="bi bi-calendar-event"></i>
      </span>
      <div class="fw-bold text-secondary small text-uppercase tracking-wider">
        Room Availability â€” <span class="text-dark">{{ selected_date }}</span>
      </div>
    </div>
    <div class="small text-muted">
      <span class="me-3"><i class="bi bi-circle-fill text-success small me-1"></i> Available</span>
      <span><i class="bi bi-info-circle me-1"></i> 30m intervals</span>
    </div>
  </div>

  <div class="p-3">
    <div class="cal-grid-wrap shadow-sm border border-2 border-light-subtle">
      <div class="cal-grid-scroll">
        <table class="table table-sm table-hover mb-0 cal-grid-table">
          <thead>
            <tr>
              <th class="cal-col-room">Room</th>
              <th class="cal-col-features">Features</th>
              <th class="cal-col-cap text-center"><i class="bi bi-people me-1"></i>Cap</th>
              {% for t in time_slots %}
                <th class="cal-time-head text-center" data-time="{{ t }}">{{ t }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rooms %}
            <tr data-room-id="{{ r.id }}">
              <td class="cal-col-room">
                <div class="fw-bold text-dark">{{ r.name }}</div>
              </td>
              <td class="cal-col-features text-muted small">
                <div class="text-truncate" style="max-width: 350px;" title="{{ r.features }}">{{ r.features }}</div>
              </td>
              <td class="cal-col-cap text-center fw-medium text-secondary">{{ r.capacity }}</td>
              {% for t in time_slots %}
                <td class="cal-slot-cell" data-slot-index="{{ loop.index0 }}"></td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  /* Functions remain exactly as provided in original script */
  const GRID_START_MIN = 6 * 60, GRID_END_MIN = 20 * 60, SLOT_MINUTES = 30;

  function toMinutes(dtStr){ const d = new Date(dtStr); return d.getHours()*60 + d.getMinutes(); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function clearGrid(){
    document.querySelectorAll(".cal-slot-cell").forEach(td=>{
      td.classList.remove("cal-booked","cal-booked-start","cal-booked-end");
      td.title=""; td.innerHTML="";
    });
  }

  function paintReservation(ev){
    const row = document.querySelector(`tr[data-room-id="${ev.room_id}"]`);
    if(!row) return;

    let s = toMinutes(ev.start), e = toMinutes(ev.end);
    if(e <= s) return;

    s = clamp(s, GRID_START_MIN, GRID_END_MIN);
    e = clamp(e, GRID_START_MIN, GRID_END_MIN);

    const startIdx = Math.floor((s - GRID_START_MIN)/SLOT_MINUTES);
    const endIdx   = Math.ceil((e - GRID_START_MIN)/SLOT_MINUTES);

    for(let i=startIdx; i<endIdx; i++){
      const cell = row.querySelector(`td.cal-slot-cell[data-slot-index="${i}"]`);
      if(!cell) continue;
      cell.classList.add("cal-booked");
      if(i===startIdx){
        cell.classList.add("cal-booked-start");
        cell.title = `${ev.room}\n${ev.status}\n${ev.start} - ${ev.end}\n${ev.remarks||""}`;
      }
      if(i===endIdx-1) cell.classList.add("cal-booked-end");
    }
  }

  async function loadAndPaint(){
    clearGrid();
    const date = "{{ selected_date }}";
    const location = "{{ location_filter }}";
    const room = "{{ room_filter }}";
    const url = `/api/reservations_v2_day?date=${encodeURIComponent(date)}&location=${encodeURIComponent(location)}&room=${encodeURIComponent(room)}`;
    const res = await fetch(url);
    const data = await res.json();
    (data||[]).forEach(paintReservation);
    requestAnimationFrame(() => setTimeout(scrollToFocusTime, 50));
  }

  function scrollToFocusTime(){
      const params = new URLSearchParams(window.location.search);
      const focus = params.get("focus");
      if (!focus) return;

      const scroller = document.querySelector(".cal-grid-scroll");
      if (!scroller) return;

      const th = document.querySelector(`.cal-time-head[data-time="${CSS.escape(focus)}"]`);
      if (!th) return;

      const frozenCells = document.querySelectorAll("thead th.cal-col-room, thead th.cal-col-features, thead th.cal-col-cap");
      let frozenWidth = 0;
      frozenCells.forEach(c => frozenWidth += c.getBoundingClientRect().width);

      const scRect = scroller.getBoundingClientRect();
      const thRect = th.getBoundingClientRect();
      const target = (thRect.left - scRect.left) + scroller.scrollLeft - frozenWidth - 16;

      scroller.scrollLeft = Math.max(0, target);
      th.classList.add("cal-focus-col");
      setTimeout(() => th.classList.remove("cal-focus-col"), 1500);
    }
  document.addEventListener("DOMContentLoaded", loadAndPaint);
</script>

<style>
  /* Advanced Professional Styles */
  :root {
    --booked-bg: #10b981; /* Modern Emerald Green */
    --booked-border: #059669;
    --frozen-bg: #ffffff;
    --header-bg: #f8fafc;
  }

  .cal-grid-wrap { border-radius: 12px; overflow: hidden; background: #fff; }
  .cal-grid-scroll { overflow: auto; max-height: 55vh; position: relative; scroll-behavior: smooth; }

  .cal-grid-table { border-collapse: separate !important; border-spacing: 0 !important; }
  .cal-grid-table th, .cal-grid-table td {
    white-space: nowrap;
    font-size: 13px;
    padding: 12px 14px;
    border-bottom: 1px solid #f1f5f9;
    border-right: 1px solid #f1f5f9;
  }

  /* Sticky Header */
  .cal-grid-table thead th {
    position: sticky;
    top: 0;
    background: var(--header-bg);
    z-index: 10;
    font-weight: 600;
    color: #64748b;
    border-bottom: 2px solid #e2e8f0;
  }

  /* Fixed Columns with better depth */
  .cal-time-head, .cal-slot-cell { min-width: 85px; width: 85px; }
  .cal-col-room, .cal-col-features, .cal-col-cap { position: sticky; background: var(--frozen-bg); z-index: 6; }

  .cal-col-room { left: 0; min-width: 200px; width: 200px; z-index: 8; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05); }
  .cal-col-features { left: 200px; min-width: 300px; width: 300px; z-index: 7; }
  .cal-col-cap { left: 500px; min-width: 80px; width: 80px; z-index: 7; border-right: 2px solid #cbd5e1; }

  /* Ensure Header Sticky parts stay on top */
  .cal-grid-table thead th.cal-col-room,
  .cal-grid-table thead th.cal-col-features,
  .cal-grid-table thead th.cal-col-cap { z-index: 20; background: var(--header-bg); }

  /* Modern Booked Slot Styles */
  .cal-slot-cell.cal-booked {
    background: var(--booked-bg);
    color: white;
    border-top: 4px solid white;
    border-bottom: 4px solid white;
    border-right-color: transparent;
    border-left-color: transparent;
  }

  .cal-slot-cell.cal-booked-start {
    border-left: 2px solid var(--booked-border) !important;
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
  }

  .cal-slot-cell.cal-booked-end {
    border-right: 2px solid var(--booked-border) !important;
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  /* Focus Column Highlight */
  .cal-focus-col {
    background: #e0f2fe !important;
    box-shadow: inset 0 0 0 2px #0ea5e9;
    color: #0369a1 !important;
    transition: all 0.5s ease;
  }

  /* Custom Professional Scrollbar */
  .cal-grid-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
  .cal-grid-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
  .cal-grid-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  .cal-grid-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>

</body>
</html>