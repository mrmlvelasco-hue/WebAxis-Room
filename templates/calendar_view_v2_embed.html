<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="p-0 m-0 bg-white" style="font-family: 'Inter', sans-serif; color: #1e293b;">

  <div class="px-3 py-2 bg-light border-bottom d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <span class="badge bg-primary-subtle text-primary border border-primary-subtle me-2 px-2 py-1">
        <i class="bi bi-calendar-event"></i>
      </span>
      <div class="fw-bold text-secondary small text-uppercase tracking-wider">
        Room Availability — <span class="text-dark">{{ selected_date }}</span>
      </div>
    </div>
    <div class="small text-muted">
      <span class="me-3"><i class="bi bi-circle-fill text-success small me-1"></i> Available</span>
      <span><i class="bi bi-info-circle me-1"></i> 30m intervals</span>
    </div>
  </div>

  <div class="p-3">
    <div class="cal-grid-wrap shadow-sm border border-2 border-light-subtle">
      <div class="cal-grid-scroll" >
        <table class="table table-sm table-hover mb-0 cal-grid-table">
          <thead>
            <tr>
              <th class="cal-col-room">Room</th>
              <th class="cal-col-features">Features</th>
              <th class="cal-col-cap text-center"><i class="bi bi-people me-1"></i>Cap</th>
              {% for t in time_slots %}
                <th class="cal-time-head text-center" data-time="{{ t }}">{{ t }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rooms %}
            <tr data-room-id="{{ r.id }}">
              <td class="cal-col-room">
                <div class="fw-bold text-dark">{{ r.name }}</div>
              </td>
              <td class="cal-col-features text-muted small">
                <div class="text-truncate" style="max-width: 350px;" title="{{ r.features }}">{{ r.features }}</div>
              </td>
              <td class="cal-col-cap text-center fw-medium text-secondary">{{ r.capacity }}</td>
              {% for t in time_slots %}
                <td class="cal-slot-cell" data-slot-index="{{ loop.index0 }}"></td>

              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>

/* =========================================================
   CALENDAR V2 – PRO VERSION
   ✔ Solid coloring
   ✔ Perfect click detection
   ✔ No duplicate listeners
   ✔ No extra API calls
   ✔ Instant popup
========================================================= */

const GRID_START_MIN = 6 * 60;
const GRID_END_MIN   = 20 * 60;
const SLOT_MINUTES   = 30;

/* =============================
   In-memory reservation map
============================= */
let reservationMap = {};
// key format: roomId_slotMin → reservation object

/* =============================
   Helpers
============================= */
const CURRENT_USER = {
    name: "{{ current_user.display_name }}",
    username: "{{ current_user.username }}",
    isAdmin: {{ 'true' if current_user.is_admin() else 'false' }}
};

function toMinutes(dtStr){
    const d = new Date(dtStr);
    return d.getHours()*60 + d.getMinutes();
}

function clamp(v,min,max){
    return Math.max(min, Math.min(max, v));
}

function formatSlotKey(roomId, slotMin){
    return `${roomId}_${slotMin}`;
}

/* =============================
   Clear Grid
============================= */

function clearGrid(){
    reservationMap = {};

    document.querySelectorAll(".cal-slot-cell").forEach(td=>{
        td.classList.remove("cal-booked","cal-booked-start","cal-booked-end");
        td.innerHTML = "";
        td.removeAttribute("data-room-id");
        td.removeAttribute("data-slot-min");
        td.style.backgroundColor = "";
        td.innerHTML = "";
        td.removeAttribute("data-room-id");
        td.removeAttribute("data-slot-min");
    });
}

/* =============================
   Paint Reservations
============================= */

function paintReservation(ev){

    const row = document.querySelector(`tr[data-room-id="${ev.room_id}"]`);
    if(!row) return;

    let startMin = toMinutes(ev.start);
    let endMin   = toMinutes(ev.end);
    if(endMin <= startMin) return;

    startMin = clamp(startMin, GRID_START_MIN, GRID_END_MIN);
    endMin   = clamp(endMin, GRID_START_MIN, GRID_END_MIN);

    const startIdx = Math.floor((startMin - GRID_START_MIN)/SLOT_MINUTES);
    const endIdx   = Math.ceil((endMin - GRID_START_MIN)/SLOT_MINUTES);

    for(let i=startIdx;i<endIdx;i++){

        const cell = row.querySelector(`td.cal-slot-cell[data-slot-index="${i}"]`);
        if(!cell) continue;

        const slotMin = GRID_START_MIN + (i * SLOT_MINUTES);

        cell.classList.add("cal-booked");
        cell.dataset.roomId = ev.room_id;
        cell.dataset.slotMin = slotMin;

        /* ----- Color by status ----- */
        const status = (ev.status || "").toLowerCase();
        console.log("Painting:", ev.room_id, slotMin);
<!--        if(status === "approved" || status === "booked"){-->
<!--            cell.style.backgroundColor = "#d4edda";-->
<!--        }-->
<!--        else if(status === "pending"){-->
<!--            cell.style.backgroundColor = "#fff3cd";-->
<!--        }-->
<!--        else if(status === "blocked"){-->
<!--            cell.style.backgroundColor = "#f8d7da";-->
<!--        }-->

        /* ----- Store reservation in map ----- */
        reservationMap[formatSlotKey(ev.room_id, slotMin)] = ev;

        /* ----- Show remarks only on first cell ----- */
        if(i === startIdx){
            const div = document.createElement("div");
            div.className = "cal-remarks";
            div.textContent = ev.remarks || "";
            cell.appendChild(div);
        }
    }
}

/* =============================
   Global Click Handler
============================= */

document.addEventListener("click", function(e){

    const cell = e.target.closest(".cal-slot-cell");
    if (!cell) return;

    const row = cell.closest("tr");
    if (!row) return;

    const roomId = row.dataset.roomId;
    const slotIndex = parseInt(cell.dataset.slotIndex);

    if (!roomId || isNaN(slotIndex)) return;

    const slotMin = GRID_START_MIN + (slotIndex * SLOT_MINUTES);

    const key = `${roomId}_${slotMin}`;
    const reservation = reservationMap[key];
    console.log("roomId:", roomId);
    console.log("slotMin:", slotMin);
    console.log("isNaN:", isNaN(slotMin));

    // Booked slot
    if (reservation) {
        window.parent.postMessage({
            type: "SHOW_RESERVATION",
            data: reservation
        }, "*");
        return;
    }

    // Empty slot
    window.parent.postMessage({
        type: "OPEN_NEW_RESERVATION",
        room_id: roomId,
        slot_min: slotMin
    }, "*");

});

/* =============================
   Popup
============================= */

function showReservationDetails(res){

    const status = (res.status || "").toLowerCase();

    const statusMap = {
        approved: { text: "APPROVED", bg: "#d1fae5", color: "#065f46" },
        pending:  { text: "PENDING",  bg: "#fef3c7", color: "#92400e" },
        blocked:  { text: "BLOCKED",  bg: "#fee2e2", color: "#991b1b" },
        booked:   { text: "BOOKED",   bg: "#d1fae5", color: "#065f46" }
    };

    const badge = statusMap[status] || {
        text: status.toUpperCase(),
        bg: "#e5e7eb",
        color: "#374151"
    };

    Swal.fire({
        target: document.body,
        backdrop: true,
        width: 600,
        showConfirmButton: false,
        showCloseButton: true,
        padding: "2rem",
        html: `
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:28px;color:#0d47a1;">
                <i class="bi bi-calendar-check"></i>
            </div>
            <h3 style="margin-top:8px;font-weight:700;color:#0d47a1;">
                Reservation Details
            </h3>
        </div>

        <div style="text-align:left;font-size:15px;">

            ${detailRow("Room:", `<strong style="color:#0d47a1">${res.room}</strong>`)}
            ${divider()}

            ${detailRow("Status:",
                `<span style="
                    display:inline-block;
                    padding:6px 14px;
                    border-radius:20px;
                    background:${badge.bg};
                    color:${badge.color};
                    font-weight:600;
                    font-size:13px;
                ">${badge.text}</span>`
            )}
            ${divider()}

            ${detailRow("Reserved By:", res.reserved_by)}
            ${divider()}

            ${detailRow("Email:", res.email || "-")}
            ${divider()}

            ${detailRow("Time:",
                `<span style="color:#0d47a1;font-weight:600;">
                    ${res.start} — ${res.end}
                </span>`
            )}
            ${divider()}

            ${detailRow("Meeting Title:", res.remarks || "—")}

        </div>

        <div style="margin-top:30px;text-align:center;">
            <button id="cancelBtn"
                style="
                    background:#dc2626;
                    color:white;
                    border:none;
                    padding:12px 28px;
                    border-radius:8px;
                    font-weight:600;
                    box-shadow:0 4px 12px rgba(220,38,38,0.3);
                    cursor:pointer;
                ">
                <i class="bi bi-trash"></i>
                Cancel Reservation
            </button>
        </div>
        `,
        didOpen: () => {

            const btn = document.getElementById("cancelBtn");
            if(!btn) return;

            btn.addEventListener("click", async () => {

                const confirm = await Swal.fire({
                    title: "Confirm Cancellation?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#dc2626",
                    confirmButtonText: "Yes, Cancel"
                });

                if(!confirm.isConfirmed) return;

                const r = await fetch(`/api/cancel_reservation/${res.id}`, {
                    method: "POST"
                });

                const d = await r.json();

                if(d.success){
                    Swal.fire("Cancelled!", "", "success")
                        .then(()=> location.reload());
                }else{
                    Swal.fire("Error", d.message || "Cannot cancel", "error");
                }
            });
        }
    });

    function detailRow(label, value){
        return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
            <div style="color:#6b7280;width:140px;">${label}</div>
            <div style="flex:1;text-align:left;">${value}</div>
        </div>`;
    }

    function divider(){
        return `<div style="border-bottom:1px solid #e5e7eb;"></div>`;
    }
}

/* =============================
   Load Data
============================= */

async function loadAndPaint(){

    clearGrid();

    const date = "{{ selected_date }}";
    const location = "{{ location_filter }}";
    const room = "{{ room_filter }}";

    const url =
        `/api/reservations_v2_day?date=${encodeURIComponent(date)}`
        + `&location=${encodeURIComponent(location)}`
        + `&room=${encodeURIComponent(room)}`;



    const res = await fetch(url);
    const data = await res.json();

    (data||[]).forEach(paintReservation);
}

document.addEventListener("DOMContentLoaded", loadAndPaint);

</script>

<style>
  /* Advanced Professional Styles */
  :root {
    --booked-bg: #10b981; /* Modern Emerald Green */
    --booked-border: #059669;
    --frozen-bg: #ffffff;
    --header-bg: #f8fafc;
  }

  .cal-grid-wrap {border-radius: 12px;overflow: hidden;background: #fff;width: 100%;
   /* Height computed from viewport: adjust the 64px + 24px to match your header & paddings */
  height: calc(100vh - 64px - 24px);display: flex;flex-direction: column;}
  .cal-grid-scroll {
overflow: auto;
  /* Remove max-height; let the parent define height */
  /* max-height: 55vh;  <-- remove this */
  flex: 1 1 auto;
  position: relative;
  scroll-behavior: smooth;
}

  .cal-grid-table { border-collapse: separate !important; border-spacing: 0 !important; }
  .cal-grid-table th, .cal-grid-table td {
    white-space: nowrap;
    font-size: 13px;
    padding: 12px 14px;
    border-bottom: 1px solid #f1f5f9;
    border-right: 1px solid #f1f5f9;
  }

  /* Sticky Header */
  .cal-grid-table thead th {
    position: sticky;
    top: 0;
    background: var(--header-bg);
    z-index: 10;
    font-weight: 600;
    color: #64748b;
    border-bottom: 2px solid #e2e8f0;
  }

  /* Fixed Columns with better depth */
  .cal-time-head, .cal-slot-cell { min-width: 85px; width: 85px; }
  .cal-col-room, .cal-col-features, .cal-col-cap { position: sticky; background: var(--frozen-bg); z-index: 6; }

  .cal-col-room { left: 0; min-width: 200px; width: 200px; z-index: 8; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05); }
  .cal-col-features { left: 200px; min-width: 300px; width: 300px; z-index: 7; }
  .cal-col-cap { left: 500px; min-width: 80px; width: 80px; z-index: 7; border-right: 2px solid #cbd5e1; }

  /* Ensure Header Sticky parts stay on top */
  .cal-grid-table thead th.cal-col-room,
  .cal-grid-table thead th.cal-col-features,
  .cal-grid-table thead th.cal-col-cap { z-index: 20; background: var(--header-bg); }

  /* Modern Booked Slot Styles */
  .cal-slot-cell.cal-booked {
  background: var(--booked-bg);
  color: white;
   box-shadow: inset 0 0 0 2px white;
   transition: all 0.2s ease;
}
.cal-slot-cell.cal-booked {
  transition: all 0.2s ease;
}

.cal-slot-cell.cal-booked:hover {
  filter: brightness(1.1);
  transform: scale(1.02);

}
  .cal-slot-cell.cal-booked-start {
  border-left: 2px solid var(--booked-border) !important;
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
}

.cal-slot-cell.cal-booked-end {
  border-right: 2px solid var(--booked-border) !important;
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
}

  /* Focus Column Highlight */
  .cal-focus-col {
    background: #e0f2fe !important;
    box-shadow: inset 0 0 0 2px #0ea5e9;
    color: #0369a1 !important;
    transition: all 0.5s ease;
  }

  /* Custom Professional Scrollbar */
  .cal-grid-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
  .cal-grid-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
  .cal-grid-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  .cal-grid-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    td.cal-slot-cell {
  position: relative;
}



/* Truncate long remarks nicely */
td.cal-slot-cell.cal-booked-start {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 12px;
}
    .cal-remarks {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;

  text-align: center;
  padding: 0 4px;

  /* limit based on cell size */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  font-size: 12px;
}
    .clickable-slot {
    cursor: pointer;
}

.clickable-slot:hover {
    background-color: #dbe7ff; /* light highlight */
}
    .cal-slot-cell {
    cursor: pointer;
}

.cal-slot-cell {
    position: relative;
    z-index: 1;
}
    .cal-slot-cell.status-approved {
  background: #10b981;
  color: white;
}

.cal-slot-cell.status-pending {
  background: #f59e0b;
  color: white;
}

.cal-slot-cell.status-blocked {
  background: #ef4444;
  color: white;
}
</style>

</body>
</html>