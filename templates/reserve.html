{% extends "base_dashboard.html" %}
{% block title %}Reserve Room | WebAXIS{% endblock %}

{% block content %}
<div class="d-flex flex-wrap">
  <!-- ðŸ”¹ Left Sidebar (Resources & Status) -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-primary text-white fw-semibold">
    <i class="bi bi-building"></i> Shared Rooms by Location
  </div>

  <div class="accordion accordion-flush" id="accordionBuildings">
    {% for parent, groups in room_hierarchy.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
          <button class="accordion-button collapsed fw-semibold" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                  aria-expanded="false" aria-controls="collapse{{ loop.index }}">
            {{ parent }}
          </button>
        </h2>

        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse"
             aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionBuildings">
          <div class="accordion-body p-0">
            {% for group_name, group_rooms in groups.items() %}
              <div class="ps-3 py-2 fw-semibold text-primary small">{{ group_name }}</div>
              <ul class="list-group list-group-flush">
                {% for r in group_rooms %}
                <li class="list-group-item py-1 px-3">
                  <a href="{{ url_for('reserve', room_id=r.id) }}"
                     class="d-flex justify-content-between text-decoration-none small">
                    <span>{{ r.name }}</span>
                    {% if r.id == room.id %}
                      <i class="bi bi-check-circle-fill text-success"></i>
                    {% endif %}
                  </a>
                </li>
                {% endfor %}
              </ul>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>




  <!-- ðŸ”¹ Main Reservation Content -->
  <div class="col-12 col-md-9">
    <div class="card shadow-sm p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold page-title mb-0">
          <i class="bi bi-calendar2-week"></i> Reserve a Room
        </h2>
        <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary fw-semibold">
          <i class="bi bi-arrow-left"></i> Back to Rooms
        </a>
      </div>

      <!-- Room Details -->
      <div class="card border-0 bg-light p-3 mb-4">
        <h5 class="fw-semibold mb-2"><i class="bi bi-info-circle"></i> Room Details</h5>
        {% if room %}
          <p><strong>Room:</strong> {{ room.name or room[1] }}</p>
          <p><strong>Capacity:</strong> {{ room.capacity or room[2] }} pax</p>
          <p><strong>Location:</strong> {{ room.location or room[3] }}</p>
          <p><strong>Description:</strong> {{ room.description or room[4] or '-' }}</p>
        {% else %}
          <div class="text-muted">Room details not available.</div>
        {% endif %}
      </div>

      <!-- Reservation Form -->
      <form method="POST" action="{{ url_for('reserve', room_id=room.id if room else room[0]) }}" id="reserveForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Reserved By</label>
            <input type="text" name="reserved_by" class="form-control" value="{{ current_user.username }}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ current_user.email or '' }}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Start Time</label>
            <input type="datetime-local" name="start_time" class="form-control" id="start_time" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">End Time</label>
            <input type="datetime-local" name="end_time" class="form-control" id="end_time" required>
          </div>
          <div class="col-md-12">
            <label class="form-label fw-semibold">Remarks / Purpose</label>
            <textarea name="remarks" class="form-control" rows="3" placeholder="Enter purpose..."></textarea>
          </div>
        </div>
        <div id="slot-msg" class="small mt-3"></div>
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary px-4 fw-semibold">
            <i class="bi bi-check2-square"></i> Submit Reservation
          </button>
        </div>
      </form>
    </div>

    <!-- Room Schedule Timeline -->
    <div class="card shadow-sm p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-semibold mb-0"><i class="bi bi-clock-history"></i> Room Schedule for Selected Date</h5>
        <div>
          <button id="prev-day" class="btn btn-sm btn-outline-primary me-2"><i class="bi bi-arrow-left"></i> Previous</button>
          <input type="date" id="timeline-date" class="form-control d-inline-block" style="width:160px;">
          <button id="next-day" class="btn btn-sm btn-outline-primary ms-2">Next <i class="bi bi-arrow-right"></i></button>
        </div>
      </div>
      <div id="timeline-grid" class="bg-light border rounded p-3" style="overflow-x:auto; white-space:nowrap; min-height:60px;">
        <div class="text-muted small">Loading schedule...</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const datePicker = document.getElementById('timeline-date');
  const gridEl = document.getElementById('timeline-grid');
  const prevBtn = document.getElementById('prev-day');
  const nextBtn = document.getElementById('next-day');
  const roomId = {{ room.id if room else room[0] }};
  const today = new Date().toISOString().split('T')[0];
  datePicker.value = today;

  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }

  function shiftDate(days) {
    const d = new Date(datePicker.value);
    d.setDate(d.getDate() + days);
    datePicker.value = formatDate(d);
    loadTimeline();
  }

  prevBtn.addEventListener('click', () => shiftDate(-1));
  nextBtn.addEventListener('click', () => shiftDate(1));
  datePicker.addEventListener('change', loadTimeline);

  async function loadTimeline() {
    const date = datePicker.value;
    gridEl.innerHTML = '<div class="text-muted small">Loading schedule...</div>';
    try {
      const res = await fetch(`/api/booked_slots?room_id=${roomId}&date=${date}`);
      const data = await res.json();
      gridEl.innerHTML = renderTimeline(data.slots || []);
    } catch {
      gridEl.innerHTML = '<div class="text-danger small">Error loading schedule.</div>';
    }
  }

  function renderTimeline(slots) {
    const hours = Array.from({length:13}, (_,i)=>i+8);
    let html = '<div style="display:flex;align-items:center;">';
    html += '<div style="width:70px;"></div>';
    hours.forEach(h=>html += `<div style="width:70px;text-align:center;">${h}:00</div>`);
    html += '</div>';
    html += '<div style="position:relative;height:40px;background:#f8f9fa;border-radius:8px;margin-top:8px;">';

    if (slots.length === 0)
      return '<div class="text-muted small">No bookings on this date.</div>';

    slots.forEach(slot=>{
      const [sh, sm] = slot.start_time.split(':').map(Number);
      const [eh, em] = slot.end_time.split(':').map(Number);
      const left = ((sh-8)*60 + sm)/60*70;
      const width = ((eh*60 + em)-(sh*60 + sm))/60*70;
      const color = slot.status === 'Approved' ? '#198754' : '#ffc107';
      html += `<div style="position:absolute;left:${left}px;width:${width}px;height:36px;top:2px;
               background:${color};border-radius:6px;color:#fff;font-size:0.75rem;text-align:center;
               line-height:36px;overflow:hidden;">${slot.reserved_by} (${slot.start_time}-${slot.end_time})</div>`;
    });
    html += '</div>';
    return html;
  }

  loadTimeline();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const STORAGE_KEY = "lastBuildingOpen";
  const currentParent = "{{ room.parent_group }}".trim();

  const lastOpen = localStorage.getItem(STORAGE_KEY);
  const accordion = document.getElementById("accordionBuildings");

  // Auto-open saved group, else open current roomâ€™s parent
  let toOpen = lastOpen || null;
  if (!toOpen && currentParent) {
    const header = Array.from(document.querySelectorAll('.accordion-button'))
      .find(btn => btn.textContent.trim() === currentParent);
    if (header) {
      const collapseId = header.getAttribute('data-bs-target');
      toOpen = collapseId.substring(1);
    }
  }

  if (toOpen) {
    const el = document.getElementById(toOpen);
    if (el) new bootstrap.Collapse(el, { toggle: true });
  }

  // Save opened state
  accordion.addEventListener('shown.bs.collapse', e => {
    localStorage.setItem(STORAGE_KEY, e.target.id);
  });

  // Clear saved if collapsed manually
  accordion.addEventListener('hidden.bs.collapse', e => {
    const last = localStorage.getItem(STORAGE_KEY);
    if (last === e.target.id) localStorage.removeItem(STORAGE_KEY);
  });
});
</script>


{% endblock %}
