{% extends "base_dashboard.html" %}
{% block title %}Reserve Room | WebAXIS{% endblock %}

{% block content %}
<div class="card shadow-sm p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0 text-primary"><i class="bi bi-calendar-plus"></i> Reserve — {{ room.name }}</h3>
    <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Rooms
    </a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ 'success' if category=='success' else 'warning' if category=='warning' else 'danger' }} fw-semibold">
          {{ msg }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Simplified clean reservation form (no recurrence) -->
  <form id="reserveForm" method="POST" action="{{ url_for('reserve', room_id=room.id) }}">
    <div class="row g-3">

      <!-- Left column: personal & remarks -->
      <div class="col-lg-6">
        <div class="card p-3 mb-3" style="border:1px solid #e6eefc; border-radius:10px;">
          <h5 class="fw-semibold mb-3 text-primary">Your details</h5>

          <label class="form-label fw-semibold">Reserved by</label>
          <input required name="reserved_by" id="reserved_by" class="form-control form-control-lg mb-3" value="{{ current_user.display_name or current_user.username }}">

          <label class="form-label fw-semibold">Email</label>
          <input required name="email" id="email" type="email" class="form-control form-control-lg mb-3" value="{{ current_user.email or '' }}">

          <label class="form-label fw-semibold">Meeting Title <span class="text-muted small">(optional)</span></label>
          <textarea name="remarks" id="remarks" class="form-control" rows="3">{{ request.form.remarks or '' }}</textarea>
        </div>
      </div>

      <!-- Right column: schedule -->
      <div class="col-lg-6">
        <div class="card p-3 mb-3" style="border:1px solid #e6eefc; border-radius:10px;">
          <h5 class="fw-semibold mb-3 text-primary">Schedule</h5>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Start</label>
              <input required name="start_time" id="start_time" type="datetime-local" class="form-control form-control-lg" value="{{ request.form.start_time or '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">End</label>
              <input required name="end_time" id="end_time" type="datetime-local" class="form-control form-control-lg" value="{{ request.form.end_time or '' }}">
            </div>

            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="small text-muted" id="durationText">Duration: —</div>
                <div>
                  <span id="availabilityBadge" class="badge bg-secondary">Checking…</span>
                </div>
              </div>
              <div id="timeError" class="text-danger small mt-2" style="display:none;">End time must be later than start time.</div>
            </div>

            <div class="col-12 mt-3 text-end">
              <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                <i class="bi bi-check2-circle"></i> Submit Reservation
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
// Simple client-side helpers: validate times and show duration
(function(){
  function parseLocal(dtStr){
    return dtStr ? new Date(dtStr) : null;
  }

  function formatDuration(ms){
    if (!ms || ms <= 0) return '—';
    const mins = Math.round(ms/60000);
    const h = Math.floor(mins/60);
    const m = mins % 60;
    return (h ? h + 'h ' : '') + (m ? m + 'm' : '');
  }

  const startEl = document.getElementById('start_time');
  const endEl = document.getElementById('end_time');
  const durationText = document.getElementById('durationText');
  const availBadge = document.getElementById('availabilityBadge');
  const timeError = document.getElementById('timeError');

  function checkTimes(){
    const s = parseLocal(startEl.value);
    const e = parseLocal(endEl.value);
    if (!s || !e){
      durationText.textContent = 'Duration: —';
      availBadge.className = 'badge bg-secondary';
      availBadge.textContent = '—';
      timeError.style.display = 'none';
      return;
    }

    const diff = e - s;
    if (diff <= 0){
      timeError.style.display = 'block';
      durationText.textContent = 'Duration: —';
      availBadge.className = 'badge bg-danger text-white';
      availBadge.textContent = 'Invalid';
      return;
    }

    timeError.style.display = 'none';
    durationText.textContent = 'Duration: ' + formatDuration(diff);

    // Simple availability heuristic (client demo): if start hour is on the hour 13 or 10 => show booked
    const sh = s.getHours();
    if (sh === 13 || sh === 10){
      availBadge.className = 'badge bg-danger text-white';
      availBadge.textContent = 'Booked';
    } else {
      availBadge.className = 'badge bg-success text-white';
      availBadge.textContent = 'Available';
    }
  }

  if (startEl) startEl.addEventListener('change', checkTimes);
  if (endEl) endEl.addEventListener('change', checkTimes);
  // initial run
  checkTimes();

  // Optional: auto-fill nearest 30-min slot if fields empty
  function roundUpHalfHour(d){
    d.setSeconds(0,0);
    const m = d.getMinutes();
    if (m === 0) d.setMinutes(30);
    else if (m <= 30) d.setMinutes(30);
    else { d.setMinutes(0); d.setHours(d.getHours()+1); }
    return d;
  }

  try{
    if (startEl && !startEl.value){
      const s = roundUpHalfHour(new Date());
      const e = new Date(s.getTime() + 30*60000);
      startEl.value = s.toISOString().slice(0,16);
      endEl.value = e.toISOString().slice(0,16);
      checkTimes();
    }
  }catch(e){console.warn(e)}
})();
</script>
{% endblock %}
