{% extends "base_dashboard.html" %}
{% block title %}Reserve Room | WebAXIS{% endblock %}

{% block content %}
<div class="card shadow-sm p-4 mb-4">
  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h2 class="fw-bold page-title mb-2 mb-md-0">
      <i class="bi bi-calendar-plus"></i> Room Reservation
    </h2>

    <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary fw-semibold back-btn">
      <i class="bi bi-arrow-left"></i> Back to Rooms
    </a>
  </div>

  <!-- Room Details -->
  <div class="card p-4 border-0 mb-4 reservation-room-card">
    <h5 class="fw-semibold mb-3 text-primary">
      <i class="bi bi-door-open"></i> {{ room[1] }}
    </h5>
    <ul class="list-unstyled mb-0">
      <li><strong>Location:</strong> {{ room[3] }}</li>
      <li><strong>Capacity:</strong> {{ room[2] }}</li>
      <li><strong>Description:</strong> {{ room[4] }}</li>
    </ul>
  </div>

  <!-- Reservation Form -->
  <div class="card p-4 border-0 reservation-form-card">
    <h5 class="fw-semibold mb-3"><i class="bi bi-pencil-square"></i> Fill Reservation Details</h5>

    <form method="POST" action="{{ url_for('reserve', room_id=room[0]) }}">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Reserved By</label>
          <input type="text" name="reserved_by" class="form-control" placeholder="Your full name" required>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Email</label>
          <input type="email" name="email" class="form-control" placeholder="Your email address" required>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Start Time</label>
           <input type="datetime-local" id="start_time" name="start_time" class="form-control"
           required min="{{ datetime.utcnow().strftime('%Y-%m-%dT%H:%M') }}">
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">End Time</label>
          <input type="datetime-local" id="end_time" name="end_time" class="form-control"
           required min="{{ datetime.utcnow().strftime('%Y-%m-%dT%H:%M') }}">
        </div>

        <div class="col-12">
          <label class="form-label fw-semibold">Remarks</label>
          <textarea name="remarks" rows="3" class="form-control" placeholder="Purpose or notes..."></textarea>
        </div>
      </div>

      <div class="text-end mt-4">
        <button type="submit" class="btn btn-primary px-4 fw-semibold">
          <i class="bi bi-send-fill"></i> Submit Reservation
        </button>
      </div>
    </form>
  </div>
</div>
<hr class="my-4">
<h5 class="fw-semibold mb-3 text-primary"><i class="bi bi-clock-history"></i> Existing Bookings</h5>

{% if booked_slots %}
  <table class="table table-sm table-bordered">
    <thead class="table-light text-center">
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for slot in booked_slots %}
      <tr class="text-center">
        <td>{{ slot.start_time }}</td>
        <td>{{ slot.end_time }}</td>
        <td>
          {% if slot.status == 'Approved' %}
            <span class="badge bg-success">Approved</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
        <script>
        document.querySelector("form").addEventListener("submit", function (e) {
          const start = new Date(document.getElementById("start_time").value);
          const end = new Date(document.getElementById("end_time").value);
          const now = new Date();

          if (start < now) {
            alert("âš ï¸ You cannot reserve a room in the past!");
            e.preventDefault();
          } else if (end <= start) {
            alert("âš ï¸ End time must be after start time!");
            e.preventDefault();
          }
        });
    </script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const startInput = document.getElementById("start_time");
  const endInput = document.getElementById("end_time");

  form.addEventListener("submit", function (e) {
    const now = new Date();
    const start = new Date(startInput.value);
    const end = new Date(endInput.value);

    // ðŸ§­ Validate start > now
    if (start < now) {
      e.preventDefault();
      alert("âš ï¸ You cannot reserve a room in the past!");
      return false;
    }

    // ðŸ§­ Validate end > start
    if (end <= start) {
      e.preventDefault();
      alert("âš ï¸ End time must be later than start time!");
      return false;
    }

    // âœ… Confirm before submitting
    const confirmReserve = confirm(
      `Please confirm your reservation:\n\nStart: ${start.toLocaleString()}\nEnd: ${end.toLocaleString()}\n\nClick OK to proceed.`
    );
    if (!confirmReserve) {
      e.preventDefault();
      return false;
    }

    // Let form submit normally
    return true;
  });
});
</script>

    </tbody>
  </table>
{% else %}
  <p class="text-muted fst-italic">No existing bookings for this room.</p>
{% endif %}

{% endblock %}


