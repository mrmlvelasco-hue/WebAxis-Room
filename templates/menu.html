{% extends "base_dashboard.html" %}
{% block title %}Dashboard | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3">
  <!-- Page Header - Improved Mobile Responsiveness -->
  <div class="row mb-3 mb-md-4">
    <div class="col-12">
      <h2 class="fw-bold page-title d-flex align-items-center flex-wrap gap-2">
        <i class="bi bi-graph-up-arrow"></i>
        <span class="title-text">WebAXIS Room Reservation Dashboard</span>
      </h2>
    </div>
  </div>

  <!-- KPI Cards - Improved Spacing and Sizing -->
  <div class="row g-2 g-md-3 mb-3 mb-md-4">
    <div class="col-6 col-lg-3">
      <div class="card text-center p-2 p-md-3 h-100 kpi-card">
        <div class="card-body p-0">
          <h6 class="fw-semibold text-secondary mb-1 mb-md-2 kpi-label">
            <i class="bi bi-building"></i>
            <span class="d-none d-sm-inline">Total Rooms</span>
            <span class="d-sm-none">Rooms</span>
          </h6>
          <h2 class="text-primary mb-0 kpi-number">{{ room_count }}</h2>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card text-center p-2 p-md-3 h-100 kpi-card">
        <div class="card-body p-0">
          <h6 class="fw-semibold text-secondary mb-1 mb-md-2 kpi-label">
            <i class="bi bi-hourglass-split"></i> Pending
          </h6>
          <h2 class="text-warning mb-0 kpi-number">{{ pending_count }}</h2>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card text-center p-2 p-md-3 h-100 kpi-card">
        <div class="card-body p-0">
          <h6 class="fw-semibold text-secondary mb-1 mb-md-2 kpi-label">
            <i class="bi bi-check-circle-fill"></i> Approved
          </h6>
          <h2 class="text-success mb-0 kpi-number">{{ approved_count }}</h2>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card text-center p-2 p-md-3 h-100 kpi-card">
        <div class="card-body p-0">
          <h6 class="fw-semibold text-secondary mb-1 mb-md-2 kpi-label">
            <i class="bi bi-x-circle-fill"></i> Cancelled
          </h6>
          <h2 class="text-danger mb-0 kpi-number">{{ cancelled_count }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Section - Improved Responsive Height -->
  <div class="row mb-3 mb-md-4">
    <div class="col-12">
      <div class="card p-2 p-md-4">
        <div class="card-body p-0">
          <h5 class="fw-bold mb-2 mb-md-3 chart-title">
            <i class="bi bi-calendar-week"></i>
            <span class="d-none d-md-inline">Reservation Activity (Last 7 Days)</span>
            <span class="d-md-none">Activity (7 Days)</span>
          </h5>
          <div class="chart-container">
            <canvas id="reservationChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let reservationChart = null;

/**
 * Renders or updates the reservation chart
 * @param {boolean} isDarkMode - Whether dark mode is active
 */
function renderReservationChart(isDarkMode) {
  const canvas = document.getElementById('reservationChart');

  // Safety check
  if (!canvas) {
    console.error('Chart canvas not found');
    return;
  }

  const ctx = canvas.getContext('2d');

  // Theme-based colors
  const chartColors = {
    pending: isDarkMode ? '#ffcc00' : '#ffc107',
    approved: isDarkMode ? '#4dd599' : '#198754',
    text: isDarkMode ? '#ddd' : '#333',
    grid: isDarkMode ? '#444' : '#e0e0e0',
    background: isDarkMode ? 'rgba(255, 204, 0, 0.2)' : 'rgba(255, 193, 7, 0.2)',
  };

  // Destroy existing chart to prevent memory leaks
  if (reservationChart) {
    reservationChart.destroy();
    reservationChart = null;
  }

  // Determine if mobile for responsive settings
  const isMobile = window.innerWidth < 768;

  // Create new chart
  try {
    reservationChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ chart_labels|tojson }},
        datasets: [
          {
            label: 'Pending',
            data: {{ chart_pending|tojson }},
            backgroundColor: chartColors.pending,
            borderColor: chartColors.pending,
            borderWidth: 1,
            borderRadius: isMobile ? 4 : 6,
          },
          {
            label: 'Approved',
            data: {{ chart_approved|tojson }},
            backgroundColor: chartColors.approved,
            borderColor: chartColors.approved,
            borderWidth: 1,
            borderRadius: isMobile ? 4 : 6,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: chartColors.text,
              font: {
                size: isMobile ? 10 : 12,
                family: "'Segoe UI', sans-serif"
              },
              padding: isMobile ? 10 : 15,
              usePointStyle: true,
              boxWidth: isMobile ? 8 : 12,
            }
          },
          tooltip: {
            backgroundColor: isDarkMode ? '#1a1a1a' : '#fff',
            titleColor: chartColors.text,
            bodyColor: chartColors.text,
            borderColor: chartColors.grid,
            borderWidth: 1,
            padding: isMobile ? 8 : 12,
            displayColors: true,
            titleFont: {
              size: isMobile ? 11 : 13
            },
            bodyFont: {
              size: isMobile ? 10 : 12
            },
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + ' reservation(s)';
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: chartColors.grid,
              display: false,
            },
            ticks: {
              color: chartColors.text,
              font: {
                size: isMobile ? 9 : 11
              },
              maxRotation: isMobile ? 45 : 0,
              minRotation: isMobile ? 45 : 0,
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: chartColors.grid,
              borderDash: [5, 5],
            },
            ticks: {
              color: chartColors.text,
              stepSize: 1,
              font: {
                size: isMobile ? 9 : 11
              },
              callback: function(value) {
                return Number.isInteger(value) ? value : '';
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error creating chart:', error);
  }
}

// === Initialize chart on page load ===
document.addEventListener('DOMContentLoaded', function() {
  const isDarkMode = document.body.classList.contains('dark-mode');
  renderReservationChart(isDarkMode);
});

// === Re-render chart when theme is toggled ===
const themeToggleBtn = document.getElementById('toggleTheme');
if (themeToggleBtn) {
  themeToggleBtn.addEventListener('click', function() {
    setTimeout(function() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      renderReservationChart(isDarkMode);
    }, 150);
  });
}

// === Re-render chart on window resize for responsive adjustments ===
let resizeTimer;
window.addEventListener('resize', function() {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(function() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    renderReservationChart(isDarkMode);
  }, 250);
});

// === Cleanup on page unload ===
window.addEventListener('beforeunload', function() {
  if (reservationChart) {
    reservationChart.destroy();
    reservationChart = null;
  }
});
</script>

<style>
/* ==========================================
   DASHBOARD PAGE STYLES - OPTIMIZED
   ========================================== */

/* Page Title - Responsive */
.page-title {
  font-size: clamp(1.1rem, 3.5vw, 1.75rem);
  line-height: 1.3;
}

.title-text {
  word-break: break-word;
}

/* KPI Cards - Improved Responsive Sizing */
.kpi-card {
  transition: all 0.2s ease;
  min-height: 100px;
}

.kpi-card:hover {
  transform: translateY(-2px);
}

.kpi-label {
  font-size: clamp(0.75rem, 2vw, 0.95rem);
  color: #6c757d;
}

.kpi-label i {
  font-size: clamp(0.85rem, 2.5vw, 1.1rem);
}

.kpi-number {
  font-size: clamp(1.75rem, 5vw, 3rem);
  font-weight: 700;
  line-height: 1;
}

/* Chart Container - Responsive Height */
.chart-container {
  position: relative;
  height: clamp(220px, 35vh, 350px);
  width: 100%;
}

.chart-title {
  font-size: clamp(0.95rem, 2.5vw, 1.25rem);
}

/* Mobile Specific Optimizations */
@media (max-width: 575.98px) {
  .kpi-card {
    min-height: 90px;
  }

  .kpi-number {
    margin-top: 0.25rem;
  }

  .chart-container {
    height: 220px;
  }

  /* Reduce card padding on very small screens */
  .card.p-2 {
    padding: 0.5rem !important;
  }
}

/* Tablet Adjustments */
@media (min-width: 576px) and (max-width: 991.98px) {
  .chart-container {
    height: 280px;
  }
}

/* Desktop Optimizations */
@media (min-width: 992px) {
  .kpi-card {
    min-height: 120px;
  }

  .chart-container {
    height: 350px;
  }
}

/* Dark Mode Adjustments */
body.dark-mode .kpi-label {
  color: #adb5bd;
}

body.dark-mode .chart-container {
  background: transparent;
}

body.dark-mode .kpi-card {
  border: 1px solid #333;
}

/* Print Styles */
@media print {
  .chart-container {
    page-break-inside: avoid;
    height: 300px !important;
  }

  .kpi-card {
    break-inside: avoid;
  }

  .page-title {
    font-size: 1.5rem;
  }
}

/* Loading State for Chart */
.chart-container::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #0047AB;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  opacity: 0;
  pointer-events: none;
}

.chart-container.loading::before {
  opacity: 1;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Accessibility - Focus States */
.kpi-card:focus-within {
  outline: 2px solid #0047AB;
  outline-offset: 2px;
}
</style>
{% endblock %}