{% extends "base_dashboard.html" %}
{% block title %}Reserve Room | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid py-2">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h3 mb-1 fw-bold text-dark"><i class="bi bi-calendar-plus text-primary me-2"></i>Reserve Room</h2>
      <p class="text-muted small mb-0">Schedule your meetings and manage room availability.</p>
    </div>
    <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary btn-sm shadow-sm" style="display:none;">
      <i class="bi bi-arrow-left"></i> Back to Rooms
    </a>
  </div>
<div class="container-fluid py-2">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">

  <!-- LEFT: FILTERS -->
  <div class="d-flex align-items-center gap-2 flex-wrap">

    <select id="locationFilterHeader"
            class="form-select form-select-sm"
            style="min-width:160px;">
      <option value="all">All Locations</option>
      {% for loc in locations %}
        <option value="{{ loc }}">{{ loc }}</option>
      {% endfor %}
    </select>

    <select id="roomFilterHeader"
            class="form-select form-select-sm"
            style="min-width:160px;">
      <option value="all">All Rooms</option>
    </select>

    <button id="applyFilterBtn"
            class="btn btn-primary btn-sm">
      <i class="bi bi-funnel me-1"></i>
      Apply Filters
    </button>

  </div>

  <!-- RIGHT: ACTION BUTTONS -->
  <div class="d-flex align-items-center gap-2">

    <button id="openReserveBtn"
            class="btn btn-success btn-sm">
      <i class="bi bi-calendar-plus me-1"></i>
      Reserve Room
    </button>

    <a id="viewFullCalendarBtn"

       href="/calendar_view?embed=1${params.toString()}"
       class="btn btn-outline-primary btn-sm">
      <i class="bi bi-calendar3 me-1"></i>
      View Full Calendar
    </a>

  </div>

</div>
  <div class="row g-4">


    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4" style="display:none;">
        <div class="card-body text-center py-4">
          <div class="avatar-placeholder rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-size: 1.5rem;">
            {{ (current_user.display_name or current_user.username)[0] | upper }}
          </div>
          <h6 class="fw-bold mb-1">{{ current_user.display_name or current_user.username }}</h6>
          <p class="text-muted small mb-0"><i class="bi bi-envelope me-1"></i> {{ current_user.email or 'N/A' }}</p>
        </div>
      </div>


    </div>
  </div>

  <div class="card border-0 shadow-sm mt-4 overflow-hidden">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <div class="fw-bold text-uppercase small tracking-wider">
        <i class="bi bi-grid-3x3-gap text-primary me-2"></i>Live Availability Grid
      </div>
      <button type="button" class="btn btn-sm btn-light border text-primary" onclick="refreshAvailability()">
        <i class="bi bi-arrow-clockwise"></i> Sync View
      </button>
    </div>
    <div class="card-body p-0 bg-dark-subtle">
      <iframe id="availabilityFrame" src="" style="width:100%; height:450px; border:0; display:block;"></iframe>
    </div>
  </div>
</div>

<div class="modal fade" id="reserveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
    <div class="modal-content border-0 shadow-lg">

      <!-- HEADER -->
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold text-primary">
          <i class="bi bi-calendar-plus me-2"></i>
          New Reservation
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- ROOM NAME -->
        <div class="mb-4">
          <label class="text-muted small fw-semibold">Room</label>
          <div id="modalRoomLabel"
               class="fw-bold fs-5 text-dark border rounded p-3 bg-light">
            -
          </div>
        </div>

        <!-- ===================== -->
        <!-- SCHEDULE SECTION -->
        <!-- ===================== -->
        <div class="mb-4">
          <h6 class="text-primary fw-bold small mb-3">Schedule</h6>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small">Start</label>
              <input type="datetime-local"
                     id="modalStartTime"
                     class="form-control"
                     step="1800">
            </div>

            <div class="col-md-6">
              <label class="form-label small">End</label>
              <input type="datetime-local"
                     id="modalEndTime"
                     class="form-control"
                     step="1800">
            </div>
          </div>
        </div>

        <!-- ===================== -->
        <!-- YOUR DETAILS -->
        <!-- ===================== -->
        <div class="mb-4">
          <h6 class="text-primary fw-bold small mb-3">Your Details</h6>

          <div class="mb-3">
            <label class="form-label small">Reserved By</label>
            <input type="text"
                   class="form-control bg-light"
                   value="{{ current_user.display_name or current_user.username }}"
                   readonly>
          </div>

          <div class="mb-3">
            <label class="form-label small">Email</label>
            <input type="email"
                   class="form-control bg-light"
                   value="{{ current_user.email }}"
                   readonly>
          </div>

          <div class="mb-3">
            <label class="form-label small">Remarks</label>
            <textarea id="modalMeetingTitle"
                      class="form-control"
                      maxlength="60"
                      rows="2"
                      placeholder="Enter meeting title (max 60 characters)">
            </textarea>
          </div>
        </div>

        <!-- ===================== -->
        <!-- ROOM FEATURES -->
        <!-- ===================== -->
        <div class="mb-4">
          <label class="form-label fw-semibold small">Room Features</label>
          <div id="featuresContainer"
               class="d-flex flex-wrap gap-2 p-2 bg-light rounded border">
          </div>
        </div>

        <!-- ===================== -->
        <!-- REPEAT -->
        <!-- ===================== -->
        <div class="mb-4">
          <h6 class="text-primary fw-bold small mb-3">Repeat</h6>

          <select class="form-select form-select-sm"
                  id="repeat_rule">
            <option value="none" selected>No repeat</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <!-- ===================== -->
        <!-- ENDS -->
        <!-- ===================== -->
        <div>
          <label class="form-label fw-semibold small mb-2">Ends</label>

          <div class="vstack gap-2">

            <div class="form-check">
              <input class="form-check-input"
                     type="radio"
                     name="repeat_ends"
                     id="endsNever"
                     value="never"
                     checked>
              <label class="form-check-label small" for="endsNever">
                Never (max 1 year)
              </label>
            </div>

            <div class="form-check">
              <input class="form-check-input"
                     type="radio"
                     name="repeat_ends"
                     id="endsOn"
                     value="on">
              <label class="form-check-label small" for="endsOn">
                On date
              </label>
              <input type="date"
                     id="endsOnDate"
                     class="form-control form-control-sm mt-1"
                     disabled>
            </div>

            <div class="form-check">
              <input class="form-check-input"
                     type="radio"
                     name="repeat_ends"
                     id="endsAfter"
                     value="after">
              <label class="form-check-label small" for="endsAfter">
                After
              </label>
              <div class="input-group input-group-sm mt-1">
                <input type="number"
                       id="endsAfterCount"
                       min="1"
                       class="form-control"
                       disabled>
                <span class="input-group-text">occurrences</span>
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button id="submitBtn"
                class="btn btn-primary">
          Submit
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="reserveSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    <div class="modal-content border-0 shadow-lg p-4 text-center">
      <div class="modal-body">
        <div class="mb-4">
          <div class="success-icon-circle mx-auto d-flex align-items-center justify-content-center">
             <i class="bi bi-check-lg display-4 text-success"></i>
          </div>
        </div>

        <h3 class="fw-bold text-dark mb-2" style="font-size: 1.75rem;">Reservation Submitted</h3>
        <p class="text-muted mb-4" id="reserveSuccessMetaText">reservations created.</p>

        <div class="d-grid px-5">
          <button type="button" class="btn btn-primary btn-lg rounded-pill fw-bold py-2 shadow-sm" data-bs-dismiss="modal" onclick="refreshAvailability()">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* =========================================================
       GLOBAL DATA
    ========================================================== */

    const ROOMS = {{ rooms_json | safe }};
    const modalEl = document.getElementById("reserveModal");
    const submitBtn = document.getElementById("submitBtn");

    const locationFilter = document.getElementById("locationFilterHeader");
    const roomFilter = document.getElementById("roomFilterHeader");
    const applyBtn = document.getElementById("applyFilterBtn");
    const iframe = document.getElementById("availabilityFrame");

    if (!modalEl || !submitBtn) return;

    /* =========================================================
       HEADER FILTERS → IFRAME
    ========================================================== */

    if (locationFilter) {
        locationFilter.addEventListener("change", function () {

            const loc = this.value;
            roomFilter.innerHTML = `<option value="all">All Rooms</option>`;

            const filteredRooms = ROOMS.filter(r =>
                loc === "all" || (r.location || "General") === loc
            );

            filteredRooms.forEach(r => {
                const opt = document.createElement("option");
                opt.value = r.name;
                opt.textContent = r.name;
                roomFilter.appendChild(opt);
            });
        });
    }

    if (applyBtn) {
        applyBtn.addEventListener("click", function () {

            const loc = locationFilter?.value || "all";
            const room = roomFilter?.value || "all";
            const date = new Date().toISOString().split("T")[0];

            iframe.src =
                `/calendar_view_v2?embed=1`
                + `&date=${encodeURIComponent(date)}`
                + `&location=${encodeURIComponent(loc)}`
                + `&room=${encodeURIComponent(room)}`;
        });
    }

    /* =========================================================
       FEATURE RENDERING
    ========================================================== */

    function parseFeatures(text) {
        if (!text) return [];
        return text.split(",")
                   .map(f => f.trim())
                   .filter(f => f.length > 0);
    }

    function getFeatureIcon(name) {
        const map = {
            "TV": "bi-tv",
            "Audio": "bi-volume-up",
            "Projector": "bi-projector",
            "Whiteboard": "bi-easel",
            "VC": "bi-camera-video"
        };
        return map[name] || "bi-dot";
    }

    function renderFeatures(featureText) {

        const container = document.getElementById("featuresContainer");
        if (!container) return;

        container.innerHTML = "";

        const features = parseFeatures(featureText);

        if (features.length === 0) {
            container.innerHTML =
                `<span class="text-muted small">No equipment listed</span>`;
            return;
        }

        features.forEach(f => {
            const badge = document.createElement("span");
            badge.className =
                "badge bg-primary-subtle text-primary border px-3 py-2 d-inline-flex align-items-center gap-1";

            const icon = getFeatureIcon(f);
            badge.innerHTML = `<i class="bi ${icon}"></i> ${f}`;
            container.appendChild(badge);
        });
    }

    /* =========================================================
       RECURRENCE ENABLE / DISABLE
    ========================================================== */

    modalEl.addEventListener("shown.bs.modal", function () {

        const endsNever = document.getElementById("endsNever");
        const endsOn = document.getElementById("endsOn");
        const endsAfter = document.getElementById("endsAfter");
        const endsOnDate = document.getElementById("endsOnDate");
        const endsAfterCount = document.getElementById("endsAfterCount");

        function syncEnds() {
            if (endsOnDate) endsOnDate.disabled = !endsOn?.checked;
            if (endsAfterCount) endsAfterCount.disabled = !endsAfter?.checked;
        }

        [endsNever, endsOn, endsAfter].forEach(el => {
            if (el) el.addEventListener("change", syncEnds);
        });

        syncEnds();
    });

    /* =========================================================
       OPEN NEW RESERVATION (FROM GRID CLICK)
    ========================================================== */

    window.addEventListener("message", function (event) {

      if (!event.data || !event.data.type) return;

    // ===================================================
    // OPEN NEW RESERVATION (Blank Cell Click)
    // ===================================================
    if (event.data.type === "OPEN_NEW_RESERVATION") {
        console.log('OPEN_NEW_RESERVATION')
        const roomId  = event.data.room_id;
        const slotMin = event.data.slot_min;

        const room = ROOMS.find(r => r.id == roomId);
        if (!room) return;

        const today = new Date();
        const selectedDate = today.toISOString().split("T")[0];

        const hours = String(Math.floor(slotMin / 60)).padStart(2,"0");
        const minutes = String(slotMin % 60).padStart(2,"0");

        const startValue = `${selectedDate}T${hours}:${minutes}`;
        const endDate = new Date(startValue);
        endDate.setMinutes(endDate.getMinutes() + 30);

        document.getElementById("modalStartTime").value = startValue;
        document.getElementById("modalEndTime").value =
            endDate.toISOString().slice(0,16);

        document.getElementById("modalMeetingTitle").value = "";
        document.getElementById("modalRoomLabel").textContent = room.name;

        renderFeatures(room.features || "");

        document.getElementById("repeat_rule").value = "none";
        document.getElementById("endsNever").checked = true;

        new bootstrap.Modal(modalEl).show();
        }
        // ===================================================
    // SHOW EXISTING RESERVATION
    // ===================================================
    if (event.data.type === "SHOW_RESERVATION") {

        const res = event.data.data;
        console.log('SHOW_RESERVATION')
        showReservationDetails(res);
    }
    });


    /* =========================================================
       SUBMIT HANDLER
    ========================================================== */

    submitBtn.addEventListener("click", async function (e) {

        e.preventDefault();

        const startInput = document.getElementById("modalStartTime");
        const endInput   = document.getElementById("modalEndTime");
        const remarksInput = document.getElementById("modalMeetingTitle");

        if (!startInput.value || !endInput.value) {
            Swal.fire("Missing Data",
                "Please select start and end time.",
                "warning");
            return;
        }

        if (endInput.value <= startInput.value) {
            Swal.fire("Invalid Time",
                "End must be after start.",
                "error");
            return;
        }

        const roomName =
            document.getElementById("modalRoomLabel")?.textContent?.trim();

        const room = ROOMS.find(r => r.name === roomName);

        if (!room) {
            Swal.fire("Error", "Room not found.", "error");
            return;
        }

        const fd = new FormData();
        fd.append("start_time", startInput.value);
        fd.append("end_time", endInput.value);
        fd.append("remarks", remarksInput.value || "");

        fd.append("recurrence_type",
            document.getElementById("repeat_rule")?.value || "none");

        let endMode = "never";
        if (document.getElementById("endsOn")?.checked) endMode = "on";
        if (document.getElementById("endsAfter")?.checked) endMode = "after";

        fd.append("end_mode", endMode);
        fd.append("end_on_date",
            document.getElementById("endsOnDate")?.value || "");
        fd.append("end_after_count",
            document.getElementById("endsAfterCount")?.value || "");

        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML =
            `<span class="spinner-border spinner-border-sm"></span> Saving...`;

        try {

            const res = await fetch(`/reserve_post/${room.id}`, {
                method: "POST",
                body: fd,
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            const data = await res.json();

            /* ======================
               SUCCESS
            ====================== */
            if (res.ok && data.success) {

                await Swal.fire({
                    icon: "success",
                    title: "Reservation Confirmed",
                    text: `${data.created_count || 1} reservation(s) created.`,
                    confirmButtonColor: "#0047AB"
                });

                location.reload();
                return;
            }

            /* ======================
               CONFLICT
            ====================== */
            if (res.status === 409 && data.conflicts) {

                let html = `
                    <div style="text-align:left;">
                    <b style="color:#dc3545;">
                    ${data.conflicts.length} conflict(s) detected
                    </b><br><br>
                `;

                data.conflicts.forEach(c => {
                    html += `
                        <div style="margin-bottom:10px;">
                            <b>${c.date}</b><br>
                            ${c.conflict_with}<br>
                            ${c.time_range}
                        </div>
                    `;
                });

                html += `No reservations were saved.</div>`;

                await Swal.fire({
                    icon: "error",
                    title: "Reservation Conflict",
                    html: html,
                    width: 600
                });

                return;
            }

            throw new Error(data.message || "Reservation failed.");

        } catch (err) {

            await Swal.fire("Error",
                err.message || "Unexpected system error.",
                "error");

        } finally {

            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
     function showReservationDetails(res) {

    const isOwner =
    res.reserved_by === CURRENT_USER.username ||
    res.email === CURRENT_USER.email;

    const canCancel = isOwner || CURRENT_USER.isAdmin;

    const status = (res.status || "").toLowerCase();

    const statusMap = {
        approved: { text: "APPROVED", bg: "#d1fae5", color: "#065f46" },
        pending:  { text: "PENDING",  bg: "#fef3c7", color: "#92400e" },
        blocked:  { text: "BLOCKED",  bg: "#fee2e2", color: "#991b1b" },
        booked:   { text: "BOOKED",   bg: "#d1fae5", color: "#065f46" }
    };

    const badge = statusMap[status] || {
        text: status.toUpperCase(),
        bg: "#e5e7eb",
        color: "#374151"
    };

     // robust time parsing
     function toMinutes(t){
         if (!t) return null;
         if (t.includes('T')) t = t.split('T')[1];
         const [hh,mm] = t.split(':');
         return (parseInt(hh)||0)*60 + (parseInt(mm)||0);
     }

    function minutesToHHMM(mins){
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }
    const startMin = toMinutes(res.start);
    const endMin   = toMinutes(res.end);

    const displayStart = minutesToHHMM(startMin);
    const displayEnd   = minutesToHHMM(endMin);


    Swal.fire({
        target: document.body,
        backdrop: true,
        width: 600,
        showConfirmButton: false,
        showCloseButton: true,
        padding: "2rem",
        html: `
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:28px;color:#0d47a1;">
                <i class="bi bi-calendar-check"></i>
            </div>
            <h3 style="margin-top:8px;font-weight:700;color:#0d47a1;">
                Reservation Details
            </h3>
        </div>

        <div style="text-align:left;font-size:15px;">

            ${detailRow("Room:", `<strong style="color:#0d47a1">${res.room}</strong>`)}
            ${divider()}

            ${detailRow("Status:",
                `<span style="
                    display:inline-block;
                    padding:6px 14px;
                    border-radius:20px;
                    background:${badge.bg};
                    color:${badge.color};
                    font-weight:600;
                    font-size:13px;
                ">${badge.text}</span>`
            )}
            ${divider()}

            ${detailRow("Reserved By:", res.reserved_by)}
            ${divider()}

            ${detailRow("Email:", res.email || "-")}
            ${divider()}

            ${detailRow("Time:",
                `<span style="color:#0d47a1;font-weight:600;">
                    ${displayStart} — ${displayEnd}
                </span>`
            )}
            ${divider()}

            ${detailRow("Meeting Title:", res.remarks || "—")}

        </div>

        ${canCancel ? `
        <div style="margin-top:30px;text-align:center;">
            <button id="cancelBtn"
                style="
                    background:#dc2626;
                    color:white;
                    border:none;
                    padding:12px 28px;
                    border-radius:8px;
                    font-weight:600;
                    box-shadow:0 4px 12px rgba(220,38,38,0.3);
                    cursor:pointer;
                ">
                <i class="bi bi-trash"></i>
                ${CURRENT_USER.isAdmin && !isOwner ? "Admin Override Cancel" : "Cancel Reservation"}
            </button>
        </div>
    ` : `
        <div style="margin-top:30px;text-align:center;color:#6c757d;font-size:13px;">
            Only the reservation owner can cancel this booking.
        </div>
    `}
        `,
        didOpen: () => {

            const btn = document.getElementById("cancelBtn");
            if(!btn) return;

            btn.addEventListener("click", async () => {

                const confirm = await Swal.fire({
                    title: "Confirm Cancellation?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#dc2626",
                    confirmButtonText: "Yes, Cancel"
                });

                if(!confirm.isConfirmed) return;

                const r = await fetch(`/api/cancel_reservation/${res.id}`, {
                    method: "POST"
                });

                const d = await r.json();

                if(d.success){
                    Swal.fire("Cancelled!", "", "success")
                        .then(()=> location.reload());
                }else{
                    Swal.fire("Error", d.message || "Cannot cancel", "error");
                }
            });
        }
    });

    function detailRow(label, value){
        return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
            <div style="color:#6b7280;width:140px;">${label}</div>
            <div style="flex:1;text-align:left;">${value}</div>
        </div>`;
    }

    function divider(){
        return `<div style="border-bottom:1px solid #e5e7eb;"></div>`;
    }
}
    function formatTimeRange(range) {
        if (!range) return "";

        const parts = range.split(" - ");
        if (parts.length !== 2) return range;

        const formatSingle = (dtStr) => {
            const d = new Date(dtStr);
            if (isNaN(d)) return dtStr;

            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        };

        return `${formatSingle(parts[0])} – ${formatSingle(parts[1])}`;
    }

});

    const CURRENT_USER = {
    username: "{{ current_user.username }}",
    email: "{{ current_user.email }}",
    isAdmin: {{ 'true' if current_user.is_admin() else 'false' }}
};
</script>

<style>
  /* Professional Modal Styling */
  #reserveSuccessModal .modal-content {
    border-radius: 20px; /* Softer corners like the image */
  }

  .success-icon-circle {
    width: 100px;
    height: 100px;
    background-color: #f0fff4; /* Light green tint */
    border: 3px solid #d1fae5; /* Very light border */
    border-radius: 50%;
  }

  /* Match the blue button exactly if needed */
  #reserveSuccessModal .btn-primary {
    background-color: #004dc5;
    border-color: #004dc5;
    transition: all 0.2s ease;
  }

  #reserveSuccessModal .btn-primary:hover {
    background-color: #003a94;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 77, 197, 0.2);
  }

  #reserveSuccessMetaText {
    font-size: 1.1rem;
    color: #6c757d;
  }
</style>
{% endblock %}
