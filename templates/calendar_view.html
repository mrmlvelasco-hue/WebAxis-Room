{% extends "base_dashboard.html" %}
{% block title %}Room Calendar | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid p-4">

  <!-- Header Toolbar -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="d-flex align-items-center gap-2">
<!--      <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary btn-sm">-->
<!--        <i class="bi bi-arrow-left"></i> Back to Rooms-->
<!--      </a>-->

      <h3 class="fw-bold text-primary mb-0 ms-2">
        <i class="bi bi-calendar3"></i> Meeting Room Calendar
      </h3>
    </div>

    <!-- FILTERS -->
    <div class="d-flex flex-wrap align-items-center gap-2 mt-2 mt-md-0">

      <!-- LOCATION FILTER -->
      <select id="groupFilter" class="form-select form-select-sm">
        {% for loc in locations %}
          <option value="{{ loc }}" {% if current_location == loc %}selected{% endif %}>
            {{ loc }}
          </option>
        {% endfor %}
      </select>

      <!-- ROOM FILTER -->
      <select id="roomFilter" class="form-select form-select-sm">
    <option value="all">All Rooms</option>
    {% for loc, room_list in grouped_rooms.items() %}
        <optgroup label="{{ loc }}">
            {% for room in room_list %}
                <option value="{{ room }}">{{ room }}</option>
            {% endfor %}
        </optgroup>
    {% endfor %}
</select>


      <!-- TODAY -->
      <button class="btn btn-outline-primary btn-sm" id="todayBtn">Today</button>

      <!-- REFRESH -->
      <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="d-flex gap-4 mb-3 flex-wrap">
    <span class="d-flex align-items-center">
      <span class="legend-box bg-primary me-2"></span> Approved
    </span>

    <span class="d-flex align-items-center">
      <span class="legend-box bg-warning me-2"></span> Pending
    </span>
  </div>

  <!-- Calendar Container -->
  <div id="calendar" class="calendar-container"></div>
    <!-- Excel Day View container (hidden by default) -->
    <div id="excelDayWrap" class="mt-3" style="display:none;">
      <iframe id="excelDayFrame"
              src=""
              style="width:100%; height:520px; border:0; background:#fff; border-radius:8px;"></iframe>
    </div>
</div>

<!-- Reservation Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-info-circle me-2"></i> Reservation Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Room</dt><dd class="col-sm-8" id="detailRoom"></dd>
          <dt class="col-sm-4">Reserved By</dt><dd class="col-sm-8" id="detailUser"></dd>
          <dt class="col-sm-4">Date</dt><dd class="col-sm-8" id="detailDate"></dd>
          <dt class="col-sm-4">Time</dt><dd class="col-sm-8" id="detailTime"></dd>
          <dt class="col-sm-4">Status</dt><dd class="col-sm-8" id="detailStatus"></dd>
          <dt class="col-sm-4">Remarks</dt><dd class="col-sm-8" id="detailRemarks"></dd>
        </dl>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const calendarEl   = document.getElementById('calendar');
  const groupFilter  = document.getElementById('groupFilter');
  const roomFilter   = document.getElementById('roomFilter');
  const todayBtn     = document.getElementById('todayBtn');
  const refreshBtn   = document.getElementById('refreshBtn');

  const groupedRooms = {{ grouped_rooms|tojson }};

  // Query params
  const urlQS = new URLSearchParams(window.location.search);
  const allowedViews = new Set(["dayGridMonth", "dayGridWeek", "dayGridDay", "timeGridWeek", "timeGridDay"]);
  const initialViewParam = urlQS.get("view") || "dayGridMonth";
  const initialView = allowedViews.has(initialViewParam) ? initialViewParam : "dayGridMonth";
  const initialDate = urlQS.get("date") || null;

  // Excel (iframe) mode state
  let EXCEL_MODE = false;

  function fmtDateYYYYMMDD(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function updateRoomDropdown() {
    const loc = groupFilter.value;
    roomFilter.innerHTML = '<option value="all">All Rooms</option>';

    if (groupedRooms[loc]) {
      groupedRooms[loc].forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        roomFilter.appendChild(opt);
      });
    }
  }

  // Apply query params (location/group + room) BEFORE we render the calendar
  (function applyQueryParamsOnLoad() {
    const qLoc  = urlQS.get("location") || urlQS.get("group");
    const qRoom = urlQS.get("room");

    if (qLoc && groupedRooms[qLoc]) {
      groupFilter.value = qLoc;
    }

    updateRoomDropdown();

    if (qRoom) {
      const hasRoom = Array.from(roomFilter.options).some(o => o.value === qRoom);
      roomFilter.value = hasRoom ? qRoom : "all";
    }
  })();

  // Build Excel URL using current date + filters
  function buildExcelUrl(dateObj){
    const loc = groupFilter?.value || "all";
    const room = roomFilter?.value || "all";
    const dateStr = fmtDateYYYYMMDD(dateObj);

    const qs = new URLSearchParams();
    qs.set("embed", "1");
    qs.set("date", dateStr);

    // v2 expects "location"
    qs.set("location", loc);
    qs.set("room", room);

    return `/calendar_view_v2?${qs.toString()}`;
  }

  function showExcelDay(){
  EXCEL_MODE = true;

  calendarEl.classList.add("excel-mode"); // hide FC grid only

  const wrap = document.getElementById("excelDayWrap");
  const frame = document.getElementById("excelDayFrame");
  if (wrap) wrap.style.display = "";
  if (frame) frame.src = buildExcelUrl(calendar.getDate());
}

function showFullCalendar(){
  EXCEL_MODE = false;

  calendarEl.classList.remove("excel-mode");

  const wrap = document.getElementById("excelDayWrap");
  if (wrap) wrap.style.display = "none";

  calendar.updateSize();
}

function refreshExcelIfVisible(){
  if (!EXCEL_MODE) return;
  const frame = document.getElementById("excelDayFrame");
  if (frame) frame.src = buildExcelUrl(calendar.getDate());
}

  function reloadCalendar() {
    calendarEl.classList.add("loading");
    calendar.refetchEvents();
    setTimeout(() => calendarEl.classList.remove("loading"), 250);
  }

  // FullCalendar init
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: initialView,
    initialDate: initialDate || undefined,

    themeSystem: 'bootstrap5',
    height: 'auto',
    eventDisplay: 'block',

    headerToolbar: {
      left: 'prev,next fcToday excelView',
      center: 'title',
      right: 'dayGridMonth,dayGridWeek,excelDay'
    },

    customButtons: {
      fcToday: {
        text: 'Today',
        click: function () {
          calendar.today();
          reloadCalendar();
          refreshExcelIfVisible();
        }
      },
      excelDay: {
        text: 'day',
        click: function () {
          showExcelDay(); // smooth switch
        }
      },
      excelView: {
        text: 'Excel View',
        click: function () {
          showExcelDay(); // same as day
        }
      }
    },

    events: function(fetchInfo, successCallback, failureCallback) {
      const params = new URLSearchParams({
        start: fetchInfo.startStr,
        end: fetchInfo.endStr,
        group: groupFilter.value,
        room: roomFilter.value
      });

      fetch(`/api/reservations?${params.toString()}`)
        .then(r => r.json())
        .then(data => successCallback(data))
        .catch(err => failureCallback(err));
    },

    eventContent: function(arg) {
      const room = arg.event.extendedProps.room;
      const color = arg.event.extendedProps.color;

      return {
        html: `
          <div class="p-1 rounded text-white" style="background:${color};font-size:0.72rem;">
            <div class="fw-bold">${arg.event.title.split(' - ')[1]}</div>
            <small class="text-white-50">${room}</small><br>
            <small>${arg.timeText}</small>
          </div>
        `
      };
    },

    eventDidMount: function(info) {
      new bootstrap.Tooltip(info.el, {
        title: `${info.event.extendedProps.room}\n${info.event.extendedProps.description || ''}`,
        placement: "top",
        trigger: "hover",
        container: "body"
      });
    },

    eventClick: function(info) {
      const ev = info.event;

      document.getElementById('detailRoom').textContent = ev.extendedProps.room;
      document.getElementById('detailUser').textContent = ev.title.split(" - ")[1];
      document.getElementById('detailDate').textContent = ev.start.toLocaleDateString();

      document.getElementById('detailTime').textContent =
        `${ev.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${ev.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

      document.getElementById('detailStatus').textContent = ev.extendedProps.status;
      document.getElementById('detailRemarks').textContent = ev.extendedProps.description || "—";

      new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
    }
  });

  calendar.render();
  reloadCalendar();

  // Keep Excel iframe synced when date range changes (prev/next/week/month)
  calendar.on("datesSet", function(){
    refreshExcelIfVisible();
  });

  // If user clicks Month/Week while Excel is visible, switch back to FullCalendar
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".fc-button");
    if (!btn) return;

    if (EXCEL_MODE && (
      btn.classList.contains("fc-dayGridMonth-button") ||
      btn.classList.contains("fc-dayGridWeek-button")
    )) {
      showFullCalendar();
      reloadCalendar();
    }
  });

  // Filters and buttons
  groupFilter.addEventListener('change', function() {
    updateRoomDropdown();
    reloadCalendar();
    refreshExcelIfVisible();
  });

  roomFilter.addEventListener('change', function() {
    reloadCalendar();
    refreshExcelIfVisible();
  });

  refreshBtn.addEventListener('click', function() {
    reloadCalendar();
    refreshExcelIfVisible();
  });

  todayBtn.addEventListener('click', () => {
    calendar.today();
    reloadCalendar();
    refreshExcelIfVisible();
  });

});
        window.addEventListener("message", function(event) {

    if (!event.data || event.data.type !== "SHOW_RESERVATION") return;

    const res = event.data.data;

    showParentReservationPopup(res);

});
     function showParentReservationPopup(res) {

    const status = (res.status || "").toLowerCase();

    function toMinutes(t){
           if (!t) return null;
           if (t.includes('T')) t = t.split('T')[1];
           const [hh,mm] = t.split(':');
           return (parseInt(hh)||0)*60 + (parseInt(mm)||0);
       }

    const statusMap = {
        approved: { text: "APPROVED", bg: "#d1fae5", color: "#065f46" },
        pending:  { text: "PENDING",  bg: "#fef3c7", color: "#92400e" },
        blocked:  { text: "BLOCKED",  bg: "#fee2e2", color: "#991b1b" },
        booked:   { text: "BOOKED",   bg: "#d1fae5", color: "#065f46" }
    };

    const badge = statusMap[status] || {
        text: status.toUpperCase(),
        bg: "#e5e7eb",
        color: "#374151"
    };
     // robust time parsing
     function toMinutes(t){
         if (!t) return null;
         if (t.includes('T')) t = t.split('T')[1];
         const [hh,mm] = t.split(':');
         return (parseInt(hh)||0)*60 + (parseInt(mm)||0);
     }

    function minutesToHHMM(mins){
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }
    const startMin = toMinutes(res.start);
    const endMin   = toMinutes(res.end);

    const displayStart = minutesToHHMM(startMin);
    const displayEnd   = minutesToHHMM(endMin);
    Swal.fire({
        target: document.body,
        backdrop: true,
        width: 600,
        showConfirmButton: false,
        showCloseButton: true,
        padding: "2rem",
        html: `
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:28px;color:#0d47a1;">
                <i class="bi bi-calendar-check"></i>
            </div>
            <h3 style="margin-top:8px;font-weight:700;color:#0d47a1;">
                Reservation Details
            </h3>
        </div>

        <div style="text-align:left;font-size:15px;">

            ${detailRow("Room:", `<strong style="color:#0d47a1">${res.room}</strong>`)}
            ${divider()}

            ${detailRow("Status:",
                `<span style="
                    display:inline-block;
                    padding:6px 14px;
                    border-radius:20px;
                    background:${badge.bg};
                    color:${badge.color};
                    font-weight:600;
                    font-size:13px;
                ">${badge.text}</span>`
            )}
            ${divider()}

            ${detailRow("Reserved By:", res.reserved_by)}
            ${divider()}

            ${detailRow("Email:", res.email || "-")}
            ${divider()}

            ${detailRow("Time:",
                `<span style="color:#0d47a1;font-weight:600;">
                    ${displayStart} — ${displayEnd}
                </span>`
            )}
            ${divider()}

            ${detailRow("Meeting Title:", res.remarks || "—")}

        </div>

        <div style="margin-top:30px;text-align:center;">
            <button id="cancelBtn"
                style="
                    background:#dc2626;
                    color:white;
                    border:none;
                    padding:12px 28px;
                    border-radius:8px;
                    font-weight:600;
                    box-shadow:0 4px 12px rgba(220,38,38,0.3);
                    cursor:pointer;
                ">
                <i class="bi bi-trash"></i>
                Cancel Reservation
            </button>
        </div>
        `,
        didOpen: () => {

            const btn = document.getElementById("cancelBtn");
            if(!btn) return;

            btn.addEventListener("click", async () => {

                const confirm = await Swal.fire({
                    title: "Confirm Cancellation?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#dc2626",
                    confirmButtonText: "Yes, Cancel"
                });

                if(!confirm.isConfirmed) return;

                const r = await fetch(`/api/cancel_reservation/${res.id}`, {
                    method: "POST"
                });

                const d = await r.json();

                if(d.success){
                    Swal.fire("Cancelled!", "", "success")
                        .then(()=> location.reload());
                }else{
                    Swal.fire("Error", d.message || "Cannot cancel", "error");
                }
            });
        }
    });

    function detailRow(label, value){
        return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
            <div style="color:#6b7280;width:140px;">${label}</div>
            <div style="flex:1;text-align:left;">${value}</div>
        </div>`;
    }

    function divider(){
        return `<div style="border-bottom:1px solid #e5e7eb;"></div>`;
    }
}
</script>

<style>
/* Fade-in animation */
.calendar-container {
  animation: fadeIn .25s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Legend boxes */
.legend-box {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  display: inline-block;
}

/* Event styling */
.fc-daygrid-event {
  border-radius: 6px !important;
  padding: 0 !important;
  cursor: pointer;
}

/* Today's highlight */
.fc .fc-day-today {
  background-color: rgba(0, 71, 171, 0.12) !important;
  border-left: 3px solid #0047AB !important;
}

/* Calendar loading effect */
#calendar.loading {
  opacity: 0.5;
  pointer-events: none;
}
    /* Make custom day button look like FC buttons */
.fc .fc-excelDay-button {
  text-transform: lowercase;
}
    /* Excel mode: keep FC header, hide FC grid */
#calendar.excel-mode .fc-view-harness {
  display: none !important;
}
    .fc-excelView-button {
  display: none !important;
}
</style>

{% endblock %}
