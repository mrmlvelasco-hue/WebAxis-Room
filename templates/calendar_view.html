{% extends "base_dashboard.html" %}
{% block title %}Room Calendar | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid p-4">
  <!-- Header Toolbar -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="d-flex align-items-center gap-2">
      <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Rooms
      </a>
      <h3 class="fw-bold text-primary mb-0 ms-2">
        <i class="bi bi-calendar3"></i> Meeting Room Calendar
      </h3>
    </div>

    <div class="d-flex align-items-center gap-2 mt-2 mt-md-0 flex-wrap">
      <!-- Group (Location) Filter -->
      <select id="groupFilter" class="form-select form-select-sm">
        <option value="all">All Locations</option>
        {% for r in rooms|groupby('location') %}
          <option value="{{ r.grouper }}">{{ r.grouper }}</option>
        {% endfor %}
      </select>

      <!-- Room Filter -->
      <select id="roomFilter" class="form-select form-select-sm">
          <option value="all">All Rooms</option>
          {% for room in rooms %}
            <option value="{{ room.name }}" data-location="{{ room.location }}">{{ room.name }}</option>
          {% endfor %}
        </select>


      <!-- Navigation Buttons -->
      <button class="btn btn-outline-primary btn-sm" id="todayBtn">Today</button>
      <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Calendar Container -->
  <div id="calendar"></div>
</div>

<!-- Reservation Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="eventDetailModalLabel">
          <i class="bi bi-info-circle me-2"></i> Reservation Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Room</dt>
          <dd class="col-sm-8" id="detailRoom"></dd>

          <dt class="col-sm-4">Reserved By</dt>
          <dd class="col-sm-8" id="detailUser"></dd>

          <dt class="col-sm-4">Date</dt>
          <dd class="col-sm-8" id="detailDate"></dd>

          <dt class="col-sm-4">Time</dt>
          <dd class="col-sm-8" id="detailTime"></dd>

          <dt class="col-sm-4">Status</dt>
          <dd class="col-sm-8" id="detailStatus"></dd>

          <dt class="col-sm-4">Remarks</dt>
          <dd class="col-sm-8" id="detailRemarks"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  const groupFilter = document.getElementById('groupFilter');
  const roomFilter = document.getElementById('roomFilter');
  const todayBtn = document.getElementById('todayBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const allRooms = {{ rooms|tojson }};

  // Spinner while loading
  const spinner = document.createElement('div');
  spinner.id = 'calendar-spinner';
  spinner.innerHTML = '<div class="text-center mt-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
  spinner.style.display = 'none';
  calendarEl.parentElement.insertBefore(spinner, calendarEl);

  // --- Dynamic event source builder ---
  function makeEventSource() {
    return {
      url: '/api/reservations',
      method: 'GET',
      extraParams: function() {
        return {
          group: groupFilter.value || 'all',
          room: roomFilter.value || 'all'
        };
      },
      failure: function() {
        console.error("‚ùå Event fetch failed.");
      }
    };
  }

  // --- Initialize calendar ---
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    themeSystem: 'bootstrap5',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,dayGridWeek,dayGridDay'
    },
    eventSources: [makeEventSource()],
    loading: function(isLoading) {
      spinner.style.display = isLoading ? 'block' : 'none';
    },
    eventDidMount: function(info) {
      new bootstrap.Tooltip(info.el, {
        title: `<b>${info.event.title}</b><br>${info.event.extendedProps.description || ''}`,
        html: true,
        placement: 'top'
      });
    },
    eventContent: function(arg) {
      let color = '#0047AB';
      if (arg.event.extendedProps.status === 'Pending') color = '#FFA726';
      else if (arg.event.extendedProps.status === 'Cancelled') color = '#B0BEC5';
      return { html: `<div class="p-1 rounded" style="background:${color};color:white;font-size:0.75rem;"><b>${arg.event.title}</b><br><small>${arg.timeText}</small></div>` };
    },
    eventClick: function(info) {
      const ev = info.event;
      const start = new Date(ev.start);
      const end = new Date(ev.end);
      const dateOpts = { year: 'numeric', month: 'short', day: 'numeric' };

      document.getElementById('detailRoom').textContent = ev.extendedProps.room || ev.title.split(" - ")[0];
      document.getElementById('detailUser').textContent = ev.title.split(" - ")[1] || 'N/A';
      document.getElementById('detailDate').textContent = start.toLocaleDateString(undefined, dateOpts);
      document.getElementById('detailTime').textContent =
        `${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      document.getElementById('detailStatus').textContent = ev.extendedProps.status;
      document.getElementById('detailRemarks').textContent = ev.extendedProps.description || '‚Äî';
      new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
    }
  });

  calendar.render();

  // --- Reload calendar data ---
  function reloadCalendar() {
    console.log("üîÅ Reloading calendar with filters:", {
      group: groupFilter.value,
      room: roomFilter.value
    });
    calendar.getEventSources().forEach(src => src.remove()); // clear existing source
    calendar.addEventSource(makeEventSource()); // re-add fresh one
    calendar.refetchEvents(); // fetch again
  }

  // --- Update room dropdown when group changes ---
  groupFilter.addEventListener('change', function() {
    const selectedGroup = this.value;
    const filteredRooms = selectedGroup === 'all' ? allRooms : allRooms.filter(r => r.location === selectedGroup);
    roomFilter.innerHTML = '<option value="all">All Rooms</option>';
    filteredRooms.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.name;
      opt.textContent = r.name;
      roomFilter.appendChild(opt);
    });
    reloadCalendar();
  });

  // --- Room filter change ---
  roomFilter.addEventListener('change', reloadCalendar);

  // --- Navigation buttons ---
  todayBtn.addEventListener('click', () => calendar.today());
  refreshBtn.addEventListener('click', reloadCalendar);
});
</script>




<style>
/* Calendar Styling */
.fc .fc-daygrid-event {
  border: none !important;
  cursor: pointer;
}
.fc .fc-day-today {
  background-color: rgba(0, 71, 171, 0.08) !important;
}
.fc .fc-toolbar-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #0047AB;
}
.fc .fc-button {
  font-size: 0.85rem;
}
.modal-content dl dt {
  font-weight: 600;
}
#roomFilter option[hidden] {
  display: none;
}

</style>
{% endblock %}
