<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>{% block title %}WebAXIS RoomSys{% endblock %}</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Custom Dashboard CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_dashboard.css') }}" />
<!-- SweetAlert2 (used across pages) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
<div class="sidebar-header">
<i class="bi bi-building"></i> WebAXIS
</div>
<ul class="nav flex-column mt-3">
<li>
<a href="{{ url_for('main_menu') }}" class="nav-link {% if request.endpoint == 'main_menu' %}active{% endif %}">
<i class="bi bi-speedometer2 me-2"></i> <span class="link-text">Dashboard</span>
</a>
</li>
<li>
<a href="{{ url_for('room_list') }}" class="nav-link {% if request.endpoint == 'room_list' %}active{% endif %}">
<i class="bi bi-door-open me-2"></i> <span class="link-text">Rooms</span>
</a>
</li>
{% if current_user.is_admin() %}
<li>
<a href="{{ url_for('admin_dashboard') }}" class="nav-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}">
<i class="bi bi-calendar-check me-2"></i> <span class="link-text">Reservations</span>
</a>
</li>
<li>
<a href="{{ url_for('user_maintenance') }}" class="nav-link {% if request.endpoint == 'user_maintenance' %}active{% endif %}">
<i class="bi bi-people me-2"></i> <span class="link-text">Users</span>
</a>
</li>
     {% endif %}
   {% if current_user and (current_user.role|lower == 'admin' or (current_user.is_admin() if current_user.is_admin is defined else False)) %}
<li class="nav-item">
  <a class="nav-link" href="{{ url_for('room_maintenance') }}">
    <i class="bi bi-gear"></i> Room Maintenance
  </a>
</li>
{% endif %}

{# Add an Approvals link for approvers #}
{% if current_user %}
<li class="nav-item">
  <a class="nav-link" href="{{ url_for('approvals') }}"><i class="bi bi-check2-square"></i> Approvals</a>
</li>
{% endif %}


<li class="mt-auto">
<a href="{{ url_for('logout') }}" class="nav-link">
<i class="bi bi-box-arrow-right me-2"></i> <span class="link-text">Logout</span>
</a>
</li>
</ul>
</div>
<!-- Topbar -->
<div class="topbar shadow-sm d-flex align-items-center justify-content-between">
<div class="d-flex align-items-center">
<!-- Sidebar Toggle -->
<button id="toggleSidebar" class="btn btn-sm btn-outline-secondary me-3">
<i class="bi bi-list"></i>
</button>
<span class="fw-semibold text-dark">Welcome, {{ current_user.display_name or current_user.username }}</span>
</div>
<div class="d-flex align-items-center gap-3">
<div class="user-info text-end">
<i class="bi bi-person-circle me-1"></i> {{ current_user.role|capitalize }}
</div>
<!-- Dark Mode Toggle -->
<button id="toggleTheme" class="btn btn-sm btn-outline-secondary">
<i id="themeIcon" class="bi bi-moon"></i>
</button>
</div>
</div>
<!-- Flash Messages (SweetAlert) -->
 {% with messages = get_flashed_messages(with_categories=true) %}
   {% if messages %}
<script>
       document.addEventListener("DOMContentLoaded", function () {
         {% for category, message in messages %}
           // Use the flashed message from server if provided; fallback to generic text
           const cat = "{{ category }}";
           const msg = "{{ message|e }}";
           const icon = cat === "success" ? "success" : (cat === "danger" ? "error" : (cat === "warning" ? "warning" : "info"));
           // Optional: if you passed redirect_url in flash context, use it; otherwise skip redirect
           {% if redirect_url is defined %}
             const redirectTarget = "{{ redirect_url }}";
           {% else %}
             const redirectTarget = null;
           {% endif %}
           Swal.fire({
              icon: icon,
              title: msg || "Notification",
              confirmButtonText: "OK",
              confirmButtonColor: "#0047AB",
              timer: (icon === "success") ? 2500 : null,
              timerProgressBar: (icon === "success"),
              allowOutsideClick: true,
              allowEscapeKey: true,
              width: "450px"
            });
         {% endfor %}
       });
</script>
   {% endif %}
 {% endwith %}
<!-- Page Content -->
<div class="content-area mt-4">
   {% block content %}{% endblock %}
</div>
<!-- Footer -->
<footer class="footer text-center py-3">
   Â© 2025 PCPPI | WebAXIS Room Reservation System
</footer>
<!-- Bootstrap JS (bundle includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Sidebar toggle (defensive checks) -->
<script>
   document.addEventListener("DOMContentLoaded", function () {
     const toggleBtn = document.getElementById('toggleSidebar');
     if (toggleBtn) {
       toggleBtn.addEventListener('click', () => {
         const sidebar = document.querySelector('.sidebar');
         if (!sidebar) return;
         sidebar.classList.toggle('collapsed');
         if (window.innerWidth <= 992) {
           sidebar.classList.toggle('active');
         }
       });
     }
   });
</script>
<!-- Theme toggle (defensive checks) -->
<script>
   document.addEventListener("DOMContentLoaded", function () {
     const body = document.body;
     const themeBtn = document.getElementById('toggleTheme');
     const themeIcon = document.getElementById('themeIcon');
     if (!themeBtn || !themeIcon) return;
     if (localStorage.getItem('theme') === 'dark') {
       body.classList.add('dark-mode');
       themeIcon.classList.replace('bi-moon', 'bi-sun');
     }
     themeBtn.addEventListener('click', () => {
       body.classList.toggle('dark-mode');
       const isDark = body.classList.contains('dark-mode');
       localStorage.setItem('theme', isDark ? 'dark' : 'light');
       themeIcon.classList.toggle('bi-moon');
       themeIcon.classList.toggle('bi-sun');
     });
   });
</script>
<!-- Global form validation + confirm (defensive checks for pages with no form) -->
<script>
   document.addEventListener("DOMContentLoaded", function () {
     const form = document.querySelector("form");
     if (!form) return; // only apply on pages with a form
     const startInput = document.getElementById("start_time");
     const endInput = document.getElementById("end_time");
     // If inputs missing, we skip the validation (so template works across pages)
     if (!startInput || !endInput) return;
     form.addEventListener("submit", function (e) {
       e.preventDefault();
       const now = new Date();
       const start = new Date(startInput.value);
       const end = new Date(endInput.value);
       if (isNaN(start.getTime()) || isNaN(end.getTime())) {
         Swal.fire({ icon: "warning", title: "Invalid date/time", text: "Please enter valid start and end times." });
         return false;
       }
       if (start < now) {
         Swal.fire({ icon: "warning", title: "Invalid Start Time", text: "You cannot reserve a room in the past!", confirmButtonColor: "#0047AB" });
         return false;
       }
       if (end <= start) {
         Swal.fire({ icon: "warning", title: "Invalid End Time", text: "End time must be later than start time.", confirmButtonColor: "#0047AB" });
         return false;
       }
       Swal.fire({
         title: "Confirm Reservation",
         html: `<div class='text-start'>
<p><b>Start:</b> ${start.toLocaleString()}</p>
<p><b>End:</b> ${end.toLocaleString()}</p>
<p class='text-muted fst-italic'>Please review your schedule before confirming.</p>
</div>`,
         icon: "question",
         showCancelButton: true,
         confirmButtonText: "Confirm Reservation",
         cancelButtonText: "Cancel",
         confirmButtonColor: "#0047AB",
         cancelButtonColor: "#6c757d",
         reverseButtons: true
       }).then((result) => {
         if (result.isConfirmed) {
           Swal.fire({ icon: "success", title: "Reservation Submitted!", text: "Your reservation has been sent for approval.", showConfirmButton: false, timer: 1500 });
           setTimeout(() => form.submit(), 1400);
         }
       });
     });
   });
</script>
<!-- === PLACEHOLDER: page-specific scripts will be injected here === -->
 {% block scripts %}{% endblock %}
</body>
</html>