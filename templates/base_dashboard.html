<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>{% block title %}WebAXIS RoomSys{% endblock %}</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Main Dashboard CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_dashboard.css') }}" />

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- ========================
     SIDEBAR
     ======================== -->
<div class="sidebar">
    <div class="sidebar-header">
        <i class="bi bi-building"></i> WebAXIS
    </div>

    <!-- Mobile-only menu button (inside sidebar) -->
    <button class="btn btn-outline-light d-md-none position-absolute top-0 start-0 m-2" id="menu-toggle">
        <i class="bi bi-list"></i>
    </button>

    <ul class="nav flex-column mt-3">
        <li>
            <a href="{{ url_for('main_menu') }}" class="nav-link {% if request.endpoint == 'main_menu' %}active{% endif %}">
                <i class="bi bi-speedometer2 me-2"></i>
                <span class="link-text">Dashboard</span>
            </a>
        </li>

        <li>
            <a href="{{ url_for('room_list') }}" class="nav-link {% if request.endpoint == 'room_list' %}active{% endif %}">
                <i class="bi bi-door-open me-2"></i>
                <span class="link-text">Rooms</span>
            </a>
        </li>

        {% if current_user.is_admin() %}
        <li>
            <a href="{{ url_for('admin_dashboard') }}" class="nav-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}">
                <i class="bi bi-calendar-check me-2"></i>
                <span class="link-text">Reservations</span>
            </a>
        </li>

        <li>
            <a href="{{ url_for('user_maintenance') }}" class="nav-link {% if request.endpoint == 'user_maintenance' %}active{% endif %}">
                <i class="bi bi-people me-2"></i>
                <span class="link-text">Users</span>
            </a>
        </li>
        {% endif %}

        {% if current_user %}
        <li>
            <a href="{{ url_for('room_maintenance') }}" class="nav-link {% if request.endpoint == 'room_maintenance' %}active{% endif %}">
                <i class="bi bi-gear me-2"></i>
                <span class="link-text">Room Maintenance</span>
            </a>
        </li>

        <li>
  <a href="{{ url_for('approvals') }}" class="nav-link">
    <i class="bi bi-clipboard-check"></i>
    Approvals
    {% if pending_count and pending_count > 0 %}
      <span class="badge bg-danger ms-1">{{ pending_count }}</span>
    {% endif %}
  </a>
</li>

        {% endif %}

        <li class="mt-auto">
            <a href="{{ url_for('logout') }}" class="nav-link">
                <i class="bi bi-box-arrow-right me-2"></i>
                <span class="link-text">Logout</span>
            </a>
        </li>
    </ul>
</div>

<!-- ========================
     TOPBAR
     ======================== -->
<div class="topbar shadow-sm d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
        <button id="toggleSidebar" class="btn btn-sm btn-outline-secondary me-3">
            <i class="bi bi-list"></i>
        </button>
        <span class="fw-semibold text-dark">
            Welcome, {{ current_user.display_name or current_user.username }}
        </span>
    </div>

    <div class="d-flex align-items-center gap-3">
        <div class="user-info text-end">
            <i class="bi bi-person-circle me-1"></i> {{ current_user.role|capitalize }}
        </div>

        <!-- Theme toggle -->
        <button id="toggleTheme" class="btn btn-sm btn-outline-secondary">
            <i id="themeIcon" class="bi bi-moon"></i>
        </button>
    </div>
</div>

<!-- ========================
     FLASH MESSAGES
     ======================== -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    {% for category, message in messages %}
    Swal.fire({
        icon: "{{ 'success' if category=='success' else ('error' if category=='danger' else category) }}",
        title: "{{ message|e }}",
        confirmButtonColor: "#0047AB",
    });
    {% endfor %}
});
</script>
{% endif %}
{% endwith %}

<!-- ========================
     PAGE CONTENT WRAPPER
     ======================== -->
<div class="content-area mt-4">
    {% block content %}{% endblock %}
</div>

<!-- ========================
     FOOTER
     ======================== -->
<footer class="footer text-center py-3">
   © 2025 PCPPI | WebAXIS Room Reservation System
</footer>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ========================
     SIDEBAR TOGGLE FIXED LOGIC
     ======================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const sidebar = document.querySelector(".sidebar");
    const content = document.querySelector(".content-area");
    const toggleBtn = document.getElementById("toggleSidebar");

    // Create overlay for mobile
    const overlay = document.createElement("div");
    overlay.id = "sidebar-overlay";
    overlay.style.cssText = `
        position: fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background: rgba(0,0,0,0.45);
        display:none;
        z-index:1500;
    `;
    document.body.appendChild(overlay);

    if (!sidebar || !toggleBtn) return;

    toggleBtn.addEventListener("click", () => {

        /* DESKTOP ≥992px -> collapse/expand */
        if (window.innerWidth >= 992) {
            sidebar.classList.toggle("collapsed");
            content.classList.toggle("shifted");
            return;
        }

        /* MOBILE <992px -> slide in/out */
        const isOpen = sidebar.classList.contains("open");

        if (isOpen) {
            sidebar.classList.remove("open");
            overlay.style.display = "none";
        } else {
            sidebar.classList.add("open");
            overlay.style.display = "block";
        }
    });

    /* Close sidebar when tapping outside (mobile only) */
    overlay.addEventListener("click", () => {
        sidebar.classList.remove("open");
        overlay.style.display = "none";
    });

});
</script>


<!-- ========================
     THEME TOGGLE
     ======================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const body = document.body;
    const themeBtn = document.getElementById("toggleTheme");
    const themeIcon = document.getElementById("themeIcon");

    if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark-mode");
        themeIcon.classList.replace("bi-moon", "bi-sun");
    }

    themeBtn.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        const isDark = body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        themeIcon.classList.toggle("bi-moon");
        themeIcon.classList.toggle("bi-sun");
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* Create pull-to-refresh indicator */
    const ptr = document.createElement("div");
    ptr.id = "ptr-indicator";
    ptr.innerHTML = "<i class='bi bi-arrow-repeat'></i>";
    document.body.appendChild(ptr);

    let startY = 0;
    let currentY = 0;
    let pulling = false;
    let threshold = 70;  // pull distance to refresh

    /* Only enable on mobile */
    function isMobile() {
        return window.innerWidth < 992;
    }

    /* Touch start */
    window.addEventListener("touchstart", (e) => {
        if (!isMobile()) return;

        if (window.scrollY === 0) {
            startY = e.touches[0].pageY;
            pulling = true;
        }
    });

    /* Touch move */
    window.addEventListener("touchmove", (e) => {
        if (!pulling || !isMobile()) return;

        currentY = e.touches[0].pageY;
        let pullDistance = currentY - startY;

        if (pullDistance > 0) {
            ptr.style.top = Math.min(pullDistance - 60, 20) + "px";
            ptr.style.opacity = Math.min(pullDistance / threshold, 1);
        }
    });

    /* Touch end */
    window.addEventListener("touchend", () => {
        if (!pulling || !isMobile()) return;

        let pullDistance = currentY - startY;

        if (pullDistance > threshold) {
            ptr.classList.add("active");

            /* Refresh page */
            setTimeout(() => {
                location.reload();
            }, 300);

        } else {
            ptr.style.top = "-60px";
            ptr.style.opacity = "0";
        }

        pulling = false;
    });

});
</script>

{% block scripts %}{% endblock %}
</body>
</html>
