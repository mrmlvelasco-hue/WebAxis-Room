{% extends "base_dashboard.html" %}
{% block title %}Room Maintenance | WebAXIS{% endblock %}

{% block content %}
<style>
  /* Custom Styles for Polish */
  .filter-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
  }
  .table thead th {
    background-color: #f1f4f9;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05rem;
    color: #555;
    border-top: none;
  }
  .sortable { cursor: pointer; transition: background 0.2s; }
  .sortable:hover { background-color: #e2e6ea !important; }
  .feature-tag {
    font-size: 0.8rem;
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
    margin: 1px;
  }
</style>

<div class="container-fluid py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold text-dark mb-0">Room Maintenance</h3>
      <p class="text-muted small mb-0">Manage physical spaces, capacities, and approval workflows.</p>
    </div>
    <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addRoomModal">
      <i class="bi bi-plus-lg me-1"></i> Add New Room
    </button>
  </div>

  <div class="card filter-card p-3 shadow-sm mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-bold small text-uppercase">Search</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input id="searchFilter" type="text" class="form-control" placeholder="Room name, group, features...">
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-bold small text-uppercase">Location</label>
        <select id="locationFilter" class="form-select form-select-sm">
          <option value="all">All Locations</option>
          {% for loc in rooms|map(attribute='location')|unique %}
            <option value="{{ loc }}">{{ loc }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-bold small text-uppercase">Status</label>
        <select id="statusFilter" class="form-select form-select-sm">
          <option value="all">All Status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label fw-bold small text-uppercase">Combined</label>
        <select id="combinedFilter" class="form-select form-select-sm">
          <option value="all">Any Type</option>
          <option value="Yes">Combined</option>
          <option value="No">Single</option>
        </select>
      </div>

      <div class="col-md-2">
        <button id="filterResetBtn" class="btn btn-outline-secondary btn-sm w-100">
          <i class="bi bi-arrow-counterclockwise"></i> Reset Filters
        </button>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="roomTable">
        <thead>
          <tr>
            <th data-col="0" class="sortable px-3">ID <i class="bi bi-arrow-down-up ms-1 small opacity-50"></i></th>
            <th data-col="1" class="sortable">Name</th>
            <th data-col="2" class="sortable">Location</th>
            <th data-col="3" class="sortable">Group</th>
            <th data-col="4" class="sortable">Cap.</th>
            <th data-col="5">Features</th>
            <th data-col="7" class="sortable text-center">Combined</th>
            <th data-col="8" class="sortable text-center">Status</th>
            <th class="text-end px-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rooms %}
          <tr>
            <td class="px-3"><span class="text-muted fw-medium">#{{ r.id }}</span></td>
            <td><span class="fw-bold text-dark">{{ r.name }}</span></td>
            <td><i class="bi bi-geo-alt me-1 text-muted"></i>{{ r.location or '—' }}</td>
            <td><code>{{ r.group_code or '—' }}</code></td>
            <td><span class="badge bg-light text-dark border">{{ r.capacity or 0 }}</span></td>
            <td>
              <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                   title="{{ r.features }}">
                {{ r.features or '—' }}
              </div>
            </td>
            <td class="text-center">
              {% if r.is_combined %}
                <span class="badge rounded-pill bg-info-subtle text-info border border-info">Yes</span>
              {% else %}
                <span class="badge rounded-pill bg-light text-muted border">No</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if r.status == 'Active' %}
                <span class="badge bg-success-subtle text-success border border-success">Active</span>
              {% else %}
                <span class="badge bg-danger-subtle text-danger border border-danger">Inactive</span>
              {% endif %}
            </td>
            <td class="text-end px-3">
              <div class="btn-group">
                <button class="btn btn-white btn-sm border" data-bs-toggle="modal" data-bs-target="#editModal{{ r.id }}">
                  <i class="bi bi-pencil"></i>
                </button>
                <a href="{{ url_for('deactivate_room', id=r.id) }}" class="btn btn-white btn-sm border text-danger">
                  <i class="bi bi-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div id="noResults" class="text-center py-5 d-none">
        <i class="bi bi-search display-4 text-muted"></i>
        <p class="mt-2 text-muted">No rooms match your current filters.</p>
      </div>
    </div>
  </div>
</div>
<!-- ADD ROOM MODAL -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <form class="modal-content shadow" method="post" action="{{ url_for('add_room') }}">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-semibold"><i class="bi bi-plus-circle me-2"></i>Add Room</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <div class="col-12">
            <label class="form-label fw-semibold">Room Name</label>
            <input name="name" class="form-control form-control-sm" required>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Location</label>
            <input name="location" class="form-control form-control-sm" required>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Group Code</label>
            <input name="group_code" class="form-control form-control-sm">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Capacity</label>
            <input name="capacity" type="number" class="form-control form-control-sm">
          </div>
          <div class="col-12">
              <label class="form-label fw-semibold">Features</label>
              <textarea name="features"
                        class="form-control form-control-sm"
                        rows="3"
                        placeholder="Example:
            • Projector
            • 65-inch TV
            • HDMI Port
            • Whiteboard"></textarea>
            </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Approval Required</label>
            <select name="approvals_required" class="form-select form-select-sm">
              <option value="auto">Auto</option>
              <option value="yes">Yes — Require Approval</option>
              <option value="no">No — Auto Approve</option>
            </select>
          </div>

          <div class="col-12">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="is_combined">
              <label class="form-check-label fw-semibold">Is Combined</label>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer justify-content-end">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary fw-semibold">Add</button>
      </div>
    </form>
  </div>
</div>


<!-- EDIT ROOM MODALS (ALL MOVED BELOW TABLE) -->
{% for r in rooms %}
<div class="modal fade" id="editModal{{ r.id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <form class="modal-content shadow" method="post" action="{{ url_for('edit_room', id=r.id) }}">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-semibold">
          <i class="bi bi-pencil-square me-2"></i>Edit Room
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <div class="col-12">
            <label class="form-label fw-semibold">Room Name</label>
            <input name="name" value="{{ r.name }}" class="form-control form-control-sm" required>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Location</label>
            <input name="location" value="{{ r.location }}" class="form-control form-control-sm">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Group Code</label>
            <input name="group_code" value="{{ r.group_code }}" class="form-control form-control-sm">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Capacity</label>
            <input name="capacity" type="number" value="{{ r.capacity }}" class="form-control form-control-sm">
          </div>
          <div class="col-12">
          <label class="form-label fw-semibold">Features</label>
          <textarea name="features"
                    class="form-control form-control-sm"
                    rows="3"
                    placeholder="Room features...">{{ r.features }}</textarea>
        </div>


          <div class="col-md-6">
            <label class="form-label fw-semibold">Approval Required</label>
            <select name="approvals_required" class="form-select form-select-sm">
              <option value="auto" {% if r.approvals_required == 'auto' %}selected{% endif %}>Auto</option>
              <option value="true" {% if r.approvals_required == 'yes' %}selected{% endif %}>Yes</option>
              <option value="no" {% if r.approvals_required == 'no' %}selected{% endif %}>No</option>
            </select>
          </div>

          <div class="col-12">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="is_combined"
                     {% if r.is_combined %}checked{% endif %}>
              <label class="form-check-label fw-semibold">Is Combined</label>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Status</label>
            <select name="status" class="form-select form-select-sm">
              <option value="Active" {% if r.status == 'Active' %}selected{% endif %}>Active</option>
              <option value="Inactive" {% if r.status == 'Inactive' %}selected{% endif %}>Inactive</option>
            </select>
          </div>

        </div>
      </div>

      <div class="modal-footer justify-content-end">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary fw-semibold">Save</button>
      </div>

    </form>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchFilter");
  const locationFilter = document.getElementById("locationFilter");
  const statusFilter = document.getElementById("statusFilter");
  const combinedFilter = document.getElementById("combinedFilter");
  const resetBtn = document.getElementById("filterResetBtn");
  const rows = document.querySelectorAll("#roomTable tbody tr");
  const noResults = document.getElementById("noResults");

  function applyFilters() {
    const searchVal = searchInput.value.toLowerCase();
    const locVal = locationFilter.value.toLowerCase();
    const statusVal = statusFilter.value.toLowerCase();
    const combinedVal = combinedFilter.value.toLowerCase();
    let visibleCount = 0;

    rows.forEach(row => {
      const cols = row.querySelectorAll("td");
      const name = cols[1].innerText.toLowerCase();
      const loc = cols[2].innerText.toLowerCase();
      const group = cols[3].innerText.toLowerCase();
      const features = cols[5].innerText.toLowerCase();
      const combined = cols[6].innerText.toLowerCase(); // 'Yes' or 'No'
      const status = cols[7].innerText.toLowerCase();

      let show = true;

      if (searchVal && !`${name} ${group} ${features}`.includes(searchVal)) show = false;
      if (locVal !== "all" && !loc.includes(locVal)) show = false;
      if (statusVal !== "all" && status !== statusVal) show = false;
      if (combinedVal !== "all" && combined !== combinedVal) show = false;

      row.style.display = show ? "" : "none";
      if(show) visibleCount++;
    });

    noResults.classList.toggle("d-none", visibleCount > 0);
  }

  // Event Listeners
  [searchInput, locationFilter, statusFilter, combinedFilter].forEach(el => {
    el.addEventListener(el.tagName === 'INPUT' ? 'input' : 'change', applyFilters);
  });

  resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    locationFilter.value = "all";
    statusFilter.value = "all";
    combinedFilter.value = "all";
    applyFilters();
  });
});
</script>
{% endblock %}