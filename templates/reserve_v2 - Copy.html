{% extends "base_dashboard.html" %}
{% block title %}Reserve Room | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid py-2">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h3 mb-1 fw-bold text-dark"><i class="bi bi-calendar-plus text-primary me-2"></i>Reserve Room</h2>
      <p class="text-muted small mb-0">Schedule your meetings and manage room availability.</p>
    </div>
    <a href="{{ url_for('room_list') }}" class="btn btn-outline-secondary btn-sm shadow-sm">
      <i class="bi bi-arrow-left"></i> Back to Rooms
    </a>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h6 class="card-title mb-0 fw-bold text-uppercase small tracking-wider">
            <i class="bi bi-info-circle me-2 text-primary"></i>1. Room Selection & Timing
          </h6>
        </div>
        <div class="card-body bg-light-50">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold small">Location</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-white"><i class="bi bi-geo-alt"></i></span>
                <select id="locationSelect" class="form-select" required>
                  <option value="" selected disabled>Select location...</option>
                  {% for loc in locations %}
                    <option value="{{ loc|e }}">{{ loc }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold small">Room Name</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-white"><i class="bi bi-door-closed"></i></span>
                <select id="roomSelect" class="form-select" required disabled>
                  <option value="" selected disabled>Select room...</option>
                </select>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold small">Room Features</label>
              <textarea id="featuresBox" class="form-control form-control-sm bg-white" rows="2" readonly
                        placeholder="Select a room to view its equipment and capacity..."></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold small">Start Time</label>
              <input id="start_time" name="start_time" type="datetime-local" class="form-control form-control-sm" step="1800" required>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold small">End Time</label>
              <input id="end_time" name="end_time" type="datetime-local" class="form-control form-control-sm" required>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h6 class="card-title mb-0 fw-bold text-uppercase small tracking-wider">
            <i class="bi bi-pencil-square me-2 text-primary"></i>2. Meeting Title
          </h6>
        </div>
        <div class="card-body">
          <form id="reserveV2Form" method="POST" action="#">
            <div class="mb-3">
              <textarea name="remarks" id="remarks" class="form-control" rows="3" placeholder="What is this meeting about? (e.g. Project Sync, Client Interview)"></textarea>
            </div>

            <input type="hidden" name="reserved_by" id="reserved_by_hidden" value="{{ current_user.display_name or current_user.username }}">
            <input type="hidden" name="email" id="email_hidden" value="{{ current_user.email or '' }}">

            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
              <div id="statusBadgeContainer">
                <span class="badge bg-secondary-subtle text-secondary border px-3 py-2" id="uiStatusBadge">
                  <i class="bi bi-circle-fill me-1 small"></i> Waiting for selection
                </span>
              </div>
              <div class="d-flex gap-2">
                <a href="#" class="btn btn-outline-primary" id="viewCalendarBtn" style="display:none;">
                  <i class="bi bi-calendar3"></i> View Full Calendar
                </a>
                <button type="submit" class="btn btn-primary px-4 shadow-sm fw-bold" id="submitBtn" disabled>
                  Confirm Reservation <i class="bi bi-chevron-right ms-1"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body text-center py-4">
          <div class="avatar-placeholder rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-size: 1.5rem;">
            {{ (current_user.display_name or current_user.username)[0] | upper }}
          </div>
          <h6 class="fw-bold mb-1">{{ current_user.display_name or current_user.username }}</h6>
          <p class="text-muted small mb-0"><i class="bi bi-envelope me-1"></i> {{ current_user.email or 'N/A' }}</p>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h6 class="card-title mb-0 fw-bold text-uppercase small tracking-wider">
            <i class="bi bi-repeat me-2 text-primary"></i>Recurrence
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label fw-semibold small">Frequency</label>
            <select class="form-select form-select-sm border-dashed" name="repeat_rule" id="repeat_rule">
              <option value="none" selected>One-time event</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>

          <div id="weeklyOptions" class="p-2 bg-light rounded mb-3" style="display:none;">
            <label class="form-label fw-semibold small d-block mb-2 text-center">Repeat on</label>
            <div class="d-flex justify-content-between px-1">
              {% for day, code in [('M','MO'), ('T','TU'), ('W','WE'), ('T','TH'), ('F','FR'), ('S','SA'), ('S','SU')] %}
              <div class="text-center">
                <input type="checkbox" class="btn-check" id="dow{{code}}" value="{{code}}">
                <label class="btn btn-outline-primary btn-sm rounded-circle p-0" for="dow{{code}}" style="width: 32px; height: 32px; line-height: 30px;">{{day}}</label>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="mt-3 pt-3 border-top">
            <label class="form-label fw-semibold small mb-2">Ends</label>
            <div class="vstack gap-2">
              <div class="form-check custom-radio-card p-2 border rounded">
                <input class="form-check-input ms-0 me-2" type="radio" name="repeat_ends" id="endsNever" value="never" checked>
                <label class="form-check-label small" for="endsNever">Ongoing</label>
              </div>

              <div class="form-check custom-radio-card p-2 border rounded">
                <div class="d-flex align-items-center gap-2">
                  <input class="form-check-input ms-0 me-2" type="radio" name="repeat_ends" id="endsOn" value="on">
                  <label class="form-check-label small me-auto" for="endsOn">On Date</label>
                  <input type="date" class="form-control form-control-sm w-50" id="endsOnDate" disabled>
                </div>
              </div>

              <div class="form-check custom-radio-card p-2 border rounded">
                <div class="d-flex align-items-center gap-2">
                  <input class="form-check-input ms-0 me-2" type="radio" name="repeat_ends" id="endsAfter" value="after">
                  <label class="form-check-label small me-auto" for="endsAfter">After</label>
                  <div class="input-group input-group-sm w-50">
                    <input type="number" min="1" class="form-control" id="endsAfterCount" disabled>
                    <span class="input-group-text">times</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mt-4 overflow-hidden">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <div class="fw-bold text-uppercase small tracking-wider">
        <i class="bi bi-grid-3x3-gap text-primary me-2"></i>Live Availability Grid
      </div>
      <button type="button" class="btn btn-sm btn-light border text-primary" onclick="refreshAvailability()">
        <i class="bi bi-arrow-clockwise"></i> Sync View
      </button>
    </div>
    <div class="card-body p-0 bg-dark-subtle">
      <iframe id="availabilityFrame" src="" style="width:100%; height:450px; border:0; display:block;"></iframe>
    </div>
  </div>
</div>

<div class="modal fade" id="reserveSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    <div class="modal-content border-0 shadow-lg p-4 text-center">
      <div class="modal-body">
        <div class="mb-4">
          <div class="success-icon-circle mx-auto d-flex align-items-center justify-content-center">
             <i class="bi bi-check-lg display-4 text-success"></i>
          </div>
        </div>

        <h3 class="fw-bold text-dark mb-2" style="font-size: 1.75rem;">Reservation Submitted</h3>
        <p class="text-muted mb-4" id="reserveSuccessMetaText">1 reservations created.</p>

        <div class="d-grid px-5">
          <button type="button" class="btn btn-primary btn-lg rounded-pill fw-bold py-2 shadow-sm" data-bs-dismiss="modal" onclick="refreshAvailability()">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/** ----- Utilities for <input type="datetime-local"> ----- **/

function toDatetimeLocalValue(d) {
  // Format: YYYY-MM-DDTHH:MM (local time, no seconds)
  const pad = (n) => String(n).padStart(2, '0');
  const year = d.getFullYear();
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hours = pad(d.getHours());
  const minutes = pad(d.getMinutes());
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function fromDatetimeLocalValue(val) {
  // Accepts "YYYY-MM-DDTHH:MM" (or with seconds) as local time
  if (!val) return null;
  const [datePart, timePart] = val.split('T');
  if (!datePart || !timePart) return null;
  const [y, m, d] = datePart.split('-').map(Number);
  const [hh, mm = '0'] = timePart.split(':');
  const dt = new Date(y, Number(m) - 1, Number(d), Number(hh), Number(mm), 0, 0);
  return isNaN(dt.getTime()) ? null : dt;
}

/** ----- Custom rounding: [00..14]->:00, [15..30]->:30, [31..59]->next hour ----- **/
function roundHour_00_30_60(dt) {
  const d = new Date(dt.getTime());
  const m = d.getMinutes();

  if (m <= 14) {
    // 00..14 -> :00 of same hour
    d.setMinutes(0, 0, 0);
  } else if (m <= 30) {
    // 15..30 -> :30 of same hour (30 inclusive)
    d.setMinutes(30, 0, 0);
  } else {
    // 31..59 -> :00 of next hour
    d.setMinutes(0, 0, 0);
    d.setHours(d.getHours() + 1);
  }
  return d;
}

/** ----- Wire up your Start/End inputs ----- **/
(function wireDatetimeInputs() {
  const startInput = document.getElementById('start_time');
  const endInput   = document.getElementById('end_time');

  function applySnap(inputEl) {
    if (!inputEl.value) return null;
    const dt = fromDatetimeLocalValue(inputEl.value);
    if (!dt) return null;
    const snapped = roundHour_00_30_60(dt);
    const newVal = toDatetimeLocalValue(snapped);
    if (newVal !== inputEl.value) inputEl.value = newVal;
    return snapped;
  }

  function enforceOrder() {
    // Ensure end >= start (optional)
    const s = fromDatetimeLocalValue(startInput.value);
    const e = fromDatetimeLocalValue(endInput.value);
    if (s && e && e < s) {
      endInput.value = toDatetimeLocalValue(s);
    }
  }

  const onCommit = () => {
    applySnap(startInput);
    applySnap(endInput);
    enforceOrder();
  };

  // Round on change and blur
  startInput.addEventListener('change', onCommit);
  startInput.addEventListener('blur', onCommit);
  endInput.addEventListener('change', onCommit);
  endInput.addEventListener('blur', onCommit);

  // Optional: match both spinners to 30-min steps (you already set Start to 1800)
  if (!endInput.hasAttribute('step')) {
    endInput.setAttribute('step', String(1800)); // 1800 sec = 30 minutes
  }
})();
</script>

<script>
  // Rooms data from server
  const ROOMS = {{ rooms_json | safe }};

  const locationSelect = document.getElementById('locationSelect');
  const roomSelect = document.getElementById('roomSelect');
  const featuresBox = document.getElementById('featuresBox');
  const form = document.getElementById('reserveV2Form');
  const submitBtn = document.getElementById('submitBtn');
  const viewCalendarBtn = document.getElementById('viewCalendarBtn');

  let selectedLocation = null;
  let selectedRoomName = null;

  const startInput = document.getElementById('start_time');
  const endInput = document.getElementById('end_time');

  // repeat UI
  const repeatRule = document.getElementById('repeat_rule');
  const weeklyOptions = document.getElementById('weeklyOptions');
  const endsNever = document.getElementById('endsNever');
  const endsOn = document.getElementById('endsOn');
  const endsAfter = document.getElementById('endsAfter');
  const endsOnDate = document.getElementById('endsOnDate');
  const endsAfterCount = document.getElementById('endsAfterCount');

  function resetRoomSelect() {
    roomSelect.innerHTML = '<option value="" selected disabled>Select room...</option>';
    roomSelect.disabled = true;
    featuresBox.value = '';
    form.action = '#';
    submitBtn.disabled = true;
    selectedRoomName = null;
    updateCalendarLink();
  }

  function todayStr() {
    const d = new Date();
    return d.toISOString().split('T')[0];
  }

  function updateCalendarLink() {
    if (!viewCalendarBtn) return;
    if (!selectedLocation) {
      viewCalendarBtn.style.display = 'none';
      viewCalendarBtn.href = '#';
      return;
    }
    const params = new URLSearchParams();
    params.set('location', selectedLocation);
    params.set('date', todayStr());
    if (selectedRoomName) params.set('room', selectedRoomName);
    viewCalendarBtn.href = `/calendar_view?${params.toString()}`;
    viewCalendarBtn.style.display = '';
  }

  function populateRoomsForLocation(loc) {
    const filtered = ROOMS.filter(r => (r.location || 'General') === loc);
    roomSelect.innerHTML = '<option value="" selected disabled>Select room...</option>';

    if (filtered.length > 0) {
      filtered.forEach(r => {
        const opt = document.createElement('option');
        opt.value = String(r.id);
        opt.textContent = r.name;
        opt.dataset.features = r.features || '';
        roomSelect.appendChild(opt);
      });
      roomSelect.disabled = false;
    } else {
      roomSelect.disabled = true;
    }

    featuresBox.value = '';
    form.action = '#';
    submitBtn.disabled = true;
  }

  locationSelect.addEventListener('change', () => {
    const loc = locationSelect.value;
    if (!loc) {
      resetRoomSelect();
      return;
    }
    selectedLocation = loc;
    selectedRoomName = null;
    populateRoomsForLocation(loc);
    updateCalendarLink();
    if (typeof refreshAvailability === "function") refreshAvailability();
  });

  roomSelect.addEventListener('change', () => {
    const roomId = roomSelect.value;
    if (!roomId) {
      featuresBox.value = '';
      form.action = '#';
      submitBtn.disabled = true;
      selectedRoomName = null;
      updateCalendarLink();
      return;
    }

    const selected = roomSelect.options[roomSelect.selectedIndex];
    featuresBox.value = selected.dataset.features || '';
    selectedRoomName = selected.textContent || null;
    updateCalendarLink();

    form.action = `/reserve_post/${roomId}`;
    submitBtn.disabled = false;

    if (typeof refreshAvailability === "function") refreshAvailability();

    const statusBadge = document.getElementById('uiStatusBadge');
    if (statusBadge) {
        statusBadge.className = "badge bg-success-subtle text-success border border-success-subtle px-3 py-2";
        statusBadge.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i> Room Ready: ${selected.textContent}`;
    }
  });

  function validateTimes() {
    if (!startInput.value || !endInput.value) return;
    if (endInput.value < startInput.value) {
      endInput.setCustomValidity('End must be after start');
    } else {
      endInput.setCustomValidity('');
    }
  }

  startInput.addEventListener('change', validateTimes);
  endInput.addEventListener('change', validateTimes);

  repeatRule.addEventListener('change', () => {
    weeklyOptions.style.display = (repeatRule.value === 'weekly') ? '' : 'none';
  });

  function syncEndsInputs() {
    if(endsOnDate) endsOnDate.disabled = !endsOn.checked;
    if(endsAfterCount) endsAfterCount.disabled = !endsAfter.checked;
  }

  [endsNever, endsOn, endsAfter].forEach(el => {
    if(el) el.addEventListener('change', syncEndsInputs);
  });
  syncEndsInputs();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!roomSelect.value || !startInput.value || !endInput.value) {
      alert('Please select a room and provide valid dates/times.');
      return;
    }

    const actionUrl = form.action;
    if (actionUrl === "" || actionUrl === "#") {
      alert("Error: Room not properly selected.");
      return;
    }

    const fd = new FormData(form);
    fd.append('start_time', startInput.value);
    fd.append('end_time', endInput.value);

    submitBtn.disabled = true;
    const originalContent = submitBtn.innerHTML;
    submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;

    try {
      const res = await fetch(actionUrl, {
        method: "POST",
        body: fd,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      let data;
      const contentType = res.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        data = await res.json();
      } else {
        const text = await res.text();
        data = { success: res.ok, message: text };
      }

      if (res.ok && (data.success || data.status === "success")) {
        const mainTitle = "Reservation Submitted";
        const subText = data.created_count != null
            ? `${data.created_count} reservations created.`
            : "Your booking has been confirmed.";

        const titleEl = document.getElementById("reserveSuccessText");
        const metaEl = document.getElementById("reserveSuccessMetaText");

        if (titleEl) titleEl.textContent = mainTitle;
        if (metaEl) metaEl.textContent = subText;

        const modalElem = document.getElementById('reserveSuccessModal');
        if (modalElem && typeof bootstrap !== 'undefined') {
            const bsModal = new bootstrap.Modal(modalElem);
            bsModal.show();
        } else {
            alert(`${mainTitle}\n${subText}`);
        }

        if (typeof refreshAvailability === "function") refreshAvailability();
      } else {
        throw new Error(data.message || data.error || "System encountered an error.");
      }
    } catch (err) {
      console.error("Submission error:", err);
      const errorTextEl = document.getElementById("reserveErrorText");
      if (errorTextEl) errorTextEl.textContent = err.message;

      const errorModalElem = document.getElementById('reserveErrorModal');
      if (errorModalElem && typeof bootstrap !== 'undefined') {
        const bsErrorModal = new bootstrap.Modal(errorModalElem);
        bsErrorModal.show();
      } else {
        alert("Error: " + err.message);
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalContent;
    }
  }); // ✅ Fixed: Added missing closing brace and parenthesis
</script>

<script>
function getSelectedDateForGrid(){
  // Use Start date for the grid
  const startVal = document.getElementById("start_time")?.value || "";
  if (!startVal) return "";

  // datetime-local: "2026-02-19T08:00"
  const d = new Date(startVal);
  if (isNaN(d.getTime())) return "";

  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function getSelectedRoomName(){
  const sel = document.getElementById("roomSelect");
  if (!sel || sel.disabled) return "all";
  const opt = sel.options[sel.selectedIndex];
  if (!opt || !opt.textContent || opt.value === "") return "all";
  // opt.textContent is the room name (what calendar_view_v2 expects)
  return opt.textContent.trim();
}
function snapTo30Min(hhmm) {
  // hhmm: "17:58"
  const [hh, mm] = hhmm.split(":").map(Number);
  if (Number.isNaN(hh) || Number.isNaN(mm)) return "";

  const total = hh * 60 + mm;

  // round to nearest 30 mins (change to floor if you prefer)
  const snapped = Math.round(total / 30) * 30;

  const H = String(Math.floor(snapped / 60)).padStart(2, "0");
  const M = String(snapped % 60).padStart(2, "0");
  return `${H}:${M}`;
}

function refreshAvailability() {
  const loc = document.getElementById("locationSelect")?.value || "all";

  // calendar_view_v2 expects ROOM NAME (not id)
  const roomSel = document.getElementById("roomSelect");
  let roomName = "all";
  if (roomSel && roomSel.value) {
    const opt = roomSel.options[roomSel.selectedIndex];
    if (opt && opt.textContent) roomName = opt.textContent.trim();
  }

  const startVal = document.getElementById("start_time")?.value || "";

  const date = startVal && startVal.includes("T")
    ? startVal.split("T")[0]
    : new Date().toISOString().slice(0,10);

  // ✅ FIXED SECTION
  let focus = "";
  if (startVal && startVal.includes("T")) {
    const focusRaw = startVal.split("T")[1].slice(0,5); // HH:MM
    focus = snapTo30Min(focusRaw);
  }

  const url = `/calendar_view_v2?embed=1`
    + `&date=${encodeURIComponent(date)}`
    + `&location=${encodeURIComponent(loc || "all")}`
    + `&room=${encodeURIComponent(roomName)}`
    + (focus ? `&focus=${encodeURIComponent(focus)}` : "");

  const frame = document.getElementById("availabilityFrame");
  console.log("Availability URL:", url);
  if (frame) frame.src = url;
}

function wireAvailabilityAutoRefresh() {
  const loc = document.getElementById("locationSelect");
  const room = document.getElementById("roomSelect");
  const start = document.getElementById("start_time");
  const end = document.getElementById("end_time");

  if (loc) loc.addEventListener("change", refreshAvailability);
  if (room) room.addEventListener("change", refreshAvailability);

  // datetime-local: input fires immediately when user picks time/date
  if (start) {
    start.addEventListener("input", refreshAvailability);
    start.addEventListener("change", refreshAvailability);
  }
  if (end) {
    end.addEventListener("input", refreshAvailability);
    end.addEventListener("change", refreshAvailability);
  }

  refreshAvailability(); // initial load
}
document.addEventListener("DOMContentLoaded", wireAvailabilityAutoRefresh);
</script>

<style>
  /* Professional Modal Styling */
  #reserveSuccessModal .modal-content {
    border-radius: 20px; /* Softer corners like the image */
  }

  .success-icon-circle {
    width: 100px;
    height: 100px;
    background-color: #f0fff4; /* Light green tint */
    border: 3px solid #d1fae5; /* Very light border */
    border-radius: 50%;
  }

  /* Match the blue button exactly if needed */
  #reserveSuccessModal .btn-primary {
    background-color: #004dc5;
    border-color: #004dc5;
    transition: all 0.2s ease;
  }

  #reserveSuccessModal .btn-primary:hover {
    background-color: #003a94;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 77, 197, 0.2);
  }

  #reserveSuccessMetaText {
    font-size: 1.1rem;
    color: #6c757d;
  }
</style>
{% endblock %}
