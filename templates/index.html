{% extends "base_dashboard.html" %}
{% block title %}Meeting Room | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 border-end bg-light px-3 py-3">
      <h5 class="fw-bold text-primary mb-3">Meeting Room</h5>

      <!-- View Switch -->
      <div class="d-grid gap-2 mb-3">
        <a href="{{ url_for('room_list') }}" class="btn btn-primary fw-semibold">
          <i class="bi bi-grid-3x3-gap me-2"></i> Timeline View
        </a>
        <a href="{{ url_for('calendar_view') }}"
           class="btn btn-outline-primary fw-semibold {% if request.endpoint == 'calendar_view' %}active{% endif %}">
           <i class="bi bi-calendar3 me-2"></i> Calendar View
        </a>
      </div>

      <!-- Filter -->
      <div class="mb-3">
        <label class="fw-bold small text-muted mb-1">Filter by Group</label>
        <select id="locationFilter" class="form-select form-select-sm">
          <option value="all">All Locations</option>
          {% for r in rooms|groupby('location') %}
            <option value="{{ r.grouper }}">{{ r.grouper }}</option>
          {% endfor %}
        </select>
      </div>

      <hr>
      <h6 class="fw-bold small text-muted">Reservation Status</h6>
      <div class="small">
        <div><span class="badge bg-success me-1">&nbsp;</span> Available</div>
        <div><span class="badge bg-danger me-1">&nbsp;</span> Booked</div>
        <div><span class="badge bg-secondary me-1">&nbsp;</span> Past</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="card shadow-sm p-4 mb-4">
        <!-- Toolbar -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
          <div class="d-flex align-items-center">
            <h3 class="fw-bold mb-0 text-primary me-3">
              <i class="bi bi-door-open me-2"></i> Shared Resources
            </h3>
            <div class="d-flex align-items-center gap-2 small">
              <span><span class="badge bg-success me-1">&nbsp;</span> Available</span>
              <span><span class="badge bg-danger me-1">&nbsp;</span> Booked</span>
              <span><span class="badge bg-secondary me-1">&nbsp;</span> Past</span>
            </div>
          </div>
          <div class="d-flex align-items-center">
  <button id="refreshBtn" class="btn btn-outline-secondary btn-sm me-2">
    <i class="bi bi-arrow-clockwise"></i> Refresh
  </button>
  <button id="calendarSyncBtn" class="btn btn-outline-primary btn-sm me-2">
    <i class="bi bi-calendar-event"></i> Calendar View
  </button>
  <input type="date" id="viewDate" class="form-control form-control-sm"
         value="{{ selected_date.strftime('%Y-%m-%d') }}">
</div>

        </div>

        <!-- Room Slot Container -->
        <div class="slot-container mt-3">
          {% for room in rooms %}
          <div class="room-row mb-4" data-location="{{ room.location or 'General' }}">
            <!-- Header -->
            <div class="room-header d-flex justify-content-between align-items-center p-2 border rounded bg-light">
              <div>
                <strong>{{ room.name }}</strong>
                <small class="text-muted ms-2">(Capacity: {{ room.capacity }})</small>
                {% if room.location %}
                  <span class="badge bg-secondary ms-2">{{ room.location }}</span>
                {% endif %}
                {% if room.description %}
                  <div class="text-muted small">{{ room.description }}</div>
                {% endif %}
              </div>
              <button class="btn btn-sm btn-outline-primary reserve-btn"
                      data-room-id="{{ room.id }}" data-room-name="{{ room.name }}">
                <i class="bi bi-calendar-plus"></i> Reserve
              </button>
            </div>

            <!-- Timeline -->
            <div class="timeline d-flex flex-nowrap overflow-auto border rounded bg-white p-2 user-select-none"
                 data-room-id="{{ room.id }}">
              {% for hour in range(6, 20) %}
                {% for minute in [0, 30] %}
                  {% set time_label = "%02d:%02d"|format(hour, minute) %}
                  {% set status = availability.get(room.id, {}).get(time_label, "available") %}
                  <div class="slot-cell
                      {% if status == 'booked' %} bg-danger
                      {% elif status == 'available' %} bg-success
                      {% else %} bg-secondary {% endif %}
                      text-white m-1 p-2 rounded text-center flex-shrink-0 position-relative"
                       data-room-id="{{ room.id }}"
                       data-room-name="{{ room.name }}"
                       data-time="{{ time_label }}"
                       data-status="{{ status }}"
                       data-res-id="{{ availability.get(room.id, {}).get(time_label ~ '_id', '') }}"
                       style="cursor: pointer; min-width: 55px;"
                       title="{{ status|capitalize }}">
                    {{ time_label }}

                    {% if current_user.is_admin() and status == 'booked' %}
                      <button class="btn btn-sm btn-light text-danger cancel-btn position-absolute top-0 end-0 p-0 m-0"
                              style="width:18px; height:18px; line-height:1;"
                              data-room-id="{{ room.id }}"
                              data-room-name="{{ room.name }}"
                              data-time="{{ time_label }}"
                              title="Cancel this booking">
                        <i class="bi bi-x-lg" style="font-size:0.6rem;"></i>
                      </button>
                    {% endif %}
                  </div>
                {% endfor %}
              {% endfor %}
            </div>

          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reservation Modal -->
<div class="modal fade" id="newReservationModal" tabindex="-1" aria-labelledby="newReservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="reservationForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newReservationModalLabel">New Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalRoomId" name="room_id">
          <div class="mb-2">
            <label class="form-label">Room</label>
            <div id="modalRoomName" class="fw-semibold"></div>
          </div>
          <div class="row g-2">
            <div class="col-12">
              <label for="modalStartTime" class="form-label">Start</label>
              <input id="modalStartTime" name="start_time" type="datetime-local" class="form-control" required>
            </div>
            <div class="col-12">
              <label for="modalEndTime" class="form-label">End</label>
              <input id="modalEndTime" name="end_time" type="datetime-local" class="form-control" required>
            </div>
          </div>
          <div class="mt-2">
            <label for="modalReservedBy" class="form-label">Reserved By</label>
            <input id="modalReservedBy" name="reserved_by" type="text" class="form-control"
                   value="{{ current_user.display_name or current_user.username }}" required>
          </div>
          <div class="mt-2">
            <label for="modalEmail" class="form-label">Email</label>
            <input id="modalEmail" name="email" type="email" class="form-control"
                   value="{{ current_user.email or '' }}">
          </div>
          <div class="mt-2">
            <label for="modalRemarks" class="form-label">Remarks</label>
            <textarea id="modalRemarks" name="remarks" class="form-control" rows="2" placeholder="Optional"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Reservation</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('newReservationModal');
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('reservationForm');
  const locationFilter = document.getElementById('locationFilter');
  const viewDate = document.getElementById('viewDate');
  const today = new Date().toISOString().slice(0, 10);

  // === Preserve selected date across reloads ===
  if (localStorage.getItem("selectedDate")) {
    viewDate.value = localStorage.getItem("selectedDate");
  }
  viewDate.addEventListener("change", () => {
    localStorage.setItem("selectedDate", viewDate.value);
    updatePastSlots();
  });

  // === Helper: open reservation modal ===
  function openReserve(roomId, roomName, startTime, endTime) {
    document.getElementById('modalRoomId').value = roomId;
    document.getElementById('modalRoomName').textContent = roomName;
    document.getElementById('modalStartTime').value = startTime;
    document.getElementById('modalEndTime').value = endTime;
    form.action = `/reserve_post/${roomId}`;
    modal.show();
  }

  // === Helper: format datetime ===
  function formatLocalDate(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const h = String(dateObj.getHours()).padStart(2, '0');
    const min = String(dateObj.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${d}T${h}:${min}`;
  }

  // === Filter logic (persistent) ===
  const savedFilter = localStorage.getItem('roomFilter') || 'all';
  locationFilter.value = savedFilter;
  applyFilter();

  function applyFilter() {
    const selected = locationFilter.value;
    localStorage.setItem('roomFilter', selected);
    document.querySelectorAll('.room-row').forEach(r => {
      r.style.display = (selected === 'all' || r.dataset.location === selected) ? '' : 'none';
    });
  }
  locationFilter.addEventListener('change', applyFilter);

  // === Updated function to color past/booked slots ===
  function updatePastSlots() {
    const selectedDate = new Date(viewDate.value);
    const now = new Date();
    const todayStr = now.toISOString().slice(0, 10);
    const selectedStr = viewDate.value;

    document.querySelectorAll('.slot-cell').forEach(cell => {
      const slotDateTime = new Date(`${selectedStr}T${cell.dataset.time}:00`);
      const status = cell.dataset.status;

      cell.classList.remove('bg-success', 'bg-danger', 'bg-secondary');
      cell.style.pointerEvents = 'auto';

      // üü• Booked ‚Äî always red for any date
      if (status === 'booked') {
        cell.classList.add('bg-danger');
        cell.style.pointerEvents = 'none';
        cell.title = "Booked";
        return;
      }

      // ü©∂ Entire past day
      if (selectedStr < todayStr) {
        cell.classList.add('bg-secondary');
        cell.style.pointerEvents = 'none';
        cell.title = "Past";
        return;
      }

      // üìÖ Today ‚Äî gray past hours, green future
      if (selectedStr === todayStr) {
        if (slotDateTime < now) {
          cell.classList.add('bg-secondary');
          cell.style.pointerEvents = 'none';
          cell.title = "Past";
        } else {
          cell.classList.add('bg-success');
          cell.title = "Available";
        }
        return;
      }

      // üîÆ Future date
      if (selectedStr > todayStr) {
        cell.classList.add('bg-success');
        cell.title = "Available";
      }
    });
  }

  // === Initial call ===
  updatePastSlots();

  // === Date change triggers full refresh ===
  viewDate.addEventListener('change', () => {
    const selected = viewDate.value;
    window.location.href = `/rooms?date=${selected}`;
  });

  // === Refresh button keeps date ===
  document.getElementById('refreshBtn').addEventListener('click', () => {
    const selected = viewDate.value;
    window.location.href = `/rooms?date=${selected}`;
  });
  // === Calendar Sync Button ===
document.getElementById('calendarSyncBtn').addEventListener('click', () => {
  const selected = document.getElementById('viewDate').value;
  window.location.href = `/calendar_view?date=${selected}`;
});
// === Admin Cancel Button Handler ===
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".cancel-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation(); // prevent opening reservation modal

      const slot = btn.closest(".slot-cell");
      const resId = slot.dataset.resId || null;
      const roomName = slot.dataset.roomName;
      const time = slot.dataset.time;

      if (!resId) {
        Swal.fire({
          icon: "info",
          title: "Missing Reservation ID",
          text: "This booking could not be linked to a record.",
          confirmButtonColor: "#0047AB"
        });
        return;
      }

      const confirm = await Swal.fire({
        icon: "warning",
        title: "Cancel Reservation?",
        html: `<b>Room:</b> ${roomName}<br><b>Time:</b> ${time}`,
        showCancelButton: true,
        confirmButtonText: "Yes, Cancel It",
        cancelButtonText: "No",
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d"
      });

      if (!confirm.isConfirmed) return;

      try {
        const resp = await fetch(`/api/cancel_reservation/${resId}`, { method: "POST" });
        const data = await resp.json();

        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Cancelled!",
            text: data.message,
            confirmButtonColor: "#0047AB"
          });

          // ‚úÖ Update slot visually
          slot.classList.remove("bg-danger");
          slot.classList.add("bg-success");
          slot.dataset.status = "available";
          slot.title = "Available";

          // remove the ‚ùå button after cancel
          if (slot.querySelector(".cancel-btn")) slot.querySelector(".cancel-btn").remove();

        } else {
          Swal.fire({
            icon: "error",
            title: "Cancel Failed",
            text: data.message || "Unable to cancel reservation.",
            confirmButtonColor: "#0047AB"
          });
        }
      } catch (err) {
        console.error("‚ö†Ô∏è Cancel error:", err);
        Swal.fire({
          icon: "error",
          title: "System Error",
          text: "Failed to cancel reservation. Please try again.",
          confirmButtonColor: "#0047AB"
        });
      }
    });
  });
});

  // === Reapply color logic on every render ===
  window.addEventListener('pageshow', updatePastSlots);

  // === Drag, click, AJAX submit, cancel logic (keep your same code below) ===
  // ... (your drag & click handlers, AJAX submit, and cancel logic remain unchanged) ...
});
</script>


<style>
.border-end { border-right: 1px solid #dee2e6 !important; } .timeline::-webkit-scrollbar { height: 8px; } .timeline::-webkit-scrollbar-thumb { background-color: #0047AB; border-radius: 4px; } .slot-cell { font-size: 0.8rem; font-weight: 500; transition: all 0.2s ease; min-width: 55px; } .slot-cell:hover { transform: scale(1.05); border: 1px solid #0047AB; box-shadow: 0 0 5px rgba(0,71,171,0.3); } .slot-cell.selected { border: 2px solid #0047AB; background-color: #0b63ce !important; } .room-header { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.4rem; } .timeline { scroll-behavior: smooth; user-select: none; }

</style>

{% endblock %}
