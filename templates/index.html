{% extends "base_dashboard.html" %}
{% block title %}Room Reservation | WebAXIS{% endblock %}
{% block content %}
<div class="card shadow-sm p-4 mb-4">
<div class="d-flex justify-content-between align-items-center mb-3">
<h3 class="fw-bold mb-0">
<i class="bi bi-door-open"></i> Room Reservation
</h3>
<div>
<input type="date" id="viewDate" class="form-control form-control-sm" />
</div>
</div>
<!-- Room Slot Container -->
<div class="slot-container mt-3">
   {% for room in rooms %}
<div class="room-row mb-4">
<!-- Room Header -->
<div class="room-header d-flex justify-content-between align-items-center p-2 border rounded bg-light">
<div>
<strong>{{ room.name }}</strong>
<small class="text-muted ms-2">(Capacity: {{ room.capacity }})</small>
</div>
<button class="btn btn-sm btn-outline-primary"
               onclick="openQuickReserve({{ room.id }}, '{{ room.name }}')">
<i class="bi bi-calendar-plus"></i> Reserve
</button>
</div>
<!-- Time Slots -->
<div class="time-slots d-flex flex-wrap border rounded p-2 bg-white" data-room-id="{{ room.id }}">
       {% for hour in range(8, 20) %}
<div class="slot-cell bg-success text-white m-1 p-2 rounded text-center flex-fill"
            data-room-id="{{ room.id }}"
            data-room-name="{{ room.name }}"
            data-hour="{{ hour }}"
            style="cursor: pointer; min-width: 80px;"
            title="Click to reserve this time slot">
         {{ "%02d:00"|format(hour) }}
</div>
       {% endfor %}
</div>
</div>
   {% else %}
<p class="text-center text-muted">No rooms found.</p>
   {% endfor %}
</div>
</div>
<!-- Reservation Modal -->
<div class="modal fade" id="newReservationModal" tabindex="-1" aria-labelledby="newReservationModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<form id="reservationForm" method="POST">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="newReservationModalLabel">New Reservation</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<input type="hidden" id="modalRoomId" name="room_id">
<div class="mb-2">
<label class="form-label">Room</label>
<div id="modalRoomName" class="fw-semibold"></div>
</div>
<div class="row g-2">
<div class="col-12">
<label for="modalStartTime" class="form-label">Start</label>
<input id="modalStartTime" name="start_time" type="datetime-local" class="form-control" required>
</div>
<div class="col-12">
<label for="modalEndTime" class="form-label">End</label>
<input id="modalEndTime" name="end_time" type="datetime-local" class="form-control" required>
</div>
</div>
<div class="mt-2">
<label for="modalReservedBy" class="form-label">Reserved By</label>
<input id="modalReservedBy" name="reserved_by" type="text" class="form-control"
                  value="{{ current_user.display_name or current_user.username }}" required>
</div>
<div class="mt-2">
<label for="modalEmail" class="form-label">Email</label>
<input id="modalEmail" name="email" type="email" class="form-control"
                  value="{{ current_user.email or '' }}">
</div>
<div class="mt-2">
<label for="modalRemarks" class="form-label">Remarks</label>
<textarea id="modalRemarks" name="remarks" class="form-control" rows="2" placeholder="Optional"></textarea>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="submit" class="btn btn-primary" id="modalSubmitBtn">Submit Reservation</button>
</div>
</div>
</form>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
 const modalEl = document.getElementById('newReservationModal');
 const reservationForm = document.getElementById('reservationForm');
 const modalRoomName = document.getElementById('modalRoomName');
 const modalRoomId = document.getElementById('modalRoomId');
 const modalStartTime = document.getElementById('modalStartTime');
 const modalEndTime = document.getElementById('modalEndTime');
 const bsModal = new bootstrap.Modal(modalEl);
 const slotCells = document.querySelectorAll('.slot-cell');
 // Helper
 function pad2(n){ return String(n).padStart(2,'0'); }
 // Populate date input
 const viewDate = document.getElementById('viewDate');
 const today = new Date().toISOString().slice(0,10);
 if (viewDate) viewDate.value = today;
 // Disable past slots automatically
 const now = new Date();
 slotCells.forEach(cell => {
   const todayDate = new Date();
   const hour = parseInt(cell.dataset.hour);
   todayDate.setHours(hour, 0, 0, 0);
   if (todayDate < now) {
     cell.classList.remove('bg-success');
     cell.classList.add('bg-secondary');
     cell.style.pointerEvents = 'none';
     cell.title = 'Past time (unavailable)';
   }
 });
 // Handle slot click
 slotCells.forEach(cell => {
   cell.addEventListener('click', function () {
     const roomId = this.dataset.roomId;
     const roomName = this.dataset.roomName;
     const hour = Number(this.dataset.hour);
     const dateValue = viewDate.value || today;
     const start = `${dateValue}T${pad2(hour)}:00`;
     const end = `${dateValue}T${pad2(hour+1)}:00`;
     modalRoomName.textContent = roomName;
     modalRoomId.value = roomId;
     modalStartTime.value = start;
     modalEndTime.value = end;
     reservationForm.action = `/reserve/${roomId}`;
     bsModal.show();
   });
 });
 // Submit form with confirmation
 reservationForm.addEventListener('submit', function (e) {
   e.preventDefault();
   const start = new Date(modalStartTime.value);
   const end = new Date(modalEndTime.value);
   const now = new Date();
   if (start < now) {
     Swal.fire({ icon: 'warning', title: 'Invalid Start Time', text: 'Start time cannot be in the past.' });
     return;
   }
   if (end <= start) {
     Swal.fire({ icon: 'warning', title: 'Invalid End Time', text: 'End time must be after start time.' });
     return;
   }
   Swal.fire({
     title: 'Confirm Reservation',
     html: `<b>${modalRoomName.textContent}</b><br>${start.toLocaleString()} - ${end.toLocaleString()}`,
     icon: 'question',
     showCancelButton: true,
     confirmButtonText: 'Confirm',
     cancelButtonText: 'Cancel',
     confirmButtonColor: '#0047AB'
   }).then(result => {
     if (result.isConfirmed) {
       Swal.fire({
         icon: 'success',
         title: 'Reservation Submitted!',
         text: 'Your reservation has been sent for approval.',
         showConfirmButton: false,
         timer: 1500
       });
       setTimeout(() => reservationForm.submit(), 1400);
     }
   });
 });
});
</script>
<!-- Optional CSS for slot layout (can also go to style_dashboard.css) -->
<style>
.slot-container {
 display: flex;
 flex-direction: column;
 gap: 1rem;
}
.room-header {
 background-color: #f8f9fa;
 border: 1px solid #dee2e6;
 border-radius: 0.4rem;
}
.time-slots {
 display: flex;
 flex-wrap: wrap;
 align-items: center;
}
.slot-cell {
 flex: 1 1 6rem;
 text-align: center;
 font-size: 0.85rem;
 border-radius: 0.25rem;
 transition: all 0.2s ease;
 border: 1px solid transparent;
}
.slot-cell.bg-success {
 background-color: #198754 !important; /* Available */
}
.slot-cell.bg-danger {
 background-color: #dc3545 !important; /* Booked */
}
.slot-cell.bg-secondary {
 background-color: #6c757d !important; /* Past */
}
.slot-cell:hover {
 transform: scale(1.05);
 border: 1px solid #0047AB;
 box-shadow: 0 0 5px rgba(0, 71, 171, 0.3);
}
</style>
{% endblock %}