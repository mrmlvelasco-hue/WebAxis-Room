{% extends "base_dashboard.html" %}
{% block title %}Meeting Room | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
<!--    <div class="col-md-3 col-lg-2 border-end bg-light px-3 py-3">-->
      <div class="col-md-3 col-lg-2 border-end bg-light px-3 py-3 page-left-panel">
      <h5 class="fw-bold text-primary mb-3">Meeting Room</h5>

      <div class="d-grid gap-2 mb-3">
        <a href="{{ url_for('room_list') }}" class="btn btn-primary fw-semibold">
          <i class="bi bi-grid-3x3-gap me-2"></i> Timeline View
        </a>
        <a href="#" id="sidebarCalendarBtn" class="btn btn-outline-primary fw-semibold">
          <i class="bi bi-calendar3 me-2"></i> Calendar View
        </a>
      </div>

      <div class="mb-3">
        <label class="fw-bold small text-muted mb-1">Filter by Group</label>
        <select id="locationFilter" class="form-select form-select-sm">
          <option value="all">All Locations</option>
          {% for r in rooms|groupby('location') %}
            <option value="{{ r.grouper }}">{{ r.grouper }}</option>
          {% endfor %}
        </select>
      </div>

      <hr>
      <h6 class="fw-bold small text-muted">Reservation Status</h6>
      <div class="small">
        <div><span class="badge bg-success me-1">&nbsp;</span> Available</div>
        <div><span class="badge bg-danger me-1">&nbsp;</span> Booked</div>
        <div><span class="badge bg-secondary me-1">&nbsp;</span> Past</div>
        <div><span class="badge bg-warning me-1">&nbsp;</span> Pending</div>
      </div>
    </div>

    <div class="col-md-9 col-lg-10">
      <div class="card shadow-sm p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
          <div class="d-flex align-items-center">
            <h3 class="fw-bold mb-0 text-primary me-3">
              <i class="bi bi-door-open me-2"></i> Shared Resources
            </h3>
          </div>
          <div class="d-flex align-items-center">
            <button id="refreshBtn" class="btn btn-outline-secondary btn-sm me-2">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button id="calendarSyncBtn" class="btn btn-outline-primary btn-sm me-2">
              <i class="bi bi-calendar-event"></i> Calendar View
            </button>
            <input type="date" id="viewDate" class="form-control form-control-sm"
                   value="{{ selected_date.strftime('%Y-%m-%d') }}">
          </div>
        </div>

        <div class="slot-container mt-3">
          {% for room in rooms %}
          <div class="room-row mb-4 {% if focus_room and focus_room|int == room.id %}border border-primary{% endif %} room-card" data-location="{{ (room.location or 'General')|trim }}">
            <div class="room-header d-flex justify-content-between align-items-center p-3 rounded bg-white shadow-sm" data-roomid="{{ room.id }}">
              <div>
                <div class="d-flex align-items-center">
                  <h5 class="mb-0 me-3">{{ room.name }}</h5>
                  {% if room.location %}<span class="badge bg-secondary">{{ room.location }}</span>{% endif %}
                </div>
                <div class="small text-muted mt-1">Capacity: {{ room.capacity }}{% if room.description %} — {{ room.description }}{% endif %}</div>
              </div>
              <button class="btn btn-outline-primary btn-sm reserve-btn"
                      data-room-id="{{ room.id }}" data-room-name="{{ room.name }}">
                <i class="bi bi-calendar-plus"></i> Reserve
              </button>
            </div>

            <!-- Hybrid timeline wrapper:
                 - .timeline keeps the horizontal scroll on desktop
                 - .slot-grid inside supports flex on desktop and becomes grid on tablet/phone -->
            <div class="timeline d-flex flex-nowrap overflow-auto border rounded bg-transparent p-3 mt-2" data-room-id="{{ room.id }}">
              <div class="slot-grid d-flex align-items-center">
              {% for hour in range(6, 20) %}
                {% for minute in [0, 30] %}
                  {% set time_label = "%02d:%02d"|format(hour, minute) %}
                  {% set slot = availability.get(room.id, {}).get(time_label, "available") %}
                  {% if slot is string %}
                    {% set status = slot %}
                    {% set by = '' %}
                    {% set remarks = '' %}
                    {% set res_id = '' %}
                    {% set reserved_by_uname = '' %}
                  {% else %}
                    {% set status = slot.status %}
                    {% set by = slot.by %}
                    {% set remarks = slot.remarks %}
                    {% set res_id = slot.id if slot.id is defined else '' %}
                    {% set reserved_by_uname = slot.reserved_by if slot.reserved_by is defined else '' %}
                  {% endif %}

                  <div class="slot-cell d-flex flex-column justify-content-center align-items-center text-center m-1 p-2 rounded"
                       data-room-id="{{ room.id }}"
                       data-room-name="{{ room.name }}"
                       data-time="{{ time_label }}"
                       data-status="{{ status }}"
                       data-res-id="{{ res_id }}"
                       data-reserved-by="{{ reserved_by_uname }}"
                       title="{% if status == 'booked' %}Booked by {{ by }}{% elif status == 'pending' %}Pending — requested by {{ by }}{% else %}Available{% endif %}{% if remarks %} | Remarks: {{ remarks }}{% endif %}"
                       style="min-width:72px; width:72px; box-shadow:0 2px 0 rgba(0,0,0,0.03);">
                    <div class="slot-time small fw-bold">{{ time_label }}</div>
                    <div class="slot-duration small text-muted">30 min</div>

                    {% if status == 'booked' %}
                      {% if current_user.is_admin() or reserved_by_uname == (current_user.username or '') %}
                        <button class="btn btn-sm btn-light cancel-btn position-absolute" style="right:10px; top:6px; width:18px; height:18px; padding:0;">
                          <i class="bi bi-x-lg" style="font-size:0.6rem; color:#c12;"></i>
                        </button>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endfor %}
              {% endfor %}
              </div><!-- /.slot-grid -->
            </div><!-- /.timeline -->

          </div><!-- /.room-row -->
          {% endfor %}
        </div><!-- /.slot-container -->
      </div><!-- /.card -->
    </div>
  </div>
</div>

<!-- Reservation Modal -->
<!-- RESERVATION MODAL w/ Recurrence -->
<!-- RESERVATION MODAL w/ Recurrence (replace existing) -->
<!-- ======================== -->
<!-- RESERVATION MODAL (FULL) -->
<!-- ======================== -->
<div class="modal fade" id="newReservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form id="reservationForm">

      <div class="modal-content">

        <!-- HEADER -->
        <div class="modal-header">
          <h5 class="modal-title fw-bold">New Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- BODY -->
        <div class="modal-body">

          <!-- Room -->
          <input type="hidden" id="modalRoomId" name="room_id">
          <div class="mb-3">
            <label class="form-label fw-semibold">Room</label>
            <div id="modalRoomName" class="fw-bold"></div>
          </div>

          <!-- Start / End -->
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Start</label>
              <input id="modalStartTime" name="start_time" type="datetime-local" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">End</label>
              <input id="modalEndTime" name="end_time" type="datetime-local" class="form-control" required>
            </div>
          </div>

          <!-- Reserved By -->
          <div class="mt-3">
            <label class="form-label fw-semibold">Reserved By</label>
            <input id="modalReservedBy" name="reserved_by" class="form-control"
                   value="{{ current_user.display_name or current_user.username }}" required>
          </div>

          <!-- Email -->
          <div class="mt-2">
            <label class="form-label fw-semibold">Email</label>
            <input id="modalEmail" name="email" type="email" class="form-control"
                   value="{{ current_user.email or '' }}">
          </div>

          <!-- Remarks -->
          <div class="mt-2">
            <label class="form-label fw-semibold">Remarks</label>
            <textarea id="modalRemarks" name="remarks" class="form-control" rows="2"></textarea>
          </div>

          <hr class="my-4">

          <!-- ======================== -->
          <!-- RECURRENCE UI -->
          <!-- ======================== -->
          <h6 class="fw-bold">Repeat</h6>

          <!-- Recurrence Type -->
          <div class="mb-2">
            <select id="recurrenceType" name="recurrence_type" class="form-select form-select-sm">
              <option value="none">No repeat</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>

          <!-- WEEKLY Options -->
          <div id="weeklyOptions" class="mb-3" style="display:none;">
            <label class="form-label small fw-semibold">Repeat on:</label>
            <div class="d-flex flex-wrap gap-3 mb-2">
              <label class="form-check"><input class="form-check-input wkday" value="MO" type="checkbox"> Mon</label>
              <label class="form-check"><input class="form-check-input wkday" value="TU" type="checkbox"> Tue</label>
              <label class="form-check"><input class="form-check-input wkday" value="WE" type="checkbox"> Wed</label>
              <label class="form-check"><input class="form-check-input wkday" value="TH" type="checkbox"> Thu</label>
              <label class="form-check"><input class="form-check-input wkday" value="FR" type="checkbox"> Fri</label>
              <label class="form-check"><input class="form-check-input wkday" value="SA" type="checkbox"> Sat</label>
              <label class="form-check"><input class="form-check-input wkday" value="SU" type="checkbox"> Sun</label>
            </div>

            <div class="row g-2">
              <div class="col-auto">
                <label class="form-label small">Every</label>
                <input id="weeklyInterval" name="weekly_interval" type="number" min="1" value="1"
                       class="form-control form-control-sm" style="width:90px;">
              </div>
              <div class="col-auto d-flex align-items-end">weeks</div>
            </div>
          </div>

          <!-- MONTHLY Options -->
          <div id="monthlyOptions" class="mb-3" style="display:none;">
            <label class="form-label small fw-semibold">Monthly pattern:</label>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="monthly_mode" value="date" checked>
              <label class="form-check-label">Same date each month (e.g., 15th)</label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="radio" name="monthly_mode" value="weekday">
              <label class="form-check-label">Same weekday each month (e.g., 3rd Monday)</label>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-auto">
                <label class="form-label small">Every</label>
                <input id="monthlyInterval" name="monthly_interval" type="number" min="1" value="1"
                       class="form-control form-control-sm" style="width:90px;">
              </div>
              <div class="col-auto d-flex align-items-end">months</div>
            </div>
          </div>

          <!-- END OPTIONS -->
          <h6 class="fw-bold mt-3">Ends</h6>

          <div class="form-check">
            <input class="form-check-input" type="radio" name="end_mode" id="end_never" value="never" checked>
            <label class="form-check-label">Never (max 1 year)</label>
          </div>

          <div class="form-check mt-1">
            <input class="form-check-input" type="radio" name="end_mode" id="end_on" value="on">
            <label class="form-check-label">On date</label>
            <input id="endOnDate" name="end_on_date" type="date" class="form-control form-control-sm mt-1" disabled>
          </div>

          <div class="form-check mt-1">
            <input class="form-check-input" type="radio" name="end_mode" id="end_after" value="after">
            <label class="form-check-label">After</label>
            <input id="endAfterCount" name="end_after_count" type="number" min="1" value="10"
                   class="form-control form-control-sm d-inline-block ms-2" style="width:100px;" disabled>
            <span class="small">occurrences</span>
          </div>

          <small class="text-muted d-block mt-2">
            Note: Conflicted dates will be skipped but shown in summary.
          </small>

        </div>

        <!-- FOOTER -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary fw-semibold" id="reserveSubmitBtn">Submit Reservation</button>
        </div>

      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
/* ========================================================================
   WebAXIS RoomSys — FINAL PATCHED UNIFIED JS
   ======================================================================== */

let submitting = false;

/* ---------------------------
   Helper: Weekday Code (MO/TU)
   --------------------------- */
function getJsWeekday(date) {
    const map = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
    return map[date.getDay()];
}

/* ---------------------------
   Helper: Format for datetime-local
   --------------------------- */
function formatLocalDate(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const h = String(dateObj.getHours()).padStart(2, '0');
    const min = String(dateObj.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${d}T${h}:${min}`;
}

/* ========================================================================
   MAIN SCRIPT
   ======================================================================== */
document.addEventListener("DOMContentLoaded", () => {

    /* ELEMENT REFERENCES */
    const form = document.getElementById("reservationForm");
    const modalEl = document.getElementById("newReservationModal");
    const modal = new bootstrap.Modal(modalEl);

    const recType = document.getElementById("recurrenceType");
    const weeklyOptions = document.getElementById("weeklyOptions");
    const monthlyOptions = document.getElementById("monthlyOptions");

    const locationFilter = document.getElementById("locationFilter");
    const viewDate = document.getElementById("viewDate");

    const endOnDate = document.getElementById("endOnDate");
    const endAfterCount = document.getElementById("endAfterCount");

    /* ------------------------------
       Restore Date Picker state
       ------------------------------ */
    function refreshEndModeState() {
        endOnDate.disabled = !document.getElementById("end_on").checked;
        endAfterCount.disabled = !document.getElementById("end_after").checked;
    }

    refreshEndModeState();

    document.querySelectorAll("input[name='end_mode']").forEach(r => {
        r.addEventListener("change", refreshEndModeState);
    });

    /* ------------------------------
       Recurrence Type Switching
       ------------------------------ */
    recType.addEventListener("change", () => {
        weeklyOptions.style.display = recType.value === "weekly" ? "block" : "none";
        monthlyOptions.style.display = recType.value === "monthly" ? "block" : "none";
    });

    /* ------------------------------
       Date Persistence
       ------------------------------ */
    if (localStorage.getItem("selectedDate"))
        viewDate.value = localStorage.getItem("selectedDate");

    viewDate.addEventListener("change", () => {
        localStorage.setItem("selectedDate", viewDate.value);
        window.location.href = `/rooms?date=${viewDate.value}`;
    });

    /* ------------------------------
       Location Filter
       ------------------------------ */
    const savedFilter = localStorage.getItem('roomFilter') || 'all';
    locationFilter.value = savedFilter;

    function applyFilter() {
        const selected = (locationFilter.value || 'all').trim();
        localStorage.setItem('roomFilter', selected);
        document.querySelectorAll('.room-row').forEach(r => {
            const loc = (r.dataset.location || '').trim();
            r.style.display = (selected === 'all' || loc === selected) ? '' : 'none';
        });
    }
    applyFilter();
    locationFilter.addEventListener('change', applyFilter);

    /* ====================================================================
       TIMELINE SLOT COLORING
       ==================================================================== */
    function updatePastSlots() {
        const selectedStr = viewDate.value;
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);

        document.querySelectorAll('.slot-cell').forEach(cell => {

            const status = (cell.dataset.status || 'available').toLowerCase();
            cell.classList.remove('bg-success','bg-danger','bg-warning','bg-secondary','text-white','text-dark');
            cell.style.pointerEvents = '';

            if (status === 'booked') {
                cell.classList.add('bg-danger','text-white');
                return;
            }

            if (status === 'pending') {
                cell.classList.add('bg-warning','text-dark');
                return;
            }

            if (selectedStr < todayStr) {
                cell.classList.add('bg-secondary','text-white');
                cell.style.pointerEvents = 'none';
                return;
            }

            if (selectedStr === todayStr) {
                const slotDate = new Date(`${selectedStr}T${cell.dataset.time}:00`);
                if (slotDate < now) {
                    cell.classList.add('bg-secondary','text-white');
                    cell.style.pointerEvents = 'none';
                } else {
                    cell.classList.add('bg-success','text-white');
                }
                return;
            }

            cell.classList.add('bg-success','text-white');
        });
    }

    /* ------------------------------
       Auto Scroll to Next Slot
       ------------------------------ */
    function autoScrollToCurrentSlot() {
        const todayStr = new Date().toISOString().slice(0,10);

        document.querySelectorAll('.timeline').forEach(timeline => {
            const slots = [...timeline.querySelectorAll('.slot-cell')];
            if (!slots.length) return;

            if (viewDate.value === todayStr) {
                const now = new Date();

                const upcoming = slots.find(s => {
                    const st = new Date(`${viewDate.value}T${s.dataset.time}:00`);
                    return st > now && !s.classList.contains('bg-danger');
                });

                if (upcoming)
                    timeline.scrollTo({ left: upcoming.offsetLeft - 120, behavior: 'smooth' });
            }
        });
    }

    /* ====================================================================
       DRAG TO SELECT SLOTS
       ==================================================================== */
    function attachSlotSelectionHandlers() {
        document.querySelectorAll('.timeline').forEach(timeline => {

            const cells = [...timeline.querySelectorAll('.slot-cell')];
            if (!cells.length) return;

            let isDragging = false, dragStart = null, dragEnd = null;

            function clearSel() { cells.forEach(c => c.classList.remove('selected')); }

            cells.forEach(cell => {
                cell.addEventListener('pointerdown', (e) => {
                    if (e.button !== 0) return;

                    const status = (cell.dataset.status||'available').toLowerCase();
                    if (['booked','pending'].includes(status) || cell.classList.contains('bg-secondary')) return;

                    isDragging = true;
                    dragStart = cell;
                    dragEnd = cell;

                    clearSel();
                    cell.classList.add('selected');
                });

                cell.addEventListener('pointerenter', () => {
                    if (!isDragging) return;

                    dragEnd = cell;

                    const startIndex = cells.indexOf(dragStart);
                    const endIndex = cells.indexOf(dragEnd);

                    const min = Math.min(startIndex, endIndex);
                    const max = Math.max(startIndex, endIndex);

                    cells.forEach((c, i) => c.classList.toggle('selected', i >= min && i <= max));
                });

                cell.addEventListener('pointerup', () => {
                    if (!isDragging) return;
                    isDragging = false;

                    const startIndex = cells.indexOf(dragStart);
                    const endIndex = cells.indexOf(dragEnd);

                    const min = Math.min(startIndex, endIndex);
                    const max = Math.max(startIndex, endIndex);

                    const selected = cells.slice(min, max+1);

                    const invalid = selected.some(c => {
                        const st = (c.dataset.status||'available').toLowerCase();
                        return ['booked','pending'].includes(st) || c.classList.contains('bg-secondary');
                    });

                    if (invalid) {
                        Swal.fire("Slot Not Available", "Selected slots include booked or pending slots.", "warning");
                        clearSel();
                        return;
                    }

                    const dateValue = viewDate.value;
                    const start = selected[0].dataset.time;
                    const end = selected[selected.length-1].dataset.time;

                    let st = new Date(`${dateValue}T${start}:00`);
                    let et = new Date(`${dateValue}T${end}:00`);
                    et.setMinutes(et.getMinutes() + 30);

                    openReserve(selected[0].dataset.roomId, selected[0].dataset.roomName, formatLocalDate(st), formatLocalDate(et));

                    clearSel();
                });
            });

            document.addEventListener('pointerup', () => {
                isDragging = false;
            });
        });
    }

    /* ====================================================================
       OPEN MODAL
       ==================================================================== */
    function openReserve(roomId, roomName, startTime, endTime) {
        document.getElementById('modalRoomId').value = roomId;
        document.getElementById('modalRoomName').textContent = roomName;
        document.getElementById('modalStartTime').value = startTime;
        document.getElementById('modalEndTime').value = endTime;
        modal.show();
    }

    /* ====================================================================
       SUBMIT RESERVATION + RECURRING
       ==================================================================== */
    form.addEventListener("submit", (e) => {
        e.preventDefault();

        if (submitting) return;

        const start = document.getElementById("modalStartTime").value;
        const end = document.getElementById("modalEndTime").value;

        if (!start || !end) {
            Swal.fire("Invalid", "Start and end time required.", "error");
            return;
        }

        /* WEEKLY mismatch warning */
        if (recType.value === "weekly") {
            const weekdays = [];
            document.querySelectorAll(".wkday").forEach(cb => {
                if (cb.checked) weekdays.push(cb.value);
            });

            const startDate = new Date(start);
            const wk = getJsWeekday(startDate);

            if (weekdays.length && !weekdays.includes(wk)) {

                let nextMatch = new Date(startDate);
                for (let i = 1; i <= 14; i++) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + i);
                    if (weekdays.includes(getJsWeekday(d))) {
                        nextMatch = d;
                        break;
                    }
                }

                return Swal.fire({
                    icon: "warning",
                    title: "Start date mismatch",
                    html: `
                        Your start date is <b>${startDate.toDateString()}</b><br>
                        Recurs on: <b>${weekdays.join(", ")}</b><br><br>
                        Next matching date:<br><b>${nextMatch}</b>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: "Adjust automatically",
                    denyButtonText: "I'll fix manually"
                }).then(result => {
                    if (result.isConfirmed) {
                        const duration = new Date(end) - new Date(start);
                        const newStart = new Date(nextMatch);
                        const newEnd = new Date(newStart.getTime() + duration);

                        document.getElementById("modalStartTime").value = newStart.toISOString().slice(0,16);
                        document.getElementById("modalEndTime").value = newEnd.toISOString().slice(0,16);

                        submitFinal();
                    }
                });
            }
        }

        submitFinal();
    });

    /* ====================================================================
       FINAL SUBMIT — PATCHED TO SEND FORMDATA
       ==================================================================== */
    async function submitFinal() {
        submitting = true;
        modal.hide();

        const roomId = document.getElementById("modalRoomId").value;
        const fd = new FormData(form);

        const weekdays = [];
        document.querySelectorAll(".wkday").forEach(cb => {
            if (cb.checked) weekdays.push(cb.value);
        });
        fd.set("weekdays", weekdays.join(","));

        try {
            /* PATCHED — Send FormData exactly as backend expects */
            const resp = await fetch(`/reserve_post/${roomId}`, {
                method: "POST",
                body: fd
            });

            const data = await resp.json();

            let html = `<b>${data.created_count}</b> reservations created.`;
            if (data.skipped?.length) {
                html += `<br><b>${data.skipped.length}</b> skipped:<ul>`;
                data.skipped.forEach(s => html += `<li>${s}</li>`);
                html += "</ul>";
            }

            Swal.fire({
                icon: data.success ? "success" : "error",
                title: data.success ? "Recurring booking result" : "Reservation Failed",
                html,
                confirmButtonColor: "#0047AB"
            }).then(() => {
                if (data.success) window.location.reload();
                submitting = false;
            });

        } catch (err) {
            submitting = false;
            Swal.fire("System Error", "Please try again.", "error");
        }
    }

    /* ====================================================================
       INITIAL LOAD
       ==================================================================== */
    setTimeout(() => {
        updatePastSlots();
        autoScrollToCurrentSlot();
        attachSlotSelectionHandlers();
    }, 100);
});
</script>

<style>
/* ======================
   BASE LAYOUT & DESIGN
   ====================== */
.border-end { border-right: 1px solid #dee2e6 !important; }
.room-card { border-radius: 12px; overflow: hidden; }
.room-header h5 { font-size: 1.05rem; }
.timeline { scroll-behavior: smooth; user-select: none; min-height: 84px; align-items: center; }

/* slot grid (desktop) */
.slot-grid {
    display:flex;
    gap:0.5rem;
    align-items:center;
}

/* slot cell */
.slot-cell {
    font-size:0.82rem;
    font-weight:600;
    border-radius:10px;
    min-width:72px;
    width:72px;
    height:56px;
    position:relative;
    transition:transform .12s ease;
    touch-action: manipulation;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
}
.slot-cell .slot-time { line-height:1; }
.slot-cell .slot-duration { font-size:0.68rem; }

.slot-cell:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    cursor:pointer;
}

/* selected slot */
.slot-cell.selected {
    border:2px solid #0047AB !important;
    background:#cfe8ff !important;
    transform:scale(1.04);
}

/* ======================
   COLOR STATUS CLASSES
   ====================== */
.slot-cell.bg-success { background-color:#0b8a44 !important; color:white !important; }
.slot-cell.bg-danger  { background-color:#d23a3a !important; color:white !important; }
.slot-cell.bg-warning { background-color:#ffc107 !important; color:#222 !important; }
.slot-cell.bg-secondary { background-color:#9fa6ad !important; color:white !important; opacity:0.86; }

/* cancel (X) button */
.cancel-btn {
    border:none;
    background:rgba(255,255,255,0.95);
    border-radius:50%;
    width:18px; height:18px;
    display:flex;
    align-items:center;
    justify-content:center;
}

/* ======================
   SCROLLBAR TWEAKS
   ====================== */
.timeline::-webkit-scrollbar { height:8px; }
.timeline::-webkit-scrollbar-thumb { background:#cfd8e3; border-radius:4px; }

/* ======================
   MOBILE FIXES
   ====================== */
@media (max-width: 768px) {
    .page-left-panel { display:none !important; }

    .slot-grid {
        display:grid !important;
        grid-template-columns:repeat(auto-fit, minmax(48px,1fr));
        gap:0.35rem;
    }

    .slot-cell {
        min-width:48px;
        width:100%;
        height:42px;
        font-size:0.75rem;
        padding:4px;
    }
}

</style>
{% endblock %}

