{% extends "base_dashboard.html" %}
{% block title %}Meeting Room | WebAXIS{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3">

  <!-- PAGE HEADER -->
  <div class="row mb-3 mb-md-4">
    <div class="col-12">
      <h2 class="fw-bold page-title d-flex align-items-center flex-wrap gap-2">
        <i class="bi bi-door-open"></i>
        <span class="title-text">Shared Resources</span>
      </h2>
    </div>
  </div>

  <div class="row g-3">

    <!-- =====================================================
         LEFT SIDEBAR (Desktop Only) - UPDATED FILTERS
         ===================================================== -->
    <div class="col-lg-2 d-none d-lg-block">
      <div class="card p-3 sticky-sidebar">

        <h5 class="fw-bold text-primary mb-3">Meeting Room</h5>

        <div class="d-grid gap-2 mb-3">
          <a href="{{ url_for('room_list') }}" class="btn btn-primary fw-semibold">
            <i class="bi bi-grid-3x3-gap me-2"></i> Timeline View
          </a>
          <a href="#" id="sidebarCalendarBtn" class="btn btn-outline-primary fw-semibold">
            <i class="bi bi-calendar3 me-2"></i> Calendar View
          </a>
        </div>

        <!-- FILTER PANEL -->
        <div class="filter-panel">

          <!-- LOCATION FILTER - NO INLINE ONCHANGE -->
          <label class="form-label fw-bold small">Filter by Location</label>
          <select class="form-select form-select-sm mb-3" id="locationFilter">
              <option value="all" {% if selected_location=='all' %}selected{% endif %}>
                  All Locations
              </option>
              {% for loc in allowed_locations %}
                  <option value="{{ loc }}" {% if selected_location==loc %}selected{% endif %}>
                      {{ loc }}
                  </option>
              {% endfor %}
          </select>

          <!-- ROOM FILTER - NO INLINE ONCHANGE -->
          <label class="form-label fw-bold small">Room</label>
          <select class="form-select form-select-sm" id="roomFilterDesktop">
              <option value="all" {% if selected_room=='all' %}selected{% endif %}>All Rooms</option>
              {% for loc in allowed_locations %}
                  {% if selected_location == 'all' or selected_location == loc %}
                      <optgroup label="{{ loc }}">
                          {% for r in all_rooms %}
                              {% if r.location == loc %}
                                  <option value="{{ r.name }}"
                                          {% if selected_room == r.name %}selected{% endif %}>
                                      {{ r.name }}
                                  </option>
                              {% endif %}
                          {% endfor %}
                      </optgroup>
                  {% endif %}
              {% endfor %}
          </select>

          <!-- APPLY FILTERS BUTTON -->
          <button id="applyDesktopFilters" class="btn btn-primary btn-sm w-100 mt-3">
            <i class="bi bi-check-circle"></i> Apply Filters
          </button>

        </div>

        <hr class="my-3">

        <!-- STATUS LEGEND -->
        <h6 class="fw-bold small text-muted mb-2">Reservation Status</h6>
        <div class="small">
            <div class="mb-1"><span class="badge bg-success me-1">&nbsp;&nbsp;</span> Available</div>
            <div class="mb-1"><span class="badge bg-danger me-1">&nbsp;&nbsp;</span> Booked / Blocked</div>
            <div class="mb-1"><span class="badge bg-secondary me-1">&nbsp;&nbsp;</span> Past</div>
            <div class="mb-1"><span class="badge bg-warning me-1">&nbsp;&nbsp;</span> Pending</div>
        </div>

      </div>
    </div>

    <!-- =====================================================
         MAIN CONTENT AREA
         ===================================================== -->
    <div class="col-12 col-lg-10">

      <!-- ACTION BAR -->
      <div class="card p-3 p-md-4 mb-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

          <div class="d-flex align-items-center gap-2">
            <!-- Mobile Filter Button -->
            <button id="mobileFiltersBtn" class="btn btn-outline-primary btn-sm d-lg-none">
              <i class="bi bi-funnel"></i> Filters
            </button>

            <button id="refreshButton" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-arrow-clockwise"></i>
              <span class="d-none d-md-inline">Refresh</span>
            </button>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button id="calendarSyncBtn" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-calendar-event"></i>
              <span class="d-none d-md-inline">Calendar View</span>
            </button>
            <input type="date" id="viewDate" class="form-control form-control-sm"
                   value="{{ selected_date.strftime('%Y-%m-%d') if selected_date else '' }}"
                   style="max-width:160px;">
          </div>

        </div>
      </div>

      <!-- ROOM LIST -->
      <div class="slot-container">
        {% for room in rooms %}
        <div class="room-row mb-3 {% if focus_room and focus_room|int == room.id %}border-focus{% endif %}"
             data-location="{{ (room.location or 'General')|trim }}"
             data-room-id="{{ room.id }}"
             data-room-name="{{ room.name }}">

          <!-- ROOM HEADER -->
          <div class="room-header card p-3 mb-2" data-roomid="{{ room.id }}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <h5 class="mb-0 room-clickable" data-room-id="{{ room.id }}">
                    {{ room.name }}
                  </h5>
                  {% if room.location %}
                  <span class="badge bg-secondary">{{ room.location }}</span>
                  {% endif %}
                </div>
                <div class="small text-muted">
                  Capacity: {{ room.capacity }}
                  {% if room.description %} â€” {{ room.description }}{% endif %}
                </div>
              </div>
              <button class="btn btn-primary btn-sm reserve-btn"
                      data-room-id="{{ room.id }}"
                      data-room-name="{{ room.name }}">
                <i class="bi bi-calendar-plus"></i>
                <span class="d-none d-md-inline">Reserve</span>
              </button>
            </div>
          </div>

          <!-- TIMELINE -->
          <div class="timeline card p-3" data-room-id="{{ room.id }}">
            <div class="slot-grid">
              {% for hour in range(start_hour, end_hour) %}
                {% for minute in [0,30] %}
                  {% set time_label = "%02d:%02d"|format(hour, minute) %}
                  {% set slot = availability.get(room.id, {}).get(time_label, None) %}
                  {% if slot is not none %}
                    {% set status = (slot.status if slot.status is defined else 'available') | lower %}
                    {% set by = (slot.reserved_by if slot.reserved_by is defined else '') %}
                    {% set remarks = (slot.remarks if slot.remarks is defined else '') %}
                    {% set res_id = (slot.id if slot.id is defined else '') %}
                  {% else %}
                    {% set status = 'available' %}
                    {% set by = '' %}
                    {% set remarks = '' %}
                    {% set res_id = '' %}
                  {% endif %}

                  <div class="slot-cell"
                       data-room-id="{{ room.id }}"
                       data-room-name="{{ room.name }}"
                       data-time="{{ time_label }}"
                       data-status="{{ status }}"
                       data-res-id="{{ res_id }}"
                       title="{% if status == 'booked' %}Booked by {{ by }}{% elif status == 'pending' %}Pending â€” requested by {{ by }}{% elif status == 'blocked' %}Blocked{% else %}Available{% endif %}{% if remarks %} | Remarks: {{ remarks }}{% endif %}">
                    <div class="slot-time">{{ time_label }}</div>
                    <div class="slot-duration">30 min</div>

                    {% if status in ['booked','approved'] %}
                      {% if current_user.is_admin() or by == (current_user.username or '') %}
                        <button class="cancel-btn">
                          <i class="bi bi-x-lg"></i>
                        </button>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          </div>

        </div>
        {% endfor %}
      </div>

    </div>
  </div>

<!-- =====================================================
     MOBILE FILTER PANEL - UPDATED WITH SYNC
     ===================================================== -->
<div id="mobileFilterPanel" class="mobile-filter-panel">
    <div class="mobile-filter-header">
        <span class="fw-semibold"><i class="bi bi-funnel me-2"></i>Filters</span>
        <button id="closeMobileFilter" class="btn-close btn-close-white"></button>
    </div>

    <div class="mobile-filter-body">

        <!-- Location Filter -->
        <label class="form-label fw-semibold">Location</label>
        <select id="mobileLocationFilter" class="form-select mb-3">
            <option value="all" {% if selected_location=='all' %}selected{% endif %}>All Locations</option>
            {% for loc in allowed_locations %}
                <option value="{{ loc }}" {% if selected_location == loc %}selected{% endif %}>
                    {{ loc }}
                </option>
            {% endfor %}
        </select>

        <!-- Room Filter -->
        <label class="form-label fw-semibold">Room</label>
        <select id="mobileRoomFilter" class="form-select mb-3">
          <option value="all" {% if selected_room=='all' %}selected{% endif %}>All Rooms</option>
          {% for loc in allowed_locations %}
              {% if selected_location == 'all' or selected_location == loc %}
                  <optgroup label="{{ loc }}">
                      {% for r in all_rooms %}
                          {% if r.location == loc %}
                              <option value="{{ r.name }}" {% if selected_room == r.name %}selected{% endif %}>
                                  {{ r.name }}
                              </option>
                          {% endif %}
                      {% endfor %}
                  </optgroup>
              {% endif %}
          {% endfor %}
        </select>

        <!-- Date -->
        <label class="form-label fw-semibold">Date</label>
        <input type="date" id="mobileDate" class="form-control mb-3"
               value="{{ selected_date.strftime('%Y-%m-%d') if selected_date else '' }}">

        <hr class="my-3">

        <!-- Apply Filters Button -->
        <button id="applyMobileFilters" class="btn btn-primary w-100 mb-2">
            <i class="bi bi-check-circle"></i> Apply Filters
        </button>

        <!-- Refresh -->
        <button id="mobileRefresh" class="btn btn-outline-secondary w-100 mb-2">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>

        <!-- Calendar View -->
        <button id="mobileCalendar" class="btn btn-outline-primary w-100">
            <i class="bi bi-calendar3"></i> Calendar View
        </button>
    </div>
</div>

<!-- Overlay -->
<div id="mobileFilterOverlay" class="mobile-filter-overlay"></div>

</div>

<!-- =====================================================
     NEW RESERVATION MODAL
     ===================================================== -->
<div class="modal fade" id="newReservationModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
<form id="reservationForm">
<div class="modal-content border-0 shadow-lg" style="border-radius:14px;">
<!-- HEADER -->
<div class="modal-header px-3 py-2">
<h5 class="modal-title fw-bold text-primary">New Reservation</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<!-- BODY -->
<div class="modal-body px-3">
<!-- ROOM INFO -->
<div class="mb-3 p-3 rounded bg-light">
<label class="form-label fw-semibold text-secondary small">Room</label>
<div id="modalRoomName" class="fw-bold text-dark fs-5 mb-1"></div>
<input type="hidden" id="modalRoomId" name="room_id">
</div>
<!-- SCHEDULE -->
<div class="p-3 rounded mb-3 bg-light">
<h6 class="fw-bold text-primary mb-3">Schedule</h6>
<div class="row g-3">
<div class="col-12 col-md-6">
<label class="form-label fw-semibold small">Start</label>
<input id="modalStartTime" name="start_time" type="datetime-local"
                                      class="form-control form-control-lg" required>
</div>
<div class="col-12 col-md-6">
<label class="form-label fw-semibold small">End</label>
<input id="modalEndTime" name="end_time" type="datetime-local"
                                      class="form-control form-control-lg" required>
</div>
</div>
</div>
<!-- PERSONAL INFO -->
<div class="p-3 rounded mb-3 bg-light">
<h6 class="fw-bold text-primary mb-3">Your Details</h6>
<label class="form-label fw-semibold small">Reserved By</label>
<input id="modalReservedBy" name="reserved_by" class="form-control form-control-lg mb-3" required>
<label class="form-label fw-semibold small">Email</label>
<input id="modalEmail" name="email" type="email"
                              class="form-control form-control-lg mb-3">
<label class="form-label fw-semibold small">Meeting Title</label>
<textarea id="modalRemarks" name="remarks"
                                 class="form-control form-control-lg" rows="2"></textarea>
</div>
<!-- RECURRENCE -->
<div class="p-3 rounded mb-2 bg-light">
<h6 class="fw-bold text-primary mb-3">Repeat</h6>
<select id="recurrenceType" name="recurrence_type"
                               class="form-select form-select-lg mb-3">
<option value="none">No repeat</option>
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
</select>
<!-- WEEKLY OPTIONS -->
<div id="weeklyOptions" class="mb-3" style="display:none;">
<label class="form-label small fw-semibold">Repeat on:</label>
<div class="d-flex flex-wrap gap-2 mb-2">
<label class="form-check small">
<input class="form-check-input wkday" value="MO" type="checkbox"> Mon
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="TU" type="checkbox"> Tue
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="WE" type="checkbox"> Wed
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="TH" type="checkbox"> Thu
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="FR" type="checkbox"> Fri
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="SA" type="checkbox"> Sat
</label>
<label class="form-check small">
<input class="form-check-input wkday" value="SU" type="checkbox"> Sun
</label>
</div>
<div class="row g-2">
<div class="col-auto">
<label class="form-label small">Every</label>
<input id="weeklyInterval" name="weekly_interval"
                                          type="number" min="1" value="1"
                                          class="form-control form-control-sm" style="width:90px;">
</div>
<div class="col-auto d-flex align-items-end small">weeks</div>
</div>
</div>
<!-- MONTHLY OPTIONS -->
<div id="monthlyOptions" style="display:none;">
<label class="form-label small fw-semibold">Monthly pattern:</label>
<div class="form-check small">
<input class="form-check-input" type="radio" name="monthly_mode" value="date" checked>
<label class="form-check-label">Same date each month (e.g., 15th)</label>
</div>
<div class="form-check small mt-1">
<input class="form-check-input" type="radio" name="monthly_mode" value="weekday">
<label class="form-check-label">Same weekday each month (e.g., 3rd Monday)</label>
</div>
<div class="row g-2 mt-2">
<div class="col-auto">
<label class="form-label small">Every</label>
<input id="monthlyInterval" name="monthly_interval" type="number"
                                          min="1" value="1"
                                          class="form-control form-control-sm" style="width:90px;">
</div>
<div class="col-auto d-flex align-items-end small">months</div>
</div>
</div>
<!-- END CONDITIONS -->
<h6 class="fw-bold mt-3">Ends</h6>
<div class="form-check small">
<input class="form-check-input" type="radio" name="end_mode" id="end_never" value="never" checked>
<label class="form-check-label">Never (max 1 year)</label>
</div>
<div class="form-check mt-2 small">
<input class="form-check-input" type="radio" name="end_mode" id="end_on" value="on">
<label class="form-check-label">On date</label>
<input id="endOnDate" name="end_on_date" type="date"
                                  class="form-control form-control-sm mt-1" disabled>
</div>
<div class="form-check mt-2 small">
<input class="form-check-input" type="radio" name="end_mode" id="end_after" value="after">
<label class="form-check-label">After</label>
<input id="endAfterCount" name="end_after_count" type="number" min="1" value="10"
                                  class="form-control form-control-sm d-inline-block ms-2" style="width:100px;" disabled>
<span class="small">occurrences</span>
</div>
<small class="text-muted d-block mt-2">Conflicted dates will be skipped but shown in summary.</small>
</div>
</div>
<!-- FOOTER -->
<div class="modal-footer px-3 py-2">
<button type="button" class="btn btn-secondary px-3" data-bs-dismiss="modal">Cancel</button>
<button type="submit" class="btn btn-primary fw-semibold px-3" id="reserveSubmitBtn">Submit</button>
</div>
</div>
</form>
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
/* =====================================================
   YOUR EXISTING JAVASCRIPT CODE
   Paste all your JavaScript from lines 575-1200 HERE
   ===================================================== */

// [PASTE YOUR EXISTING showSlotDetails, openReserve, form handlers, etc.]
// Your existing JavaScript code here (lines 575-1200)
// ... [KEEP EVERYTHING FROM YOUR ORIGINAL FILE] ...
    /* ------------------------------------------------------------------
   Patched timeline JS
   - relies on server variables:
     rooms, availability, start_hour, end_hour, selected_date, focus_room
   ------------------------------------------------------------------ */

let submitting = false;

/* helpers */
function getJsWeekday(date) {
  const map = ['SU','MO','TU','WE','TH','FR','SA'];
  return map[date.getDay()];
}
function formatLocalDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${dd}T${hh}:${mm}`;
}

/* main on DOM ready */
document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('newReservationModal');
  const bsModal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('reservationForm');
  const recType = document.getElementById('recurrenceType');
  const weeklyOptions = document.getElementById('weeklyOptions');
  const monthlyOptions = document.getElementById('monthlyOptions');
  const locationFilter = document.getElementById('locationFilter');
  const viewDate = document.getElementById('viewDate');
const loggedUser = {
    name: "{{ current_user.display_name or current_user.username }}",
    email: "{{ current_user.email or '' }}"
};
  // Persist date and location (keeps prior behavior)
  if (localStorage.getItem('selectedDate')) viewDate.value = localStorage.getItem('selectedDate');
  viewDate.addEventListener('change', () => {

    localStorage.setItem('selectedDate', viewDate.value);
    // use query param for consistent refresh
    const loc = document.getElementById('locationFilter')?.value || 'all';
    window.location.href = `/rooms?date=${viewDate.value}&location=${loc}`;
  });

  // Location filter persistence + apply
  const savedFilter = localStorage.getItem('roomFilter') || '{{ selected_location if selected_location else "all" }}';
  if (locationFilter) { locationFilter.value = savedFilter; }
  function applyFilter(){
    const sel = (locationFilter?.value || 'all').trim();
    localStorage.setItem('roomFilter', sel);
    document.querySelectorAll('.room-row').forEach(r => {
      const loc = (r.dataset.location||'').trim();
      r.style.display = (sel === 'all' || loc === sel) ? '' : 'none';
    });
  }
  applyFilter();
  if (locationFilter) locationFilter.addEventListener('change', () => { applyFilter(); });

  // hide recurrence UI where applicable
  if (recType){
    recType.addEventListener('change', () => {
      weeklyOptions.style.display = recType.value === 'weekly' ? 'block' : 'none';
      monthlyOptions.style.display = recType.value === 'monthly' ? 'block' : 'none';
    });
  }
  document.querySelectorAll("input[name='end_mode']").forEach(r => r.addEventListener('change', ()=>{
    document.getElementById('endOnDate').disabled = !document.getElementById('end_on').checked;
    document.getElementById('endAfterCount').disabled = !document.getElementById('end_after').checked;
  }));


  /* ---------- Coloring logic ---------- */
  function updatePastSlots(){
    const selectedStr = viewDate?.value || '{{ selected_date.strftime("%Y-%m-%d") if selected_date else "" }}';
    const now = new Date();
    const todayStr = now.toISOString().slice(0,10);

    document.querySelectorAll('.slot-cell').forEach(cell => {
      const status = (cell.dataset.status || 'available').toLowerCase();
      cell.classList.remove('bg-success','bg-danger','bg-warning','bg-secondary','text-white','text-dark');
      cell.style.pointerEvents = '';

      if (status === 'booked' || status === 'approved' || status === 'blocked') {
        // treat 'blocked' same as unavailable (danger)
        cell.classList.add('bg-danger','text-white');
        cell.style.pointerEvents = (status === 'blocked') ? 'none' : 'auto';
        return;
      }
      if (status === 'pending') {
        cell.classList.add('bg-warning','text-dark');
        cell.style.pointerEvents = 'auto';
        return;
      }

      if (!selectedStr) return;
      if (selectedStr < todayStr) {
        cell.classList.add('bg-secondary','text-white');
        cell.style.pointerEvents = 'none';
        return;
      }
      if (selectedStr === todayStr) {
        const slotDate = new Date(`${selectedStr}T${cell.dataset.time}:00`);
        if (slotDate < now) {
          cell.classList.add('bg-secondary','text-white');
          cell.style.pointerEvents = 'none';
        } else {
          cell.classList.add('bg-success','text-white');
        }
        return;
      }
      cell.classList.add('bg-success','text-white');
    });
  }

  function autoScrollToCurrentSlot(){
    const todayStr = new Date().toISOString().slice(0,10);
    document.querySelectorAll('.timeline').forEach(tl => {
      const slots = Array.from(tl.querySelectorAll('.slot-cell'));
      if (!slots.length) return;
      const viewIsToday = (viewDate?.value || '{{ selected_date.strftime("%Y-%m-%d") if selected_date else "" }}') === todayStr;
      if (viewIsToday){
        const now = new Date();
        const upcoming = slots.find(s => {
          const st = new Date(`${viewDate.value}T${s.dataset.time}:00`);
          return st > now && !s.classList.contains('bg-danger');
        });
        if (upcoming) tl.scrollTo({ left: Math.max(0, upcoming.offsetLeft - 120), behavior: 'smooth' });
      } else {
        tl.scrollTo({ left: 0, behavior: 'smooth' });
      }
    });
  }

  /* ---------- Selection / click / drag handlers (single delegated attach) ---------- */
  function attachSlotHandlers(){
    // Use event delegation on container

    document.querySelectorAll('.slot-container').forEach(container => {
      let isDragging = false, dragStart = null, dragEnd = null, cells = [];
      container.addEventListener('pointerdown', (ev) => {
        const cell = ev.target.closest('.slot-cell');
        if (!cell) return;
        if (ev.button && ev.button !== 0) return;

        // initialize cells array for the timeline that this cell belongs to
        const timeline = cell.closest('.timeline');
        if (!timeline) return;
        cells = Array.from(timeline.querySelectorAll('.slot-cell'));

        const status = (cell.dataset.status || 'available').toLowerCase();
        if (['booked','pending','blocked'].includes(status) || cell.classList.contains('bg-secondary')) return;

        isDragging = true;
        dragStart = cell;
        dragEnd = cell;
        cells.forEach(c => c.classList.remove('selected'));
        cell.classList.add('selected');
        ev.preventDefault();
      });

      container.addEventListener('pointerenter', (ev) => {
        // pointerenter used at cell-level below
      });

      container.addEventListener('pointermove', (ev) => {
        if (!isDragging || !dragStart) return;
        const over = ev.target.closest('.slot-cell');
        if (!over || !cells.length) return;
        dragEnd = over;
        const startIndex = cells.indexOf(dragStart);
        const endIndex = cells.indexOf(dragEnd);
        const [min, max] = [Math.min(startIndex, endIndex), Math.max(startIndex, endIndex)];
        cells.forEach((c,i) => c.classList.toggle('selected', i>=min && i<=max));
      });

      container.addEventListener('pointerup', (ev) => {
    if (!isDragging || !dragStart) return;
    isDragging = false;
    const startIndex = cells.indexOf(dragStart);
    const endIndex = cells.indexOf(dragEnd || dragStart);
    const [min, max] = [Math.min(startIndex, endIndex), Math.max(startIndex, endIndex)];
    const selected = cells.slice(min, max+1);

    const invalid = selected.some(c => {
        const st = (c.dataset.status||'available').toLowerCase();
        return ['booked', 'pending', 'blocked'].includes(st) || c.classList.contains('bg-secondary');
    });
    //'approved'
    if (invalid) {
        Swal.fire({
            icon: 'warning',
            title: 'âš  Slot Not Available',
            text: 'This range includes booked, pending, or blocked slots.',
            confirmButtonColor: '#0047AB'
        });
        selected.forEach(s => s.classList.remove('selected'));
        return;
    }

    // Prevent opening modal if clicking on non-available slot
    const firstStatus = selected[0].dataset.status.toLowerCase();
    if (['booked', 'pending', 'blocked', 'approved'].includes(firstStatus)) {
        selected.forEach(s => s.classList.remove('selected'));
        return;
    }

    // compute start/end from first/last selected
    const dateValue = viewDate?.value || '{{ selected_date.strftime("%Y-%m-%d") if selected_date else "" }}';
    const start = selected[0].dataset.time;
    const end = selected[selected.length-1].dataset.time;
    let startDate = new Date(`${dateValue}T${start}:00`);
    let endDate = new Date(`${dateValue}T${end}:00`);
    endDate.setMinutes(endDate.getMinutes()+30);

    openReserve(
        selected[0].dataset.roomId,
        selected[0].dataset.roomName,
        formatLocalDate(startDate),
        formatLocalDate(endDate),
        loggedUser.name,
        loggedUser.email
    );
    selected.forEach(s => s.classList.remove('selected'));
});

      // CLICK HANDLER â€“ handles booked, pending, blocked, approved, available
        container.addEventListener('click', (ev) => {
        const cell = ev.target.closest('.slot-cell');
        if (!cell) return;

        // Check if clicking the cancel button inside the cell
        if (ev.target.closest('.cancel-btn')) {
            return; // Let the cancel button handler deal with it
        }

        const status = (cell.dataset.status || "available").toLowerCase();

        // BOOKED / APPROVED / BLOCKED / PENDING â†’ DETAILS
        if (["booked","approved","blocked","pending"].includes(status)) {
            ev.stopPropagation();
            ev.preventDefault();
            showSlotDetails(cell);
            return;
        }
        // AVAILABLE â†’ NEW RESERVATION (only if not grey/past)
        if (cell.classList.contains('bg-secondary')) {
            // Past slot, do nothing
            return;
        }

        // AVAILABLE â†’ NEW RESERVATION
        if (status === 'available') {
                const dateValue = viewDate?.value || '';
                const [h, m] = cell.dataset.time.split(':');
                const startDate = new Date(`${dateValue}T${h}:${m}:00`);
                const endDate = new Date(startDate);
                endDate.setMinutes(endDate.getMinutes() + 30);

                openReserve(
                    cell.dataset.roomId,
                    cell.dataset.roomName,
                    formatLocalDate(startDate),
                    formatLocalDate(endDate),
                    loggedUser.name,
                    loggedUser.email
                );
        }
    },true);


    });
  }
// Add this after attachSlotHandlers(); (around line 570)

/* ---------- Reserve Button Handler ---------- */
document.querySelectorAll('.reserve-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {

        e.preventDefault();
        e.stopPropagation();

        const roomId = btn.dataset.roomId;
        const roomName = btn.dataset.roomName;

        // Get the selected date from the date picker
        const dateValue = viewDate?.value || '{{ selected_date.strftime("%Y-%m-%d") if selected_date else "" }}';

        // Set default time to next available hour (or current time + 1 hour)
        const now = new Date();
        const selectedDate = new Date(dateValue);

        let startDate;
        if (selectedDate.toDateString() === now.toDateString()) {
            // If today, start from next hour
            startDate = new Date(now);
            startDate.setHours(now.getHours() + 1, 0, 0, 0);
        } else {
            // If future date, start from 8:00 AM
            startDate = new Date(`${dateValue}T08:00:00`);
        }

        const endDate = new Date(startDate);
        endDate.setMinutes(endDate.getMinutes() + 30); // Default 30-minute duration

        // Open the reservation modal
        openReserve(
            roomId,
            roomName,
            formatLocalDate(startDate),
            formatLocalDate(endDate)
        );
    });
});
 /* ========================= UPDATED showSlotDetails with Modern UI ========================= */
async function showSlotDetails(cell) {
   const roomId = cell.dataset.roomId;
   const roomName = cell.dataset.roomName;
   const date = document.getElementById("viewDate")?.value;
   const time = cell.dataset.time;
<!--   alert(date)-->
<!--   alert(roomId)-->
   try {
       const resp = await fetch(`/api/room_availability/${roomId}?date=${date}`);
       const data = await resp.json();

       // robust time parsing
       function toMinutes(t){
           if (!t) return null;
           if (t.includes('T')) t = t.split('T')[1];
           const [hh,mm] = t.split(':');
           return (parseInt(hh)||0)*60 + (parseInt(mm)||0);
       }

       const clickedMin = toMinutes(time);
       let match = null;

       for (const r of (data || [])) {
           const sm = toMinutes(r.start);
           const em = toMinutes(r.end);
           if (sm != null && em != null && clickedMin >= sm && clickedMin < em) {
               match = r;
               break;
           }
       }

       if (!match) {
           Swal.fire({
               icon: "info",
               title: "No Reservation Found",
               text: `No reservation record for ${time}.`,
               confirmButtonColor: "#0047AB"
           });
           return;
       }

       const reservedBy = (match.reserved_by || "").trim();
       const email = match.email || "N/A";
       const remarks = match.remarks || "â€”";
       const status = (match.status || "").toLowerCase();
       const start = match.start;
       const end = match.end;
       const resId = match.id;
       const currentUser = "{{ current_user.display_name }}".trim();
       const isAdmin = "{{ 'true' if current_user.is_admin() else 'false' }}" === "true";

       // Status badge styling
       let statusColor, statusBg, statusIcon;
       switch(status) {
           case 'approved':
           case 'booked':
               statusColor = '#0b8a44';
               statusBg = '#d4edda';
               statusIcon = 'âœ“';
               break;
           case 'pending':
               statusColor = '#856404';
               statusBg = '#fff3cd';
               statusIcon = 'â±';
               break;
           case 'blocked':
               statusColor = '#721c24';
               statusBg = '#f8d7da';
               statusIcon = 'âœ•';
               break;
           default:
               statusColor = '#6c757d';
               statusBg = '#e9ecef';
               statusIcon = 'â€¢';
       }

       let html = `
        <style>
            .reservation-details-container {
                text-align: left;
                padding: 8px 0;
            }
            .detail-row {
                display: flex;
                padding: 14px 0;
                border-bottom: 1px solid #f0f0f0;
                align-items: flex-start;
            }
            .detail-row:last-child {
                border-bottom: none;
            }
            .detail-label {
                font-weight: 600;
                color: #495057;
                min-width: 130px;
                font-size: 0.95rem;
            }
            .detail-value {
                color: #212529;
                flex: 1;
                font-size: 0.95rem;
                word-break: break-word;
            }
            .status-badge-modern {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 14px;
                border-radius: 20px;
                font-weight: 600;
                font-size: 0.85rem;
                background-color: ${statusBg};
                color: ${statusColor};
                border: 1px solid ${statusColor}40;
            }
            .room-name-display {
                font-size: 1.1rem;
                font-weight: 700;
                color: #0047AB;
                margin-bottom: 4px;
            }
            .time-display {
                font-family: 'Courier New', monospace;
                font-weight: 600;
                color: #0047AB;
                font-size: 1rem;
            }
            .action-buttons {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-top: 24px;
                padding-top: 20px;
                border-top: 2px solid #f0f0f0;
            }
            .btn-modern {
                padding: 10px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 6px;
            }
            .btn-approve {
                background: linear-gradient(135deg, #0b8a44 0%, #0a7538 100%);
                color: white;
                box-shadow: 0 2px 8px rgba(11, 138, 68, 0.3);
            }
            .btn-approve:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(11, 138, 68, 0.4);
            }
            .btn-reject {
                background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
                color: #000;
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
            }
            .btn-reject:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
            }
            .btn-cancel {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            }
            .btn-cancel:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
        </style>
        <div class="reservation-details-container">
            <div class="detail-row">
                <div class="detail-label">Room:</div>
                <div class="detail-value">
                    <div class="room-name-display">${roomName}</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <div class="detail-value">
                    <span class="status-badge-modern">
                        <span>${statusIcon}</span>
                        <span>${status.toUpperCase()}</span>
                    </span>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Reserved By:</div>
                <div class="detail-value">${reservedBy}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Email:</div>
                <div class="detail-value">${email}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Time:</div>
                <div class="detail-value">
                    <div class="time-display">${start} â€“ ${end}</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Meeting Title:</div>
                <div class="detail-value">${remarks}</div>
            </div>
        </div>
       `;

       // BUTTONS - Fixed authorization logic
       let buttonsHTML = "";

       // Check if user can manage this reservation (case-insensitive comparison)
       const canManage = isAdmin || currentUser.toLowerCase() === reservedBy.toLowerCase();

       if (['approved', 'pending', 'booked'].includes(status) && canManage) {
           buttonsHTML = `<div class="action-buttons">`;

           // Show Approve/Reject buttons only for pending reservations and only for admins
           if (status === 'pending' && isAdmin) {
               buttonsHTML += `
               <button id='approveResv' class='btn-modern btn-approve'>
                   <span>âœ“</span> Approve
               </button>
               <button id='rejectResv' class='btn-modern btn-reject'>
                   <span>âœ•</span> Reject
               </button>`;
           }

           // Show Cancel button for approved/booked/pending if user has permission
           buttonsHTML += `
           <button id='cancelResv' class='btn-modern btn-cancel'>
               <span>ðŸ—‘</span> Cancel Reservation
           </button>`;

           buttonsHTML += `</div>`;
       }

       html += buttonsHTML;

       Swal.fire({
           title: `<div style="color: #0047AB; font-size: 1.5rem; font-weight: 700;">
                       <i class="bi bi-calendar-check" style="margin-right: 8px;"></i>
                       Reservation Details
                   </div>`,
           html,
           width: 600,
           showConfirmButton: false,
           showCloseButton: true,
           padding: '2rem',
           customClass: {
               popup: 'reservation-details-popup',
               closeButton: 'reservation-close-btn'
           },
           didRender: () => {
               // CANCEL BUTTON
               const cancelBtn = document.getElementById("cancelResv");
               if (cancelBtn) {
                   cancelBtn.addEventListener("click", async () => {
                       const confirmResult = await Swal.fire({
                           title: 'Cancel Reservation?',
                           html: `<p style="font-size: 1rem; color: #495057;">Are you sure you want to cancel this reservation?</p>
                                  <p style="font-size: 0.9rem; color: #6c757d; margin-top: 12px;">
                                      <strong>${roomName}</strong><br>
                                      ${start} â€“ ${end}
                                  </p>`,
                           icon: 'warning',
                           showCancelButton: true,
                           confirmButtonColor: '#dc3545',
                           cancelButtonColor: '#6c757d',
                           confirmButtonText: '<i class="bi bi-check-lg"></i> Yes, cancel it',
                           cancelButtonText: '<i class="bi bi-x-lg"></i> No, keep it',
                           reverseButtons: true,
                           padding: '2rem'
                       });

                       if (confirmResult.isConfirmed) {
                           try {
                               const r = await fetch(`/api/cancel_reservation/${resId}`, {
                                   method: "POST",
                                   headers: {
                                       'Content-Type': 'application/json'
                                   }
                               });
                               const d = await r.json();

                               if (d.success) {
                                   Swal.fire({
                                       icon: "success",
                                       title: "Cancelled Successfully",
                                       text: d.message,
                                       confirmButtonColor: "#0047AB"
                                   }).then(() => location.reload());
                               } else {
                                   Swal.fire({
                                       icon: "error",
                                       title: "Cancellation Failed",
                                       text: d.message || "Unable to cancel reservation",
                                       confirmButtonColor: "#0047AB"
                                   });
                               }
                           } catch (err) {
                               console.error('Cancel error:', err);
                               Swal.fire({
                                   icon: "error",
                                   title: "System Error",
                                   text: "Failed to cancel reservation. Please try again.",
                                   confirmButtonColor: "#0047AB"
                               });
                           }
                       }
                   });
               }

               // APPROVE BUTTON
               const approveBtn = document.getElementById("approveResv");
               if (approveBtn) {
                   approveBtn.addEventListener("click", async () => {
                       try {
                           const r = await fetch(`/approvals/${resId}/approve`, {
                               method: "POST",
                               headers: {
                                   'Content-Type': 'application/json'
                               }
                           });

                           if (r.ok) {
                               Swal.fire({
                                   icon: "success",
                                   title: "Approved!",
                                   text: "Reservation has been approved successfully.",
                                   confirmButtonColor: "#0047AB"
                               }).then(() => location.reload());
                           } else {
                               const errData = await r.json();
                               Swal.fire({
                                   icon: "error",
                                   title: "Approval Failed",
                                   text: errData.message || "Unable to approve reservation",
                                   confirmButtonColor: "#0047AB"
                               });
                           }
                       } catch (err) {
                           console.error('Approve error:', err);
                           Swal.fire({
                               icon: "error",
                               title: "System Error",
                               text: "Failed to approve reservation.",
                               confirmButtonColor: "#0047AB"
                           });
                       }
                   });
               }

               // REJECT BUTTON
               const rejectBtn = document.getElementById("rejectResv");
               if (rejectBtn) {
                   rejectBtn.addEventListener("click", async () => {
                       const confirmResult = await Swal.fire({
                           title: 'Reject Reservation?',
                           text: 'This will deny the reservation request.',
                           icon: 'warning',
                           showCancelButton: true,
                           confirmButtonColor: '#ffc107',
                           cancelButtonColor: '#6c757d',
                           confirmButtonText: 'Yes, reject it',
                           cancelButtonText: 'Cancel'
                       });

                       if (confirmResult.isConfirmed) {
                           try {
                               const r = await fetch(`/approvals/${resId}/deny`, {
                                   method: "POST",
                                   headers: {
                                       'Content-Type': 'application/json'
                                   }
                               });

                               if (r.ok) {
                                   Swal.fire({
                                       icon: "success",
                                       title: "Rejected",
                                       text: "Reservation has been rejected.",
                                       confirmButtonColor: "#0047AB"
                                   }).then(() => location.reload());
                               } else {
                                   const errData = await r.json();
                                   Swal.fire({
                                       icon: "error",
                                       title: "Rejection Failed",
                                       text: errData.message || "Unable to reject reservation",
                                       confirmButtonColor: "#0047AB"
                                   });
                               }
                           } catch (err) {
                               console.error('Reject error:', err);
                               Swal.fire({
                                   icon: "error",
                                   title: "System Error",
                                   text: "Failed to reject reservation.",
                                   confirmButtonColor: "#0047AB"
                               });
                           }
                       }
                   });
               }
           }
       });
   } catch (err) {
       console.error(err);
       Swal.fire({
           icon: "error",
           title: "Error",
           text: "Failed to load reservation details.",
           confirmButtonColor: "#0047AB"
       });
   }
}
/* ========================= END showSlotDetails ========================= */
  /* approval helper */
  async function handleApproval(resId, action){
    try {
      const resp = await fetch(`/approvals/${resId}/${action}`, { method: 'POST' });
      if (resp.ok || resp.redirected) {
        Swal.fire({ icon:'success', title: `Reservation ${action==='approve'?'Approved':'Rejected'}`, confirmButtonColor: "#0047AB" })
          .then(()=> window.location.reload());
      } else {
        Swal.fire({ icon:'error', title: 'Action Failed', text: 'Please try again.' });
      }
    } catch (err) {
      console.error('Approval error', err);
      Swal.fire({ icon:'error', title: 'System Error' });
    }
  }

  /* open reserve modal helper */
  function openReserve(roomId, roomName, startTime, endTime,){
    document.getElementById('modalRoomId').value = roomId;
    document.getElementById('modalRoomName').textContent = roomName;
    document.getElementById('modalStartTime').value = startTime;
    document.getElementById('modalEndTime').value = endTime;
    document.getElementById('modalReservedBy').value = loggedUser.name;
    document.getElementById('modalEmail').value = loggedUser.email;
    document.getElementById('modalReservedBy').disabled = true;
    document.getElementById('modalEmail').disabled = true;
    document.getElementById('modalEmail').disabled = true;
    form.action = `/reserve_post/${roomId}`;
    bsModal.show();
  }

  /* submit reservation (recurrence aware) */
  form.addEventListener('submit', async (e) => {

    e.preventDefault();
    if (submitting) return;
    const start = document.getElementById('modalStartTime').value;
    const end = document.getElementById('modalEndTime').value;
    if (!start || !end) {
      Swal.fire('Invalid','Start and end time required.','error');
      return;
    }

    // weekly mismatch check (same logic used in calendar)
    if (recType?.value === 'weekly') {
      const weekdays = [];
      document.querySelectorAll('.wkday').forEach(cb => { if (cb.checked) weekdays.push(cb.value); });
      const startDate = new Date(start);
      const wk = getJsWeekday(startDate);
      if (weekdays.length > 0 && !weekdays.includes(wk)) {
        // compute next match and prompt (same UX)
        let nextMatch = new Date(startDate);
        for (let i=1;i<=14;i++){
          let d = new Date(startDate);
          d.setDate(d.getDate()+i);
          if (weekdays.includes(getJsWeekday(d))){ nextMatch = d; break; }
        }
        const wrongDay = startDate.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        const nextLabel = nextMatch.toLocaleString();
        return Swal.fire({
          icon: "warning",
          title: "Start date mismatch",
          html: `Your start date is <b>${wrongDay}</b><br>Recurrence days: <b>${weekdays.join(", ")}</b><br><br>Next matching date:<br><b>${nextLabel}</b>`,
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: "Adjust automatically",
          denyButtonText: "I'll fix manually"
        }).then(result => {
          if (result.isConfirmed) {
            const duration = new Date(end) - new Date(start);
            const newStart = new Date(nextMatch);
            const newEnd = new Date(newStart.getTime() + duration);
            document.getElementById('modalStartTime').value = newStart.toISOString().slice(0,16);
            document.getElementById('modalEndTime').value = newEnd.toISOString().slice(0,16);
            // fall through to submit
          }
        });
      }
    }

    // submit payload
    submitting = true;
    const payload = Object.fromEntries(new FormData(form));
    const weekdaysArr = [];
    document.querySelectorAll('.wkday').forEach(cb => { if (cb.checked) weekdaysArr.push(cb.value); });
    payload.weekdays = weekdaysArr.join(',');
    try {
      const roomId = payload.room_id || document.getElementById('modalRoomId').value;
      const resp = await fetch(`/reserve_post/${roomId}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (data.success) {
        const created = data.created_count || 0;
        let html = `<b>${created}</b> reservations created.`;
        if (data.skipped && data.skipped.length) {
          html += `<br><b>${data.skipped.length}</b> skipped:<ul>`;
          data.skipped.forEach(s => html += `<li>${s}</li>`);
          html += `</ul>`;
        }
        Swal.fire({ icon: 'success', title: 'Reservation Submitted', html, confirmButtonColor: "#0047AB" })
          .then(() => window.location.reload());
      } else {
        Swal.fire({ icon: 'error', title: 'Reservation Failed', text: data.message || 'Unknown error', confirmButtonColor: "#0047AB" });
      }
    } catch (err) {
      console.error('Reservation submit error', err);
      Swal.fire({ icon:'error', title: 'System Error', text: 'There was a problem submitting your reservation. Please try again.' });
    } finally {
      submitting = false;
    }
  });

  // initial attach + UI restore
  updatePastSlots();
  autoScrollToCurrentSlot();
  attachSlotHandlers();

  // refresh handler (preserve selected date & location)
  document.getElementById('refreshButton').addEventListener('click', () => {
    const selected = document.getElementById('viewDate').value || '';
    const loc = document.getElementById('locationFilter')?.value || 'all';
    window.location.href = `/rooms?date=${selected}&location=${loc}`;
  });

  // calendar goto
  const goToCalendar = () => {
    const d = document.getElementById('viewDate').value || '';
    const loc = document.getElementById('locationFilter')?.value || 'all';
    window.location.href = `/calendar_view?date=${d}&location=${loc}`;
  };
  const topBtn = document.getElementById('calendarSyncBtn');
  if (topBtn) topBtn.addEventListener('click', goToCalendar);
  const sidebarBtn = document.getElementById('sidebarCalendarBtn');
  if (sidebarBtn) sidebarBtn.addEventListener('click', (e)=>{ e.preventDefault(); goToCalendar(); });

  // room header click focuses room and scrolls into view
  document.querySelectorAll('.room-clickable').forEach(h => {
    h.addEventListener('click', (e) => {
      const id = e.target.dataset.roomId;
      const el = document.querySelector(`.room-row[data-room-id='${id}']`);
      if (el) el.scrollIntoView({ behavior:'smooth', block:'center' });
    });
  });

  // Disable location filter if server requests that (non-admin UX)
  (function maybeDisableLocationFilter(){
    const canSwitch = {{ 'true' if current_user.is_admin() else 'false' }};
    if (!canSwitch && document.getElementById('locationFilter')) {
      document.getElementById('locationFilter').disabled = true;
    }
  })();

});

    document.addEventListener("DOMContentLoaded", function() {
    const selectedRoom = "{{ selected_room }}";
    if (selectedRoom !== "all") {
        const card = document.querySelector(`[data-room-name="${selectedRoom}"]`);
        if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.style.boxShadow = "0 0 12px rgba(0, 123, 255, 0.9)";
        }
    }
});

    document.addEventListener("DOMContentLoaded", () => {

    const panel = document.getElementById("mobileFilterPanel");
    const overlay = document.getElementById("mobileFilterOverlay");
    const openBtn = document.getElementById("mobileFiltersBtn");
    const closeBtn = document.getElementById("closeMobileFilter");

    // open panel
    openBtn.addEventListener("click", () => {
        panel.classList.add("open");
        overlay.classList.add("active");
    });

    // close panel
    closeBtn.addEventListener("click", () => {
        panel.classList.remove("open");
        overlay.classList.remove("active");
    });

    overlay.addEventListener("click", () => {
        panel.classList.remove("open");
        overlay.classList.remove("active");
    });

    // Sync filters
    //const desktopLoc = document.getElementById("locationFilter");
    //const mobileLoc = document.getElementById("mobileLocationFilter");

    const desktopLoc = document.querySelector('.filter-panel select:first-of-type'); // Location filter
    const mobileLoc = document.getElementById("mobileLocationFilter");
    const desktopRoom = document.querySelector('.filter-panel select:last-of-type'); // Room filter
    const mobileRoom = document.getElementById("roomFilter");

    // Sync on open
    //openBtn.addEventListener("click", () => {
    //    mobileLoc.value = desktopLoc.value;
    //});

    // Sync on open
    openBtn.addEventListener("click", () => {
        if (desktopLoc) mobileLoc.value = desktopLoc.value;
        if (desktopRoom) mobileRoom.value = desktopRoom.value;
    });

    // Sync location back on change
    mobileLoc.addEventListener("change", () => {
        const loc = mobileLoc.value;
        const date = document.getElementById('viewDate').value;
        const room = mobileRoom.value;
        window.location.href = `?location=${loc}&room=${room}&date=${date}`;
    });
    // Sync back on change
    //mobileLoc.addEventListener("change", () => {
    //    desktopLoc.value = mobileLoc.value;
    //    desktopLoc.dispatchEvent(new Event("change"));
    //});


    // Date sync
    const deskDate = document.getElementById("viewDate");
    const mobDate = document.getElementById("mobileDate");

    mobDate.addEventListener("change", () => {
        deskDate.value = mobDate.value;
        deskDate.dispatchEvent(new Event("change"));
    });

    // Refresh
    //document.getElementById("mobileRefresh").addEventListener("click", () => {
    //    document.getElementById("refreshBtn").click();
    //});

    // NEW (CORRECT):
document.getElementById("mobileRefresh").addEventListener("click", () => {
    document.getElementById("refreshButton").click();
});

    // Calendar jump
    document.getElementById("mobileCalendar").addEventListener("click", () => {
        document.getElementById("calendarSyncBtn").click();
    });

});

    // ===============================
// MOBILE SWIPE GESTURE FOR FILTER PANEL
// ===============================
document.addEventListener("DOMContentLoaded", () => {

    const panel = document.getElementById("mobileFilterPanel");
    const overlay = document.getElementById("mobileFilterOverlay");

    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;

    function openPanel() {
        panel.classList.add("open");
        overlay.classList.add("active");
    }

    function closePanel() {
        panel.classList.remove("open");
        overlay.classList.remove("active");
    }

    // detect device width
    function isMobile() {
        return window.innerWidth <= 992;
    }

    // START touch
    document.addEventListener("touchstart", (e) => {
        if (!isMobile()) return;

        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });

    // END touch
    document.addEventListener("touchend", (e) => {
        if (!isMobile()) return;

        touchEndX = e.changedTouches[0].screenX;
        const diffX = touchEndX - touchStartX;
        const diffY = Math.abs(e.changedTouches[0].screenY - touchStartY);

        // ignore vertical scroll
        if (diffY > 50) return;

        // SWIPE RIGHT â†’ OPEN PANEL
        if (diffX > 80 && touchStartX < 40 && !panel.classList.contains("open")) {
            openPanel();
        }

        // SWIPE LEFT â†’ CLOSE PANEL
        if (diffX < -80 && panel.classList.contains("open")) {
            closePanel();
        }

    }, { passive: true });

});



/* =====================================================
   MOBILE-DESKTOP FILTER SYNC - NEW CODE
   ===================================================== */

document.addEventListener("DOMContentLoaded", () => {

    // ==========================================
    // GET ALL FILTER ELEMENTS
    // ==========================================
    const panel = document.getElementById("mobileFilterPanel");
    const overlay = document.getElementById("mobileFilterOverlay");
    const openBtn = document.getElementById("mobileFiltersBtn");
    const closeBtn = document.getElementById("closeMobileFilter");

    // Desktop filters
    const desktopLocationFilter = document.getElementById("locationFilter");
    const desktopRoomFilter = document.getElementById("roomFilterDesktop");

    // Mobile filters
    const mobileLocationFilter = document.getElementById("mobileLocationFilter");
    const mobileRoomFilter = document.getElementById("mobileRoomFilter");
    const mobileDate = document.getElementById("mobileDate");
    const viewDate = document.getElementById("viewDate");

    // Buttons
    const applyDesktopBtn = document.getElementById("applyDesktopFilters");
    const applyMobileBtn = document.getElementById("applyMobileFilters");
    const mobileRefreshBtn = document.getElementById("mobileRefresh");
    const mobileCalendarBtn = document.getElementById("mobileCalendar");
    const desktopRefreshBtn = document.getElementById("refreshButton");
    const desktopCalendarBtn = document.getElementById("calendarSyncBtn");

    // ==========================================
    // FUNCTION: RELOAD WITH FILTERS
    // ==========================================
    function reloadWithFilters(source = 'desktop') {
        const location = (source === 'desktop')
            ? (desktopLocationFilter?.value || 'all')
            : (mobileLocationFilter?.value || 'all');

        const room = (source === 'desktop')
            ? (desktopRoomFilter?.value || 'all')
            : (mobileRoomFilter?.value || 'all');

        const date = viewDate?.value || '';

        // Save to localStorage
        localStorage.setItem('roomFilter_location', location);
        localStorage.setItem('roomFilter_room', room);
        localStorage.setItem('selectedDate', date);

        // Reload page with filter params
        window.location.href = `?location=${location}&room=${room}&date=${date}`;
    }

    // ==========================================
    // OPEN MOBILE PANEL & SYNC VALUES
    // ==========================================
    if (openBtn) {
        openBtn.addEventListener("click", () => {
            // Sync current desktop values to mobile
            if (desktopLocationFilter && mobileLocationFilter) {
                mobileLocationFilter.value = desktopLocationFilter.value;
            }
            if (desktopRoomFilter && mobileRoomFilter) {
                mobileRoomFilter.value = desktopRoomFilter.value;
            }
            if (viewDate && mobileDate) {
                mobileDate.value = viewDate.value;
            }

            // Open panel
            panel.classList.add("open");
            overlay.classList.add("active");
        });
    }

    // ==========================================
    // CLOSE MOBILE PANEL
    // ==========================================
    if (closeBtn) {
        closeBtn.addEventListener("click", () => {
            panel.classList.remove("open");
            overlay.classList.remove("active");
        });
    }

    if (overlay) {
        overlay.addEventListener("click", () => {
            panel.classList.remove("open");
            overlay.classList.remove("active");
        });
    }

    // ==========================================
    // APPLY FILTERS BUTTONS
    // ==========================================
    if (applyDesktopBtn) {
        applyDesktopBtn.addEventListener("click", () => {
            reloadWithFilters('desktop');
        });
    }

    if (applyMobileBtn) {
        applyMobileBtn.addEventListener("click", () => {
            reloadWithFilters('mobile');
        });
    }

    // ==========================================
    // MOBILE DATE CHANGE
    // ==========================================
    if (mobileDate) {
        mobileDate.addEventListener("change", () => {
            if (viewDate) {
                viewDate.value = mobileDate.value;
            }
        });
    }

    // ==========================================
    // REFRESH BUTTONS
    // ==========================================
    if (mobileRefreshBtn && desktopRefreshBtn) {
        mobileRefreshBtn.addEventListener("click", () => {
            desktopRefreshBtn.click();
        });
    }

    // ==========================================
    // CALENDAR VIEW BUTTONS
    // ==========================================
    if (mobileCalendarBtn && desktopCalendarBtn) {
        mobileCalendarBtn.addEventListener("click", () => {
            desktopCalendarBtn.click();
        });
    }

    // ==========================================
    // SWIPE GESTURES (MOBILE)
    // ==========================================
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;

    function isMobile() {
        return window.innerWidth < 992;
    }

    function openPanel() {
        // Sync values
        if (desktopLocationFilter && mobileLocationFilter) {
            mobileLocationFilter.value = desktopLocationFilter.value;
        }
        if (desktopRoomFilter && mobileRoomFilter) {
            mobileRoomFilter.value = desktopRoomFilter.value;
        }
        if (viewDate && mobileDate) {
            mobileDate.value = viewDate.value;
        }

        panel.classList.add("open");
        overlay.classList.add("active");
    }

    function closePanel() {
        panel.classList.remove("open");
        overlay.classList.remove("active");
    }

    // Touch start
    document.addEventListener("touchstart", (e) => {
        if (!isMobile()) return;
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });

    // Touch end
    document.addEventListener("touchend", (e) => {
        if (!isMobile()) return;

        touchEndX = e.changedTouches[0].screenX;
        const diffX = touchEndX - touchStartX;
        const diffY = Math.abs(e.changedTouches[0].screenY - touchStartY);

        // Ignore vertical scroll
        if (diffY > 50) return;

        // SWIPE LEFT from right edge â†’ OPEN PANEL
        if (diffX < -80 && touchStartX > window.innerWidth - 40 && !panel.classList.contains("open")) {
            openPanel();
        }

        // SWIPE RIGHT â†’ CLOSE PANEL
        if (diffX > 80 && panel.classList.contains("open")) {
            closePanel();
        }

    }, { passive: true });

    console.log('âœ… Mobile-Desktop filter sync initialized');
});


</script>

<style>
/* ========================================
   ROOM LIST PAGE - COMPLETE STYLES
   ======================================== */

/* Page Title - Match menu.html */
.page-title {
  font-size: clamp(1.1rem, 3.5vw, 1.75rem);
  line-height: 1.3;
}

.title-text {
  word-break: break-word;
}

/* Sticky Sidebar (Desktop) */
.sticky-sidebar {
  position: sticky;
  top: 80px;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
}

/* Room Cards */
.room-header {
  transition: all 0.2s ease;
  cursor: pointer;
}

.room-header:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.room-clickable {
  cursor: pointer;
  transition: color 0.2s ease;
}

.room-clickable:hover {
  color: #0047AB;
}

.border-focus {
  border: 2px solid #0047AB !important;
  box-shadow: 0 0 12px rgba(0, 71, 171, 0.3);
}

/* Timeline Styles */
.timeline {
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  user-select: none;
  background: #f9f9fb;
}

.slot-grid {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  min-height: 80px;
}

.slot-cell {
  min-width: 72px;
  width: 72px;
  height: 60px;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  padding: 7px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #f0f0f0;
  transition: all 0.15s ease;
  cursor: pointer;
  border: 2px solid transparent;
}

.slot-cell:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.slot-time {
  font-size: 0.85rem;
  font-weight: 700;
  line-height: 1;
}

.slot-duration {
  font-size: 0.68rem;
  color: #6c757d;
  margin-top: 2px;
}

/* Slot Colors */
.slot-cell.bg-success {
  background: #0b8a44 !important;
  color: white !important;
}

.slot-cell.bg-danger {
  background: #d23a3a !important;
  color: white !important;
}

.slot-cell.bg-warning {
  background: #ffc107 !important;
  color: #222 !important;
}

.slot-cell.bg-secondary {
  background: #9fa6ad !important;
  color: white !important;
  opacity: 0.85;
}

.slot-cell.selected {
  border: 2px solid #0047AB !important;
  background: #d7e9ff !important;
  color: #0047AB;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0, 71, 171, 0.3);
}

.cancel-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  width: 18px;
  height: 18px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.2s ease;
  cursor: pointer;
  z-index: 10;
}

.cancel-btn:hover {
  transform: scale(1.15);
  background: #fff;
}

.cancel-btn i {
  font-size: 0.6rem;
  color: #c12;
}

/* ========================================
   MOBILE FILTER PANEL - SLIDES FROM RIGHT
   ======================================== */
.mobile-filter-panel {
  position: fixed;
  top: 0;
  right: -300px;
  width: 280px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15);
  z-index: 2110;
  padding: 0;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow-y: auto;
}

.mobile-filter-panel.open {
  right: 0;
}

.mobile-filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: linear-gradient(135deg, #0047AB 0%, #0056d2 100%);
  color: white;
  font-size: 1.05rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  position: sticky;
  top: 0;
  z-index: 10;
}

.mobile-filter-body {
  padding: 20px;
}

.mobile-filter-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  z-index: 2105;
}

.mobile-filter-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* ========================================
   RESPONSIVE BREAKPOINTS
   ======================================== */
@media (max-width: 991.98px) {
  .slot-cell {
    min-width: 60px;
    width: 60px;
    height: 52px;
    font-size: 0.75rem;
  }

  .slot-grid {
    gap: 0.4rem;
  }
}

@media (max-width: 575.98px) {
  .slot-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
    gap: 6px;
    width: 100%;
  }

  .slot-cell {
    min-width: 50px !important;
    width: 100% !important;
    height: 46px !important;
    padding: 4px !important;
    font-size: 0.7rem !important;
  }

  .slot-time {
    font-size: 0.75rem;
  }

  .slot-duration {
    font-size: 0.6rem;
  }

  .timeline {
    padding: 1rem !important;
  }

  .room-header .badge {
    display: none;
  }

  .page-title {
    font-size: 1.1rem;
  }
}

/* ========================================
   DARK MODE
   ======================================== */
body.dark-mode .card {
  background-color: #202020;
  color: #e2e2e2;
  border: 1px solid #333;
}

body.dark-mode .timeline {
  background: #181818;
}

body.dark-mode .slot-cell {
  background: #2a2a2a;
  color: #ddd;
}

body.dark-mode .mobile-filter-panel {
  background: #1a1a1a;
  color: #ddd;
}

body.dark-mode .mobile-filter-header {
  background: linear-gradient(135deg, #001f3f 0%, #002d6e 100%);
}

body.dark-mode .form-control,
body.dark-mode .form-select {
  background-color: #2a2a2a;
  border-color: #444;
  color: #ddd;
}

/* ========================================
   PRINT STYLES
   ======================================== */
@media print {
  .sticky-sidebar,
  .mobile-filter-panel,
  .mobile-filter-overlay,
  #mobileFiltersBtn,
  .btn {
    display: none !important;
  }

  .timeline {
    overflow: visible !important;
  }

  .slot-cell {
    break-inside: avoid;
  }
}

/* ======================================
  ðŸ”¥ COMPLETE DARK MODE FIX â€“ Reservation Modal
  ====================================== */
.dark-mode #newReservationModal .modal-content {
   background-color: #1e1e1e !important;
   color: #f1f1f1 !important;
}
/* Header */
.dark-mode #newReservationModal .modal-header {
   background-color: #242424 !important;
   border-bottom-color: #333 !important;
}
.dark-mode #newReservationModal .modal-title {
   color: #ffffff !important;
}
/* Labels */
.dark-mode #newReservationModal .form-label,
.dark-mode #newReservationModal label,
.dark-mode #newReservationModal .form-check-label {
   color: #e5e5e5 !important;
}
/* Section Titles (Schedule, Your Details, Repeat, Ends) */
.dark-mode #newReservationModal h6 {
   color: #66aaff !important;
}
/* Room Title */
.dark-mode #newReservationModal #modalRoomName {
   color: #ffffff !important;
}
/* Inputs / Selects */
.dark-mode #newReservationModal .form-control,
.dark-mode #newReservationModal .form-select {
   background-color: #2b2b2b !important;
   color: #ffffff !important;
   border-color: #555 !important;
}
.dark-mode #newReservationModal .form-control:disabled,
.dark-mode #newReservationModal .form-select:disabled {
   background-color: #3a3a3a !important;
   color: #aaaaaa !important;
}
/* Placeholder text */
.dark-mode #newReservationModal .form-control::placeholder {
   color: #bfbfbf !important;
}
/* Panels (Schedule, Your Details, Repeat) */
.dark-mode #newReservationModal .bg-light {
   background-color: #2a2a2a !important;
}
/* Checkboxes */
.dark-mode #newReservationModal .form-check-input {
   background-color: #444 !important;
   border-color: #777 !important;
}
.dark-mode #newReservationModal .form-check-input:checked {
   background-color: #0d6efd !important;
}
/* Footer */
.dark-mode #newReservationModal .modal-footer {
   border-top-color: #333 !important;
}
</style>
{% endblock %}